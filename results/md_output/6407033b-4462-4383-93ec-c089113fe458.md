Deep Clojure/Python Integration
Version Info
## New Versions Are HOT! Huge New Features! You Can’t Afford To Miss Out!
• API Documentation
• Java API ‑ you can use libpython‑clj from java ‑ no Clojure required. The class is included with
thejarsojustputthejarontheclasspathandthenimport libpython_clj2.java_api;
will work. Be sure to carefully read the namespace doc as, due to performance considerations,
not all methods are protected via automatic GIL management. Note this integration includes
supportforextremelyefficientdatacopiestonumpyobjectsandcallbacksfrompythontojava.
• make‑fastcallable so if you calling a small function repeatedly you can now call it about twice
as fast. A better optimization is to call a function once with numpy array arguments but unfor‑
tunately not all use cases are amenable to this pathway. So we did what we can.
• JDK‑17 and Mac M‑1 support. To use libpython‑clj2 with jdk‑17 you need to enable the foreign
module ‑ see deps.edn for a working alias.
• You can now Embed Clojure in Python ‑ you can launch a Clojure REPL from a Python host pro‑
cess.
• 32 bit support!!
• 20‑30% better performance.
• Please avoid deprecated versions such as [cnuernber/libpython-clj "1.36"] (note
name change).
• This library, which has received the efforts of many excellent people, is built mainly upon
cnuernber/dtype‑next and the JNA library.
• Staticcodegeneration‑generateclojurenamespaceswrappingpythonmodulesthataresafeto
usewithAOTandloadmuchfasterthananalogousrequire-pythoncalls. Thesenamespace
will not automatically initialize the python subsystem – initialize! must be called first (or a nice
exception is throw).
libpython‑clj features
• Bridge between JVM objects and Python objects easily; use Python in your Java and use some
Java in your Python.
• Python objects are linked to the JVM GC such that when they are no longer reachable from the
JVM their references are released. Scope based resource contexts are also available.
1

• Finding the python libraries is done dynamically allowing one system to run on multiple ver‑
sions of python.
• REPL oriented design means fast, smooth, iterative development.
• Carin Meier has written excellent posts on plotting and advanced text generation. She also has
some great examples.
Vision
WeaimtointegratePythonintoClojureatadeeplevel. Thismeansthatwewanttobeabletoload/use
pythonmodulesalmostasiftheywereClojurenamespaces. WealsowanttobeabletouseClojureto
extend Python objects. I gave a talk at Clojure Conj 2019 that outlines more of what is going on.
This code is a concrete example that generates an embedding for faces:
1 (ns facial-rec.face-feature
2 (:require [libpython-clj2.require :refer [require-python]]
3 [libpython-clj2.python :refer [py. py.. py.-] :as py]
4 [tech.v3.datatype :as dtype]))
5
6
7
8 (require-python 'mxnet
9 '(mxnet ndarray module io model))
10 (require-python 'cv2)
11 (require-python '[numpy :as np])
12
13
14 (defn load-model
15 [& {:keys [model-path checkpoint]
16 :or {model-path "models/recognition/model"
17 checkpoint 0}}]
18 (let [[sym arg-params aux-params] (mxnet.model/load_checkpoint model-
path checkpoint)
19 all-layers (py. sym get_internals)
20 target-layer (py/get-item all-layers "fc1_output")
21 model (mxnet.module/Module :symbol target-layer
22 :context (mxnet/cpu)
23 :label_names nil)]
24 (py. model bind :data_shapes [["data" [1 3 112 112]]])
25 (py. model set_params arg-params aux-params)
26 model))
27
28 (defonce model (load-model))
29
30
31 (defn face->feature
32 [img-path]
33 (py/with-gil-stack-rc-context
2

| 1 (ns facial-rec.face-feature                                            |
|:-------------------------------------------------------------------------|
| 2 (:require [libpython-clj2.require :refer [require-python]]             |
| 3 [libpython-clj2.python :refer [py. py.. py.-] :as py]                  |
| 4 [tech.v3.datatype :as dtype]))                                         |
| 5                                                                        |
| 6                                                                        |
| 7                                                                        |
| 8 (require-python 'mxnet                                                 |
| 9 '(mxnet ndarray module io model))                                      |
| 10 (require-python 'cv2)                                                 |
| 11 (require-python '[numpy :as np])                                      |
| 12                                                                       |
| 13                                                                       |
| 14 (defn load-model                                                      |
| 15 [& {:keys [model-path checkpoint]                                     |
| 16 :or {model-path "models/recognition/model"                            |
| 17 checkpoint 0}}]                                                       |
| 18 (let [[sym arg-params aux-params] (mxnet.model/load_checkpoint model- |
| path checkpoint)                                                         |
| 19 all-layers (py. sym get_internals)                                    |
| 20 target-layer (py/get-item all-layers "fc1_output")                    |
| 21 model (mxnet.module/Module :symbol target-layer                       |
| 22 :context (mxnet/cpu)                                                  |
| 23 :label_names nil)]                                                    |
| 24 (py. model bind :data_shapes [["data" [1 3 112 112]]])                |
| 25 (py. model set_params arg-params aux-params)                          |
| 26 model))                                                               |
| 27                                                                       |
| 28 (defonce model (load-model))                                          |
| 29                                                                       |
| 30                                                                       |
| 31 (defn face->feature                                                   |
| 32 [img-path]                                                            |
| 33 (py/with-gil-stack-rc-context                                         |

34 (if-let [new-img (cv2/imread img-path)]
35 (let [new-img (cv2/cvtColor new-img cv2/COLOR_BGR2RGB)
36 new-img (np/transpose new-img [2 0 1])
37 input-blob (np/expand_dims new-img :axis 0)
38 data (mxnet.ndarray/array input-blob)
39 batch (mxnet.io/DataBatch :data [data])]
40 (py. model forward batch :is_train false)
41 (-> (py. model get_outputs)
42 first
43 (py. asnumpy)
44 (#(dtype/make-container :java-array :float32 %))))
45 (throw (Exception. (format "Failed to load img: %s" img-path)))))
)
Usage
Config namespace
1 (ns my-py-clj.config
2 (:require [libpython-clj2.python :as py]))
3
4 ;; When you use conda, it should look like this.
5 (py/initialize! :python-executable "/opt/anaconda3/envs/my_env/bin/
python3.7"
6 :library-path "/opt/anaconda3/envs/my_env/lib/
libpython3.7m.dylib")
Update project.clj
1 {...
2 ;; This namespace going to run when the REPL is up.
3 :repl-options {:init-ns my-py-clj.config}
4 ...}
1 user> (require '[libpython-clj2.require :refer [require-python]])
2 ...logging info....
3 nil
4 user> (require-python '[numpy :as np])
5 nil
6 user> (def test-ary (np/array [[1 2][3 4]]))
7 #'user/test-ary
8 user> test-ary
9 [[1 2]
10 [3 4]]
We have a document on all the features but beginning usage is pretty simple. Import your modules,
use the things from Clojure. We have put effort into making sure things like sequences and ranges
transfer between the two languages.
3

| 34 (if-let [new-img (cv2/imread img-path)]                           |
|:---------------------------------------------------------------------|
| 35 (let [new-img (cv2/cvtColor new-img cv2/COLOR_BGR2RGB)            |
| 36 new-img (np/transpose new-img [2 0 1])                            |
| 37 input-blob (np/expand_dims new-img :axis 0)                       |
| 38 data (mxnet.ndarray/array input-blob)                             |
| 39 batch (mxnet.io/DataBatch :data [data])]                          |
| 40 (py. model forward batch :is_train false)                         |
| 41 (-> (py. model get_outputs)                                       |
| 42 first                                                             |
| 43 (py. asnumpy)                                                     |
| 44 (#(dtype/make-container :java-array :float32 %))))                |
| 45 (throw (Exception. (format "Failed to load img: %s" img-path))))) |
| )                                                                    |

| 1 (ns my-py-clj.config                                                |
|:----------------------------------------------------------------------|
| 2 (:require [libpython-clj2.python :as py]))                          |
| 3                                                                     |
| 4 ;; When you use conda, it should look like this.                    |
| 5 (py/initialize! :python-executable "/opt/anaconda3/envs/my_env/bin/ |
| python3.7"                                                            |
| 6 :library-path "/opt/anaconda3/envs/my_env/lib/                      |
| libpython3.7m.dylib")                                                 |

| 1 {...                                                |
|:------------------------------------------------------|
| 2 ;; This namespace going to run when the REPL is up. |
| 3 :repl-options {:init-ns my-py-clj.config}           |
| 4 ...}                                                |

| 1 user> (require '[libpython-clj2.require :refer [require-python]])   |
|:----------------------------------------------------------------------|
| 2 ...logging info....                                                 |
| 3 nil                                                                 |
| 4 user> (require-python '[numpy :as np])                              |
| 5 nil                                                                 |
| 6 user> (def test-ary (np/array [[1 2][3 4]]))                        |
| 7 #'user/test-ary                                                     |
| 8 user> test-ary                                                      |
| 9 [[1 2]                                                              |
| 10 [3 4]]                                                             |

Environments One very complimentary aspect of Python with respect to Clojure is its integration
withcuttingedgenativelibraries. Oursupportisn’tperfectsosomeunderstandingofthemechanism
is important to diagnose errors and issues.
Current,welaunchthepython3executableandprintoutvariousdifferentbitsofconfigurationasjson.
We parse the json and use the output to attempt to find the libpython3.Xm.so shared library so
forexampleifweareloadingpython3.6welookforlibpython3.6m.soonLinuxorlibpython3
.6m.dylib on the Mac.
If we are unable to find a dynamic library such as libpythonx.y.so or libpythonx.z.dylib,
itmaybebecausePythonisstaticallylinkedandthelibraryisnotpresentatall. Thisisdependenton
the operating system and installation, and it is not always possible to detect it. In this case, we will
receive an error message saying “Failed to find a valid python library!”. To fix this, you may need to
install additional OS packages or manually set the precise library location during py/initialize
!.
ThispathwayhasallowedussupportCondaalbeitwithsomework. ForexamplesusingConda,check
out the facial rec repository a)bove or look into how we build our test docker containers.
Community
We like to talk about libpython‑clj on Zulip as the conversations are persistent and searchable.
Further Information
• Clojure Conj 2019 video and slides.
• development discussion forum
• design documentation
• scope and garbage collection docs
• examples
• docker setup
• pandas bindings (!!)
• nextjournal notebooks
• scicloj video
• Clojure/Python interop technical blog post
• persistent datastructures in python
4

New To Clojure
New to Clojure or the JVM? Try remixing the nextjournal entry and playing around there. For more re‑
sourcesonlearningandgettingmorecomfortablewithClojure,wehaveanintroductorydocument.
Resources
• libpython C api
• create numpy from C ptr
• create C ptr from numpy
To install jar to local .m2 :
1 $ lein install
Deploy to clojars
1 $ lein deploy clojars
This command will sign jar before deploy, using your gpg key. (see dev/src/build.clj for signing op‑
tions)
License
Copyright © 2019 Chris Nuernberger
ThisprogramandtheaccompanyingmaterialsaremadeavailableunderthetermsoftheEclipsePub‑
lic License 2.0 which is available at http://www.eclipse.org/legal/epl‑2.0.
5