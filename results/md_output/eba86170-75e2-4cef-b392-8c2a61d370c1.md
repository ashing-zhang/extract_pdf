Inference under Covariate-Adaptive Randomization
∗
with Multiple Treatments
Federico A. Bugni Ivan A. Canay
9102 naJ 71  ]ME.noce[  3v60240.6081:viXra
Department of Economics Department of Economics
Duke University Northwestern University
federico.bugni@duke.edu iacanay@northwestern.edu
Azeem M. Shaikh
Department of Economics
University of Chicago
amshaikh@uchicago.edu
January 21, 2019
∗We would like to thank Lori Beaman, Joseph Romano, Andres Santos, and seminar participants at various institutions for
helpful comments on this paper. Yuehao Bai, Jackson Bunting, Mengsi Gao, Max Tabord-Meehan, Vishal Kamat, and Winnie
van Dijk provided excellent research assistance. The research of the first author was supported by National Institutes of Health
Grant 40-4153-00-0-85-399 and the National Science Foundation Grant SES-1729280. The research of the second author was
supported by National Science Foundation Grant SES-1530534. The research of the third author was supported by National
Science Foundation Grants SES-1308260, SES-1227091, and SES-1530661.

Abstract
This paper studies inference in randomized controlled trials with covariate-adaptive randomization
when there are multiple treatments. More specifically, we study in this setting inference about the
average effect of one or more treatments relative to other treatments or a control. As in Bugni et al.
(2018), covariate-adaptive randomization refers to randomization schemes that first stratify according
to baseline covariates and then assign treatment status so as to achieve “balance” within each stratum.
Importantly, in contrast to Bugni et al. (2018), we not only allow for multiple treatments, but further
allow for the proportion of units being assigned to each of the treatments to vary across strata. We
first study the properties of estimators derived from a “fully saturated” linear regression, i.e., a linear
regression of the outcome on all interactions between indicators for each of the treatments and indicators
for each of the strata. We show that tests based on these estimators using the usual heteroskedasticity-
consistent estimator of the asymptotic variance are invalid in the sense that they may have limiting
rejection probability under the null hypothesis strictly greater than the nominal level; on the other hand,
tests based on these estimators and suitable estimators of the asymptotic variance that we provide are
exact in the sense that they have limiting rejection probability under the null hypothesis equal to the
nominal level. For the special case in which the target proportion of units being assigned to each of the
treatments does not vary across strata, we additionally consider tests based on estimators derived from a
linear regression with “strata fixed effects,” i.e., a linear regression of the outcome on indicators for each
of the treatments and indicators for each of the strata. We show that tests based on these estimators
using the usual heteroskedasticity-consistent estimator of the asymptotic variance are conservative in the
sense that they have limiting rejection probability under the null hypothesis no greater than and typically
strictly less than the nominal level, but tests based on these estimators and suitable estimators of the
asymptotic variance that we provide are exact, thereby generalizing results in Bugni et al. (2018) for
the case of a single treatment to multiple treatments. A simulation study and an empirical application
illustrate the practical relevance of our theoretical results.
KEYWORDS: Covariate-adaptive randomization, multiple treatments, stratified block randomization, Efron’s
biased-coin design, treatment assignment, randomized controlled trial, strata fixed effects, saturated regres-
sion
JEL classification codes: C12, C14

1 Introduction
This paper studies inference in randomized controlled trials with covariate-adaptive randomization when
there are multiple treatments. As in Bugni et al. (2018), covariate-adaptive randomization refers to random-
ization schemes that first stratify according to baseline covariates and then assign treatment status so as to
achieve “balance” within each stratum. Many such methods are used routinely when assigning treatment
status in randomized controlled trials in all parts of the sciences. See, for example, Rosenberger and Lachin
(2016) for a textbook treatment focused on clinical trials and Duflo et al. (2007) and Bruhn and McKenzie
(2009) for reviews focused on development economics. Importantly, in contrast to Bugni et al. (2018), we not
only allow for multiple treatments, but further allow the target proportion of units being assigned to each of
the treatments to vary across strata. In this paper, we take as given the use of such a treatment assignment
mechanism and study its consequences for inference about the average effect of one or more treatments
relative to other treatments or a control. Our main requirement is that the randomization scheme is such
that the fraction of units being assigned to each treatment within each stratum is suitably well behaved
in a sense made precise by our assumptions below as the sample size n tends to infinity. See, in particu-
lar, Assumptions 2.2.(b) and 4.1.(c). Importantly, these requirements are satisfied by most commonly used
treatment assignment mechanisms, including simple random sampling and stratified block randomization.
The latter treatment assignment scheme is especially noteworthy because of its widespread use recently in
development economics. See, for example, Dizon-Ross (2018, footnote 13), Duflo et al. (2015, footnote 6),
Callen et al. (2019, page 24), and Berry et al. (2018, page 6).
We first study the properties of ordinary least squares estimation of a “fully saturated” linear regression,
i.e., a linear regression of the outcome on all interactions between indicators for each of the treatments
and indicators for each of the strata. We emphasize that tests based on these estimators were not con-
sidered previously in Bugni et al. (2018). We show that tests based on these estimators using the usual
heteroskedasticity-consistent estimator of the asymptotic variance are invalid in the sense that they may
have limiting rejection probability under the null hypothesis strictly greater than the nominal level. As
explained further below, this phenomenon contrasts sharply with the analysis in Bugni et al. (2018) of other
tests that were found to be conservative in the sense that their limiting rejection probabilities were no greater
than the nominal level. We then exploit our characterization of the behavior of the ordinary least squares
estimator of the coefficients in such a regression under covariate-adaptive randomization to develop a con-
sistent estimator of the asymptotic variance. Our main result about the “fully saturated” linear regression
shows that tests based on these estimators and our new estimator of the asymptotic variance are exact in the
sense that they have limiting rejection probability under the null hypothesis equal to the nominal level. In a
simulation study, we find that tests using the usual heteroskedasticity-consistent estimator of the asymptotic
variance may have rejection probability under the null hypothesis dramatically larger than the nominal level.
On the other hand, tests using the new estimator of the asymptotic variance have rejection probability under
the null hypothesis very close to the nominal level.
We additionally consider tests based on ordinary least squares estimation of a linear regression with
“strata fixed effects,” i.e., a linear regression of the outcome on indicators for each of the treatments and
1

indicators for each of the strata. As emphasized by Imbens and Rubin (2015, Ch. 9) in the case of a
single treatment, such estimators need not even be consistent for the average treatment effect when the
target proportion of units being assigned to treatment varies across strata, so in our analysis of tests based
on these estimators we restrict attention to the special case in which the target proportion of units being
assigned to each of the treatments does not vary across strata. Based on simulation evidence and earlier
assertions by Kernan et al. (1999), the use of this test has been recommended by Bruhn and McKenzie
(2009). More recently, Bugni et al. (2018) provided a formal analysis of the properties of tests based on
these estimators in the case of a single treatment. In this paper, we extend the analysis in Bugni et al.
(2018) about these tests to multiple treatments. We show that tests based on these estimators using the
usual heteroskedasticity-consistent estimator of the asymptotic variance are conservative in the sense that
they have limiting rejection probability under the null hypothesis no greater than, and typically strictly
less than, the nominal level. Once again, we exploit our characterization of the behavior of the ordinary
least squares estimator of the coefficients in such a regression under covariate-adaptive randomization to
develop a consistent estimator of the asymptotic variance. Our main result about the linear regression with
“strata fixed effects” shows that tests based on these estimators and our new estimator of the asymptotic
variance are exact in the sense that they have limiting rejection probability under the null hypothesis equal
to the nominal level. In a simulation study, we find that tests using the usual heteroskedasticity-consistent
estimator of the asymptotic variance may have rejection probability under the null hypothesis dramatically
less than the nominal level and, as a result, may have very poor power when compared to other tests. On
the other hand, tests using the new estimator of the asymptotic variance have rejection probability under
the null hypothesis very close to the nominal level.
The remainder of the paper is organized as follows. In Section 2, we describe our setup and notation.
In particular, there we describe the assumptions we impose on the treatment assignment mechanism. Our
main results concerning the “fully saturated” linear regression are contained in Section 3. Our main results
concerning the linear regression with “strata fixed effects” are contained in Section 4. In Section 5, we
discuss our results in the special case where there is only a single treatment, which facilitates a comparison
of our results with those in Imbens and Rubin (2015, Chapter 9). In Section 6, we examine the finite-sample
behavior of all the tests we consider in this paper via a small simulation study. In Section 7, we provide
recommendations for empirical practice. Finally, in Section 8, we provide an empirical illustration of our
results. Proofs of all results are provided in the Appendix.
2 Setup and Notation
Let Y denote the (observed) outcome of interest for the ith unit, A denote the treatment received by the
i i
ith unit, and Z denote observed, baseline covariates for the ith unit. The list of possible treatments is given
i
by A = {1,...,|A|}, and we say there are multiple treatments when |A| > 1. Without loss of generality we
assume there is a control group, which we denote as treatment zero, and use A = {0} ∪ A to denote the
0
list of treatments that includes the control group. Denote by Y (a) the potential outcome of the ith unit
i
under treatment a ∈ A . As usual, the (observed) outcome and potential outcomes are related to treatment
0
2

assignment by the relationship
(cid:88)
Y = Y (a)I{A = a} = Y (A ) . (1)
i i i i i
a∈A
0
Denote by P the distribution of the observed data
n
X(n) = {(Y ,A ,Z ) : 1 ≤ i ≤ n}
i i i
and denote by Q the distribution of
n
W(n) = {(Y (0),Y (1),...,Y (|A|),Z ) : 1 ≤ i ≤ n} .
i i i i
Note that P is jointly determined by (1), Q , and the mechanism for determining treatment assignment.
n n
We therefore state our assumptions below in terms of assumptions on Q and assumptions on the mechanism
n
for determining treatment status. Indeed, we will not make reference to P in the sequel and all operations
n
are understood to be under Q and the mechanism for determining treatment status.
n
Strata are constructed from the observed, baseline covariates Z using a function S : supp(Z ) → S,
i i
where S is a finite set. For 1 ≤ i ≤ n, let S = S(Z ) and denote by S(n) the vector of strata (S ,...,S ).
i i 1 n
We begin by describing our assumptions on Q . We assume that W(n) consists of n i.i.d. observations,
n
i.e., Q = Qn, where Q is the marginal distribution of (Y (0),Y (1),...,Y (|A|),Z ). In order to rule out
n i i i i
trivial strata, we henceforth assume that p(s) = P{S = s} > 0 for all s ∈ S. We further restrict Q to satisfy
i
the following mild requirement.
Assumption 2.1. Q satisfies
max E[|Y (a)|2] < ∞
i
a∈A
0
and for all a ∈ A
0
maxVar[Y (a)|S = s] > 0 .
i i
s∈S
We note that the second requirement in Assumption 2.1 is made only to rule out degenerate situations and
is stronger than required for our results.
Next, we describe our assumptions on the mechanism determining treatment assignment. As mentioned
previously, in this paper we focus on covariate-adaptive randomization, i.e., randomization schemes that
first stratify according baseline covariates and then assign treatment status so as to achieve “balance” within
each stratum. In order to describe our assumptions on the treatment assignment mechanism more formally,
we require some further notation. Let A(n) be vector of treatment assignments (A ,...,A ). For any
1 n
(a,s) ∈ A ×S, let π (s) ∈ (0,1) be the target proportion of units to assign to treatment a in stratum s, let
0 a
(cid:88)
n (s) = I{A = a,S = s}
a i i
1≤i≤n
3

be the number of units assigned to treatment a in stratum s, and let
(cid:88)
n(s) = I{S = s}
i
1≤i≤n
(cid:80)
be the total number of units in stratum s. Note that π (s) = 1 for all s ∈ S. The following
a∈A a
0
assumption summarizes our main requirement on the treatment assignment mechanism for the analysis of
the “fully saturated” linear regression.
Assumption 2.2. The treatment assignment mechanism is such that
(a) W(n) ⊥⊥ A(n)|S(n).
n (s) P
(b) a → π (s) as n → ∞ for all (a,s) ∈ A × S.
n(s) a
Assumption 2.2.(a) simply requires that the treatment assignment mechanism is a function only of the
vector of strata and an exogenous randomization device. Assumption 2.2.(b) is an additional requirement
that imposes that the (possibly random) fraction of units assigned to treatment a and stratum s approaches
the target proportion π (s) as the sample size tends to infinity. This requirement is satisfied by a wide variety
a
of randomization schemes; see Bugni et al. (2018), Rosenberger and Lachin (2016, Sections 3.10 and 3.11),
and Wei et al. (1986, Proposition 2.5). Before proceeding, we briefly discuss two popular randomization
schemes that are easily seen to satisfy Assumption 2.2.
Example 2.1. (Simple Random Sampling) Simple random sampling (SRS), also known as Bernoulli trials,
refers to the case where A(n) consists of n i.i.d. random variables with
P{A = a|S(n),A(k−1)} = P{A = a} = π (2)
k k a
(cid:80)
for 1 ≤ k ≤ n and π ∈ (0,1) satisfying π = 1. In this case, Assumption 2.2.(a) follows immediately
a a∈A a
0
from (2), while Assumption 2.2.(b) follows from the weak law of large numbers. If (2) is such that the target
probabilities π vary by strata, then
a
P{A = a|S(n),A(k−1)} = P{A = a|S = s} = π (s) ,
k k k a
which is equivalent to simple random sampling within each stratum.
Example 2.2. (Stratified Block Randomization) An early discussion of stratified block randomization (SBR)
is provided by Zelen (1974) for the case of a single treatment. This randomization scheme is sometimes also
referred to as block randomization or permuted blocks within strata. In order to describe this treatment
assignment mechanism, for s ∈ S, denote by n(s) the number of units in stratum s and let
n (s) = (cid:98)n(s)π (s)(cid:99)
a a
(cid:80)
for a ∈ A with n (s) = n(s) − n (s). In this randomization scheme, independently for each each
0 a∈A a
4

stratum s, n (s) units are assigned to each treatment a, where all
a
(cid:18) (cid:19)
n(s)
n (s),n (s),...,n (s)
0 1 |A|
possible assignments are equally likely. Assumptions 2.2.(a) and 2.2.(b) follow by construction in this case.
We note that our analysis of the linear regression with “strata fixed effects” requires an assumption that is
mildly stronger than Assumption 2.2 above. It is worth emphasizing that this stronger assumption parallels
the assumption made in Bugni et al. (2018) for the analysis of linear regression with “strata fixed effects” in
the case of a single treatment and is also satisfied by a wide variety of treatment assignment mechanisms,
including Examples 2.1 and 2.2 above. See Assumption 4.1 and the subsequent discussion there for further
details.
Our object of interest is the vector of average treatment effects (ATEs) on the outcome of interest. For
each a ∈ A, we use
θ (Q) ≡ E[Y (a) − Y (0)] (3)
a i i
to denote the ATE of treatment a relative to the control and
θ(Q) ≡ (θ (Q) : a ∈ A) = (θ (Q),...,θ (Q))(cid:48)
a 1 |A|
to denote the |A|-dimensional vector of such ATEs. Our results permit testing a variety of hypotheses on
smooth functions of the vector θ(Q) at level α ∈ (0,1). In particular, hypotheses on linear functionals can
be written as
H : Ψθ(Q) = c versus H : Ψθ(Q) (cid:54)= c , (4)
0 1
where Ψ is a full-rank (r×|A|)-dimensional matrix and c is a r-dimensional column vector. This framework
accommodates, for example, hypotheses on a particular ATE,
H : θ (Q) = c versus H : θ (Q) (cid:54)= c , (5)
0 a 1 a
as well as hypotheses comparing treatment effects,
H : θ (Q) = θ (Q) versus H : θ (Q) (cid:54)= θ (Q) for any a,a(cid:48) ∈ A . (6)
0 a a(cid:48) 1 a a(cid:48)
Note that θ (Q) = θ (Q) if and only if E[Y (a)] = E[Y (a(cid:48))]. We note further that it is also possible to use
a a(cid:48) i i
our results to test smooth non-linear hypotheses on θ(Q) via the Delta method, but, for ease of exposition,
we restrict our attention to linear restrictions as described above in what follows.
Finally, we often transform objects that are indexed by (a,s) ∈ A × S into vectors or matrices, using
the following conventions. For X(a) being a scalar object indexed over a ∈ A, we use (X(a) : a ∈ A) to
denote the |A|-dimensional column vector (X(1),...,X(|A|))(cid:48). For X (s) being a scalar object indexed by
a
(a,s) ∈ A × S we use (X (s) : (a,s) ∈ A × S) to denote the (|A| × |S|)-dimensional column vector where
a
5

the order of the indices matter: first we iterate over a and then over s, i.e.,
(X (s) : (a,s) ∈ A × S) ≡ (X (1),...,X (1),X (2),...,X (2),...)(cid:48) .
a 1 |A| 1 |A|
Remark 2.1. The term “balance” is often used in a different way to describe whether the distributions of
baseline covariates Z in the treatment and control groups are similar. For example, this might be measured
i
according to the difference in the means of Z in the treatment and control groups. Our usage follows the
i
usage in Efron (1971) or Hu and Hu (2012), where “balance” refers to the extent to which the of fraction of
treated units within a strata differs from the target proportion π (s).
a
3 “Fully Saturated” Linear Regression
In this section, we study the properties of ordinary least squares estimation of a linear regression of the
outcome on all interactions between indicators for each of the treatments and indicators for each of the
strata under covariate-adaptive randomization. We then study the properties of different tests of (4) based
on these estimators. As already noted, these tests have not been previously considered in Bugni et al. (2018).
We consider tests using both the usual homoskedasticity-only and heteroskedasticity-robust estimators of
the asymptotic variance. Our results show that neither of these estimators are consistent for the asymptotic
variance, and, as a result, both lead to tests that are asymptotically invalid in the sense that they may have
limiting rejection probability under the null hypothesis strictly greater than the nominal level. In light of
these results, we exploit our characterization of the behavior of the ordinary least squares estimator of the
coefficients in such a regression under covariate-adaptive randomization to develop a consistent estimator of
the asymptotic variance. Furthermore, tests using our new estimator of the asymptotic variance are exact in
the sense that they have limiting rejection probability under the null hypotheses equal to the nominal level.
In order to define the tests we study, consider estimation of the equation
(cid:88) (cid:88)
Y = δ(s)I{S = s} + β (s)I{A = a,S = s} + u (7)
i i a i i i
s∈S (a,s)∈A×S
ˆ ˆ
by ordinary least squares. For all s ∈ S, denote by δ (s) and β (s) the resulting estimators of δ(s) and
n n,a
β (s), respectively. The corresponding estimator of the ATE of treatment a is given by
a
(cid:88) n(s)
ˆ ˆ
θ = β (s) , (8)
n,a n,a
n
s∈S
and the resulting estimator of θ(Q) is thus given by
θˆ = (θˆ : a ∈ A) ≡ (θˆ ,...,θˆ )(cid:48) . (9)
n n,a n,1 n,|A|
Vˆ θˆ
Let be an estimator of the asymptotic covariance matrix of . For testing the hypotheses in (4), we
n n
6

consider tests of the form
φsat(X(n)) = I{Tsat(X(n)) > χ2 } , (10)
n n r,1−α
where
Tsat(X(n)) = n(Ψθˆ − c)(cid:48)(ΨVˆ Ψ(cid:48))−1(Ψθˆ − c)
n n n n
and χ2 is the 1 − α quantile of a χ2 random variable with r degrees of freedom. In order to study the
r,1−α
ˆ
properties of this test, we first derive in the following theorem the asymptotic behavior of θ .
n
Theorem 3.1. Suppose Q satisfies Assumption 2.1 and the treatment assignment mechanism satisfies As-
sumption 2.2. Then,
√
n(θˆ − θ(Q)) →d N(0,V ) ,
n sat
where V = V + V ,
sat H Y˜
(cid:88)
V ≡ p(s)(E[m (Z ) − m (Z )|S = s] : a ∈ A)(E[m (Z ) − m (Z )|S = s] : a ∈ A)(cid:48) (11)
H a i 0 i i a i 0 i i
s∈S
p(s)σ2 (s) (cid:32) p(s)σ2 (s) (cid:33)
(cid:88) Y˜(0) (cid:88) Y˜(a)
V ≡ ι ι(cid:48) + diag : a ∈ A , (12)
Y˜ π (s) |A| |A| π (s)
0 a
s∈S s∈S
ι is a |A|-dimensional vector of ones, and
|A|
m (Z ) ≡ E[Y (a)|Z ] − E[Y (a)]
a i i i i
σ2 (s) ≡ Var[Y˜ (a)|S = s]
Y˜(a) i i
˜
Y (a) ≡ Y (a) − E[Y (a)|S = s] .
i i i i
Remark 3.1. For each a ∈ A, note that
(cid:18) (cid:18) (cid:19) (cid:19)
√ (cid:88) √ n(s) √
ˆ ˆ ˆ
n(θ − θ (Q)) = n − p(s) β (s) + n(β (s) − β (s))p(s)
n,a a n,a n,a a
n
s∈S
(cid:18) (cid:18) (cid:19) (cid:19)
(cid:88) √ n(s) √
ˆ
= n − p(s) β (s) + n(β (s) − β (s))p(s) + o (1) ,
a n,a a P
n
s∈S
where the second equality exploits a novel law of large numbers that accounts for covariate-adaptive ran-
domization (see Lemma C.4) and the central limit theorem. It is therefore straightforward to derive the
conclusion of Theorem 3.1 from the limit in distribution of
(cid:18) (cid:18) (cid:19) (cid:19)
√ n(s) √
ˆ
n − p(s) , n(β (s) − β (s)) : (a,s) ∈ A × S . (13)
n,a a
n
The derivation of the limit in distribution of (13) does not follow from conventional central limit theorems
due to covariate-adaptive randomization. These difficulties are overcome in Lemma C.1 in the Appendix
using a novel coupling-like argument in combination with results about partial sums.
7

The following theorem characterizes the limits in probability for the usual homoskedasticity-only and
Vˆ
heteroskedasticity-robust estimators of the asymptotic variance. It shows, in particular, that neither
ho
nor Vˆ are consistent for the asymptotic variance of θˆ , V .
hc n sat
Theorem 3.2. Suppose Q satisfies Assumption 2.1 and the treatment assignment mechanism satisfies As-
Vˆ
sumption 2.2. Let be the homoskedasticity-only estimator of the asymptotic variance defined in (B-34)
ho
Vˆ
and be the heteroskedasticity-consistent estimator of the asymptotic variance defined in (B-35). Then,
hc
(cid:34) (cid:32) (cid:33)(cid:35)
(cid:88) (cid:88) p(s) (cid:88) p(s)
Vˆ →P p(s)π (s)σ2 (s) ι ι(cid:48) + diag : a ∈ A
ho a Y˜(a) π (s) |A| |A| π (s)
0 a
(a,s)∈A ×S s∈S s∈S
0
and
p(s)σ2 (s) (cid:32) p(s)σ2 (s) (cid:33)
Vˆ →P (cid:88) Y˜(0) ι ι(cid:48) + diag (cid:88) Y˜(a) : a ∈ A .
hc π (s) |A| |A| π (s)
0 a
s∈S s∈S
Remark 3.2. In the special case with a single treatment, i.e. |A| = 1, we show in Section 5 that the limit
in probability of Vˆ could be strictly smaller than V . Therefore, testing (4) using (10) with Vˆ = Vˆ
hc sat n hc
could lead to over-rejection. In our simulation study in Section 6, we find that the rejection probability may
in fact be substantially larger than the nominal level.
Remark 3.3. It is important to note that in the special case where |A| = 1 and π (s) = 1 for all s ∈ S,
1 2
both Vˆ and Vˆ are consistent for V . The particular properties of this special case have been already
ho hc sat
highlighted by Bugni et al. (2018) in the cases of the two-sample t-test, t-test with strata fixed effects, and
covariate-adaptive permutation tests.
Even though Vˆ is generally inconsistent for V , the proof of Theorem 3.2 reveals that
hc sat
Vˆ →P V , (14)
hc Y˜
under the same assumptions. We exploit this observation in the following theorem to construct a consistent
estimator of the asymptotic variance. The theorem further establishes that tests using this new estimator of
the asymptotic variance are exact in the sense that they have limiting rejection probability under the null
hypotheses equal to the nominal level.
Theorem 3.3. Suppose Q satisfies Assumption 2.1 and the treatment assignment mechanism satisfies As-
Vˆ
sumption 2.2. Let be the heteroskedasticity-consistent estimator of the asymptotic variance defined in
hc
(B-35) and let
(cid:88) n(s) (cid:16) (cid:17)(cid:16) (cid:17)(cid:48)
Vˆ βˆ θˆ βˆ θˆ
= (s) − : a ∈ A (s) − : a ∈ A , (15)
H n,a n,a n,a n,a
n
s∈S
ˆ ˆ
where θ is as in (8) and β (s) is the ordinary least squares estimator of β (s) in (7). Then,
n,a n,a a
Vˆ = Vˆ + Vˆ →P V = V + V . (16)
sat H hc sat H Y˜
In addition, for the problem of testing (4) at level α ∈ (0,1), φsat(X(n)) defined in (10) with Vˆ = Vˆ
n n sat
8

satisfies
lim E[φsat(X(n))] = α (17)
n
n→∞
for Q additionally satisfying the null hypothesis, i.e., Ψθ(Q) = c.
4 Linear Regression with “Strata Fixed Effects”
In this section, we study the properties of ordinary least squares estimation of a linear regression of the
outcome on indicators for each of the treatments and indicators for each of the strata under covariate-adaptive
randomization. We then study the properties of different tests of (4) based on these estimators. As before,
we consider tests using both the usual homoskedasticity-only and heteroskedasticity-robust estimators of the
asymptotic variance, and our results show that neither of these estimators are consistent for the asymptotic
variance. We therefore exploit, as in the previous section, our characterization of the behavior of the ordinary
least squares estimator of the coefficients in such a regression under covariate-adaptive randomization to
develop a consistent estimator of the asymptotic variance, which leads to tests that are exact in the sense
that they have limiting rejection probability under the null hypotheses equal to the nominal level.
In order to define the tests we study, consider estimation of the equation
(cid:88) (cid:88)
Y = δ∗I{S = s} + β∗I{A = a} + u (18)
i s i a i i
s∈S a∈A
by ordinary least squares. Denote by βˆ∗ the resulting estimator of β∗ in (18). The corresponding estimator
n,a a
βˆ∗
of the ATE of treatment a is simply given by , and the resulting estimator of θ(Q) is thus given by
n,a
θˆ∗ = (βˆ∗ : a ∈ A) ≡ (βˆ∗ ,...,βˆ∗ )(cid:48) . (19)
n n,a n,1 n,|A|
Vˆ∗ θˆ∗.
Let be an estimator of the asymptotic variance of For testing the hypotheses in (4), we consider tests
n n
of the form
φsfe(X(n)) = I{Tsfe(X(n)) > χ2 } , (20)
n n r,1−α
where
Tsfe(X(n)) = n(Ψθˆ∗ − c)(cid:48)(ΨVˆ∗Ψ(cid:48))−1(Ψθˆ∗ − c)
n n n n
and χ2 is the 1 − α quantile of a χ2 random variable with r degrees of freedom. In order to study the
r,1−α
θˆ∗.
properties of this test, we first derive the asymptotic behavior of As mentioned earlier, in order to do so,
n
we impose instead of Assumption 2.2 the following assumption, which mildly strengthens it. We emphasize
again that this stronger assumption parallels the assumption made in Bugni et al. (2018) for the analysis of
linear regression with “strata fixed effects” in the case of a single treatment and is also satisfied by a wide
variety of treatment assignment mechanisms, including Examples 2.1 and 2.2.
Assumption 4.1. The treatment assignment mechanism is such that
(a) W(n) ⊥⊥ A(n)|S(n).
9

(b) π (s) = π ∈ (0,1) for all (a,s) ∈ A × S.
a a
(cid:110)(cid:16)√ (cid:16) (cid:17) (cid:17)(cid:12) (cid:111)
(c) n n a(s) − π : (a,s) ∈ A × S (cid:12)S(n) →d N(0,diag(Σ (s)/p(s) : s ∈ S)) a.s. where for each s ∈ S
n(s) a (cid:12) D
and some τ(s) ∈ [0,1],
Σ (s) = τ(s)[diag(π : a ∈ A) − (π : a ∈ A)(π : a ∈ A)(cid:48)] . (21)
D a a a
Assumption 4.1.(a) is the same as Assumption 2.2.(a) and requires that the treatment assignment mech-
anism is a function only of the vector of strata and an exogenous randomization device. Assumption 4.1.(b)
requires the target proportion π (s) to be constant across strata. This restriction is required for consis-
a
θˆ∗
tency of for θ(Q). Finally, Assumption 4.1.(c) is stronger than Assumption 2.2.(b) and requires that the
n
(possibly random) fraction of units assigned to treatment a and stratum s is asymptotically normal as the
sample size tends to infinity. In the case of simple random sampling, where each unit is randomly assigned
to each treatment with probability π , Assumption 4.1.(c) holds with τ(s) = 1 for all s ∈ S. In this sense,
a
the assumption requires that the treatment assignment mechanism improves “balance” relative to simple
random sampling. At the other extreme, we say that the treatment assignment mechanism achieves “strong
balance” when τ(s) = 0 for all s ∈ S, which leads to Σ (s) being a null matrix. It is straightforward to show
D
that stratified block randomization satisfies Assumption 4.1.(c) with τ(s) = 0, i.e., that it achieves “strong
balance.”
θˆ∗:
The following theorem derives the asymptotic behavior of
n
Theorem 4.1. Suppose Q satisfies Assumption 2.1 and the treatment assignment mechanism satisfies As-
sumption 4.1. Then,
√
n(θˆ∗ − θ(Q)) →d N(0,V ) ,
n sfe
where V = V +V +V , V is as in (11), V is as in (12) with π (s) = π for all (a,s) ∈ A×S, and
sfe H Y˜ A H Y˜ a a
(cid:32)
(cid:18)
Σ (s) Σ (s)
V ≡ (cid:88) p(s) ξ (s)ξ (s) D [a,a(cid:48)] − ξ (s)ξ (s) D [a,0]
A a a(cid:48) a 0
π π π π
a a(cid:48) a 0
s∈S
(cid:19) (cid:19)
Σ (s) Σ (s)
−ξ (s)ξ (s) D [a(cid:48),0] + ξ (s)ξ (s) D [0,0] : (a,a(cid:48)) ∈ A × A (22)
a(cid:48) 0 0 0
π π π π
a(cid:48) 0 0 0
and
(cid:88)
ξ (s) ≡ E[m (Z )|S = s] − π E[m (Z )|S = s] . (23)
a a i i a(cid:48) a(cid:48) i i
a(cid:48)∈A
0
Lemmas C.6 and C.7 in the Appendix derive the limit in probability of the usual homoskedasticity-only
θˆ∗.
and heteroskedasticity-consistent estimators of the asymptotic variance of As in the preceding section,
n
θˆ∗.
these results show that neither of these estimators are consistent for the asymptotic variance of In the
n
special case with only one treatment (i.e., |A| = 1), however, the heteroskedasticity-consistent estimator
of the asymptotic variance leads to tests that are asymptotically conservative in the sense that they have
limiting rejection probability under the null hypothesis no greater than the nominal level. See Bugni et al.
(2018, Theorem 4.3) and Section 5 below for further discussion. In light of these results, the following theorem
10

θˆ∗.
constructs a consistent estimator of the asymptotic variance of The theorem further establishes that tests
n
using this new estimator of the asymptotic variance are exact in the sense that they have limiting rejection
probability under the null hypotheses equal to the nominal level. Before proceeding, we note, however, that
the theorem imposes the additional requirement that the randomization scheme achieves “strong balance,”
i.e,. that τ(s) = 0 for all s ∈ S. While it is possible to derive consistent estimators of the asymptotic
θˆ∗
variance of even when this is not the case, it follows from Theorem D.1 in the Appendix that when each
n
test is used with a consistent estimator for the appropriate asymptotic variance, φsfe(X(n)) is in general
n
less powerful along a sequence of local alternatives than φsat(X(n)) except in the case of “strong balance.”
n
θˆ∗
Indeed, it follows immediately from Theorems 3.1 and 4.1 that the asymptotic variance of coincides with
n
ˆ
the asymptotic variance of θ for randomization schemes that achieve “strong balance.” For this reason, we
n
view the case of randomization schemes that achieve “strong balance” as being the most relevant.
Theorem 4.2. Suppose Q satisfies Assumption 2.1 and the treatment assignment mechanism satisfies As-
Vˆ
sumption 4.1 with τ(s) = 0 for all s ∈ S. Let be the heteroskedasticity-consistent estimator of the
hc
Vˆ
asymptotic variance defined in (B-35) and let be defined as in (15). Then,
H
Vˆ = Vˆ + Vˆ →P V = V + V . (24)
sfe H hc sfe H Y˜
In addition, for the problem of testing (4) at level α ∈ (0,1), φsfe(X(n)) defined in (20) with Vˆ = Vˆ
n n sfe
satisfies
lim E[φsfe(X(n))] = α (25)
n
n→∞
for Q additionally satisfying the null hypothesis, i.e., Ψθ(Q) = c.
5 The Case of a Single Treatment
In this section we consider the special case where |A| = 1 to better illustrate the results we derived for the
general case and to compare them to those in Imbens and Rubin (2015). When |A| = 1, θ(Q) is a scalar
parameter and the asymptotic variances in Theorems 3.1 and 4.1 become considerably simpler.
Consider first the the “fully saturated” linear regression. Applying Theorem 3.1 to the case |A| = 1
√
ˆ
shows that n(θ − θ(Q)) tends in distribution to a normal random variable with mean zero and variance
n
equal to
V = ς2 + ς2 ,
sat H Y˜
where
(cid:88)
ς2 ≡ p(s)(E[m (Z ) − m (Z )|S = s])2 (26)
H 1 i 0 i i
s∈S
(cid:32) σ2 (s) σ2 (s)(cid:33)
(cid:88) Y˜(0) Y˜(1)
ς2 ≡ p(s) + . (27)
Y˜
π (s) π (s)
0 1
s∈S
In addition, it follows from Theorem 3.2 and (14) that the usual heteroskedasticity-consistent estimator of
11

the asymptotic variance of θˆ converges in probability to ς2 . As a result, tests based on θˆ and this estimator
n Y˜ n
for the asymptotic variance lead to over-rejection under the null hypothesis whenever ς2 > 0.
H
ˆ
Imbens and Rubin (2015, Ch. 9) study the properties of θ when |A| = 1 and the treatment assignment
n
mechanism is stratified block randomization, which satisfies the hypotheses of Theorem 3.1. In contrast
√
ˆ
to our results, Imbens and Rubin (2015, Theorem 9.2, page 207) conclude that n(θ − θ(Q)) tends in
n
distribution to a normal random variable with mean zero and variance equal to ς2 . In other words, the
Y˜
results in Imbens and Rubin (2015) coincide with our results when the model is sufficiently homogeneous in
the sense that ς2 = 0. This condition can be alternatively written as
H
E[Y (1) − Y (0)|S = s] = E[Y (1) − Y (0)] for all s ∈ S . (28)
i i i i i
When this condition does not hold, however, our results differ from those in Imbens and Rubin (2015) and
lead to tests that are asymptotically exact under arbitrary heterogeneity. In Section 6, we show further
that tests based on θˆ and a consistent estimator of ς2 only may over-reject dramatically when ς2 is indeed
n Y˜ H
positive.
Now consider the linear regression with “strata fixed effects.” Applying Theorem 4.1 to the case |A| = 1
√
n(θˆ∗
shows that − θ(Q)) tends in distribution to a normal random variable with mean zero and variance
n
equal to
V = ς2 + ς2 + ς2 ,
sfe H Y˜ A
where ς2 is as in (26), ς2 is as in (27), and
H Y˜
(1 − 2π )2 (cid:88)
ς2 = 1 τ(s)p(s)(E[m (Z)|S = s] − E[m (Z)|S = s])2 . (29)
A π (1 − π ) 1 0
1 1
s∈S
For treatment assignment mechanisms that achieve “strong balance,” we have in particular that V =
sfe
ς2 + ς2 . Furthermore, applying Lemmas C.6 and C.7 in the Appendix to the case |A| = 1 and τ(s) = 0
H Y˜
shows that the usual homoskedasticity-only estimator of the asymptotic variance is generally inconsistent
for V , while the heteroskedasticity-consistent estimator of the variance, Vˆ∗ , satisfies
sfe hc
(cid:20) (cid:21)
1
Vˆ∗ →P − 3 ς2 + ς2 , (30)
hc π (1 − π ) H Y˜
1 1
which is strictly greater than V , unless ς2 = 0 or π = 1. In other words, when |A| = 1 and τ(s) = 0 for
sfe H 1 2
θˆ∗
all s ∈ S, tests of (4) based on and the usual the heteroskedasticity-consistent estimator of the asymptotic
n
variance Vˆ∗ are asymptotically conservative unless ς2 = 0 or π = 1. See Bugni et al. (2018, Theorem 4.3)
hc H 1 2
for a formal statement of this result.
θˆ∗
Imbens and Rubin (2015, Ch. 9) also study the properties of when |A| = 1 and the treatment
n
assignment mechanism is stratified block randomization, which satisfies the hypotheses of Theorem 4.1. In
particular, stratified block randomization satisfies Assumption 4.1 with τ(s) = 0 for all s ∈ S, so ς2 = 0.
A
√
n(θˆ∗
In contrast to our results, Imbens and Rubin (2015, Theorem 9.1, page 206) conclude that − θ(Q))
n
tends in distribution to a normal random variable with mean zero and variance that can be expressed in our
12

notation as
(cid:20) (cid:21)
1
− 3 ς2 + ς2 .
π (1 − π ) H Y˜
1 1
This asymptotic variance is strictly greater than V unless ς2 = 0 or π = 1, and it coincides with the
sfe H 1 2
limit in probability of the heteroskedasticity-consistent estimator of the asymptotic variance in (30). As in
the case of the “fully saturated” linear regression, the results in Imbens and Rubin (2015) coincide with
our results when the model is sufficiently homogeneous in the sense that condition (28) holds. When this
condition does not hold, however, our results differ from those in Imbens and Rubin (2015) and lead to
tests that are asymptotically exact under arbitrary heterogeneity. In Section 6, we again show that tests
θˆ∗
based on and the usual heteroskedasticity-consistent estimator of the asymptotic variance may over-reject
n
dramatically under the null hypothesis.
Remark 5.1. An inspection of the proofs of Theorems 3.1 and 4.1 reveals that the ς2 term in the expressions
H
√ √
n(θˆ n(θˆ∗−θ(Q))
for the variances of our limiting distributions of −θ(Q)) and stems from the contribution
n n
(cid:16)√ (cid:16) (cid:17) (cid:17)
n(s)
of a term involving n − p(s) : s ∈ S . It follows from this observation that it may be possible to
n
reconcile the differences between our analysis and that in Imbens and Rubin (2015, Ch. 9) by considering
n(s)
an alternative sampling framework where is constant with n.
n
6 Monte Carlo Simulations
In this section, we examine the finite-sample performance of several tests for the hypotheses in (4), including
those introduced in Sections 3 and 4, with a simulation study. For a ∈ A and 1 ≤ i ≤ n, potential outcomes
are generated in the simulation study according to the equation:
Y (a) = µ + (m (Z ) − M ) + σ (Z )(cid:15) , (31)
i a a i a a i a,i
where µ , m (Z ), σ (Z ), M , and (cid:15) are defined below. In each specification, n = 500, {(Z ,(cid:15) ,(cid:15) ) :
a a i a i a a,i i 0,i 1,i
1 ≤ i ≤ n} are i.i.d. with Z , (cid:15) , and (cid:15) all being independent of each other, and M = E[m (Z )]. We
i 0,i 1,i a a i
focus on the case |A| = 1 with π (s) = π for all s ∈ S in order to be able to compare the tests studied in
1
Sections 3 and 4; but also consider the case where π (s) (cid:54)= π (s(cid:48)) for s (cid:54)= s(cid:48).
1 1
Model 1: Z ∼ Beta(2,2) (re-centered and re-scaled by the population mean and variance to have
i
mean zero and variance one); σ (Z ) = σ = 1 and σ (Z ) = σ ; (cid:15) ∼ N(0,1) and (cid:15) ∼ N(0,1);
0 i 0 1 i 1 0,i 1,i
m (Z ) = m (Z ) = γZ . In this case,
0 i 1 i i
Y = µ + (µ − µ )A + γZ + η ,
i 0 1 0 i i i
where
η = σ A (cid:15) + σ (1 − A )(cid:15)
i 1 i 1,i 0 i 0,i
and E[η |A ,Z ] = 0.
i i i
Model 2: As in Model 1, but m (Z ) = −γ log(Z + 3)I{Z ≤ 1}.
0 i i i 2
13

Model 3: As in Model 2, but σ (Z ) = σ |Z |.
a i a i
Model 4: Z ∼ Unif(−2,2); (cid:15) ∼ 1t and (cid:15) ∼ 1t ; σ (Z ) = σ |Z |; and
i 0,i 3 3 1,i 3 3 a i a i
 
γZ2 if Z ∈ [−1,1] γZ if Z ∈ [−1,1]
i i i i
m (Z ) = and m (Z ) = .
0 i 1 i
γZ otherwise γZ2 otherwise
i i
Treatment status is determined according to one of the following four different covariate-adaptive random-
ization schemes:
SRS: Treatment assignment is generated as in Example 2.1.
SBR: Treatment assignment is generated as in Example 2.2.
In each case, strata are determined by dividing the support of Z into |S| intervals of equal length and
i
letting S(Z ) be the function that returns the interval in which Z lies. In all cases, observed outcomes Y
i i i
are generated according to (1). Finally, for each of the above specifications, we consider different values of
(|S|,π,γ,σ ) and consider both (µ ,µ ) = (0,0) (i.e., under the null hypothesis that θ = µ − µ = 0) and
1 0 1 1 0
(µ ,µ ) = (0,0.2) (i.e., under the alternative hypothesis with θ = 0.2).
0 1
The results of our simulations are presented in Tables 1–4 below. Rejection probabilities are computed
using 104 replications. Columns are labeled in the following way:
SAT: The t-test from the “fully saturated” linear regression studied in Section 3. We report results
for this test using the homoskedasticity-only (‘HO’), heteroskedasticity-robust (‘HC’), and the new
(‘NEW’) consistent (as in Theorem 3.3), estimators of the asymptotic variance.
SFE: The t-test from the linear reression with “strata fixed effects” studied in Section 4. We report
results for this test using the homoskedasticity-only (‘HO’), heteroskedasticity-robust (‘HC’), and the
new (‘NEW’) consistent (as in Theorem 3.3), estimators of the asymptotic variance.
Table 1 displays the results of our baseline specification, where (|S|,π,γ,σ ) = (10,0.3,1,1). Table 2
1
displays the results for (|S|,π,γ,σ ) = (10,0.3,2,1), to explore sensitivity to changes in γ. Tables 3 and
1
4 replace π = 0.3 with π = 0.7, so (|S|,π,γ,σ ) = (10,0.7,1,1) and (|S|,π,γ,σ ) = (10,0.7,2,1). Finally,
1 1
Table 5 considers the baseline specification but with π (s) (cid:54)= π (s(cid:48)) for s (cid:54)= s(cid:48), i.e.,
1 1
(π (1),...,π (|S|)) = (0.20,0.25,0.30,0.35,0.40,0.60,0.65,0.70,0.75,0.80) . (32)
1 1
We organize our discussion of the results by test:
SAT: As expected in light of Theorems 3.1 and 3.2, the test φsat(X(n)) in (10) when Vˆ is either the
n n
homoskedasticity-only or heteroskedasticity-consistent estimator of the asymptotic variance may over-
reject under the null hypothesis. Indeed, in some cases (Model 4 in Table 2) the rejection probability
14

Rejection rate under H : θ = 0 Rejection rate under H : θ = 0.2
0 1
SAT SFE SAT SFE
M CAR HO HC NEW HO HC NEW HO HC NEW HO HC NEW
1 SRS 5.13 5.30 5.27 5.08 5.14 5.17 81.96 82.11 82.08 82.01 82.06 82.15
SBR 4.74 4.98 4.92 4.71 4.88 4.93 82.25 82.44 82.32 82.21 82.17 82.31
2 SRS 6.65 6.84 4.93 6.31 5.05 5.08 80.18 80.77 75.71 75.91 72.58 72.66
SBR 6.75 4.63 4.60 4.74 3.58 4.63 79.63 79.94 75.14 75.75 71.91 75.77
3 SRS 7.69 7.79 5.17 6.25 4.86 4.89 84.84 84.93 80.87 80.10 76.98 77.06
SBR 7.19 4.59 4.52 4.53 3.34 4.59 85.11 85.16 80.58 81.14 77.75 81.08
4 SRS 20.04 19.22 5.06 10.80 5.12 5.13 92.44 91.93 79.17 76.45 65.00 65.11
SBR 19.92 19.16 5.19 5.92 2.21 5.35 92.91 92.37 79.10 80.19 67.16 78.98
Table 1: Treatment assignment implemented via simple random sampling (SRS) and stratified block randomization
(SBR). SAT and SFE tests implemented with homoskedastic-only (HO), heteroskedasticity-consistent (HC), and
newly developed (NEW) standard errors. Parameter values: (|S|,π,γ,σ ) = (10,0.3,1,1).
1
Rejection rate under H : θ = 0 Rejection rate under H : θ = 0.2
0 1
SAT SFE SAT SFE
M CAR HO HC NEW HO HC NEW HO HC NEW HO HC NEW
1 SRS 8.57 5.06 5.07 8.41 4.85 4.87 66.73 58.45 58.55 67.22 58.37 58.47
SBR 8.51 5.10 5.05 8.42 5.00 5.06 67.57 59.03 58.79 67.43 58.64 58.80
2 SRS 14.35 10.16 5.31 10.85 5.39 5.44 65.42 58.17 45.91 53.33 39.88 39.93
SBR 14.58 9.80 5.06 7.50 3.15 5.10 65.87 58.93 46.96 54.53 39.72 47.68
3 SRS 14.73 10.45 5.25 10.23 5.09 5.10 69.79 63.22 49.71 56.39 43.53 43.64
SBR 15.02 10.55 4.88 6.96 2.89 4.97 71.28 64.39 49.93 57.48 41.88 51.10
4 SRS 31.22 26.06 5.28 12.35 5.39 5.41 73.57 69.41 36.25 42.20 26.50 26.56
SBR 32.00 26.69 5.00 6.56 1.82 5.09 74.30 69.97 36.60 40.38 21.48 36.56
Table 2: Treatment assignment implemented via simple random sampling (SRS) and stratified block randomization
(SBR). SAT and SFE tests implemented with homoskedastic-only (HO), heteroskedasticity-consistent (HC), and
√
newly developed (NEW) standard errors. Parameter values: (|S|,π,γ,σ ) = (10,0.3,2, 2).
1
under the null hypothesis could be as high as 32% for the homoskedasticity-only case and 30% for the
heteroskedasticity-consistent case. This over-rejection happens both, under simple random sampling
and stratified block randomization. Finally, and consistent with the results in Section 5, whenever Q is
such that V = 0, as it is the case in Model 1, the test with the heteroskedasticity-consistent estimator
H
of the asymptotic variance is asymptotically exact.
According to Theorem 3.3, the test φsat(X(n)) in (10) when Vˆ is given by the new consistent estimator
n n
of the asymptotic variance in (16) is asymptotically exact across all the specifications we consider.
Indeed, the rejection probability under the null hypothesis is very close to the nominal level in all
models and all tables. The rejection probability under the alternative hypothesis is the highest under
simple random sampling among the tests that are asymptotically exact and do not over-reject under
the null hypothesis. Under stratified block randomization, and given that in this case τ(s) = 0 for
all s ∈ S, the rejection probability under the alternative hypothesis is effectively the same as that of
φsfe(X(n)) with the new consistent estimator of the asymptotic variance in (24). These results are in
n
line with the theoretical results described in Section 4. Finally, Table 5 illustrates that the results for
φsat(X(n)) with the new consistent estimator of the asymptotic variance are not affected by whether
n
π (s) is the same across strata s ∈ S or not.
1
SFE: As expected from Theorem 4.1 and the subsequent discussion, the test φsfe(X(n)) in (20) when
n
15

| 5.13 5.30 5.27 5.08 5.14 5.17    |
| 4.74 4.98 4.92 4.71 4.88 4.93    |
|:---------------------------------|
| 6.65 6.84 4.93 6.31 5.05 5.08    |
| 6.75 4.63 4.60 4.74 3.58 4.63    |
| 7.69 7.79 5.17 6.25 4.86 4.89    |
| 7.19 4.59 4.52 4.53 3.34 4.59    |
| 20.04 19.22 5.06 10.80 5.12 5.13 |
| 19.92 19.16 5.19 5.92 2.21 5.35  |

| 8.57 5.06 5.07 8.41 4.85 4.87    |
| 8.51 5.10 5.05 8.42 5.00 5.06    |
|:---------------------------------|
| 14.35 10.16 5.31 10.85 5.39 5.44 |
| 14.58 9.80 5.06 7.50 3.15 5.10   |
| 14.73 10.45 5.25 10.23 5.09 5.10 |
| 15.02 10.55 4.88 6.96 2.89 4.97  |
| 31.22 26.06 5.28 12.35 5.39 5.41 |
| 32.00 26.69 5.00 6.56 1.82 5.09  |

Rejection rate under H : θ = 0 Rejection rate under H : θ = 0.2
0 1
SAT SFE SAT SFE
M CAR HO HC NEW HO HC NEW HO HC NEW HO HC NEW
1 SRS 5.08 5.29 5.23 4.96 5.01 5.02 81.75 82.12 82.00 81.99 81.97 82.01
SBR 5.02 5.10 5.06 4.95 4.95 5.00 82.76 82.93 82.79 82.65 82.73 82.82
2 SRS 6.72 6.94 4.83 6.26 5.01 5.03 79.85 80.08 75.32 74.87 71.56 71.63
SBR 7.05 7.11 5.08 4.99 3.93 5.05 80.46 80.54 76.61 75.77 72.26 76.04
3 SRS 7.23 7.58 5.03 6.44 5.03 5.05 85.81 85.82 81.28 80.35 77.09 77.12
SBR 7.56 7.70 5.14 5.07 3.92 5.16 87.56 87.62 83.07 82.40 78.71 82.75
4 SRS 18.46 19.91 5.43 10.02 5.20 5.21 92.45 93.12 80.79 76.88 66.84 66.95
SBR 18.25 19.63 5.93 5.21 2.09 5.83 92.98 93.33 82.57 81.27 71.75 82.77
Table 3: Treatment assignment implemented via simple random sampling (SRS) and stratified block randomization
(SBR). SAT and SFE tests implemented with homoskedastic-only (HO), heteroskedasticity-consistent (HC), and
newly developed (NEW) standard errors. Parameter values: (|S|,π,γ,σ ) = (10,0.7,1,1).
1
Rejection rate under H : θ = 0 Rejection rate under H : θ = 0.2
0 1
SAT SFE SAT SFE
M CAR HO HC NEW HO HC NEW HO HC NEW HO HC NEW
1 SRS 2.72 5.55 5.45 2.79 5.35 5.38 58.45 68.64 68.35 59.02 68.51 68.62
SBR 2.66 5.23 5.17 2.64 5.13 5.14 58.79 68.91 68.79 58.79 68.74 68.80
2 SRS 7.18 11.48 5.28 6.22 5.44 5.47 58.35 66.71 51.98 47.35 45.08 45.21
SBR 7.18 11.19 4.99 3.19 2.80 5.02 58.95 66.52 53.69 45.17 43.14 52.74
3 SRS 8.00 12.36 5.13 6.43 5.24 5.29 64.51 71.87 56.25 51.30 47.55 47.61
SBR 7.63 11.88 4.99 3.35 2.83 5.00 65.91 73.20 58.83 50.41 47.03 57.71
4 SRS 24.98 30.67 5.12 10.82 5.61 5.62 69.65 74.39 39.07 39.87 27.80 27.86
SBR 24.81 30.72 6.01 4.49 1.50 5.81 70.74 75.42 41.60 37.57 24.20 41.41
Table 4: Treatment assignment implemented via simple random sampling (SRS) and stratified block randomization
(SBR). SAT and SFE tests implemented with homoskedastic-only (HO), heteroskedasticity-consistent (HC), and
√
newly developed (NEW) standard errors. Parameter values: (|S|,π,γ,σ ) = (10,0.7,2, 2).
1
Vˆ
is the homoskedasticity-only estimator of the asymptotic variance could lead to over-rejection or
n
under-rejection, depending on the specification. For example, the rejection probability under the null
hypothesis in Table 2 could be as high as 12.25%, while in Table 4 could be as low as 2.64%. On the
Vˆ
other hand, when is the heteroskedasticity-consistent estimator of the asymptotic variance, this test
n
is asymptotically conservative; in line with the results in Bugni et al. (2018) and Section 5. Indeed,
the rejection probability under the null hypothesis is close to 2% in Model 4 under stratified block
randomization for all the specifications we consider. Finally, and consistent with the results in Section
5, whenever Q is such that V = 0, as it is the case in Model 1, the test with the heteroskedasticity-
H
consistent estimator of the asymptotic variance is asymptotically exact.
According with Theorem 4.2, the test φsfe(X(n)) in (20) when Vˆ is given by the new consistent
n n
estimator of the asymptotic variance in (24) is asymptotically exact across all the specifications we
consider. The rejection probability under the null hypothesis is very close to the nominal level in all
models and all tables. The rejection probability under the alternative hypothesis is similar to that
of φsat(X(n)) with Vˆ = Vˆ under stratified block randomization, but often below the rejection
n n sat
probability of that same test under simple random sampling. These results are again in line with the
theoretical results discuss in Section 4. Finally, Table 5 illustrates that φsfe(X(n)) is only a valid test
n
for the null in (4) when π (s) = π for all s ∈ S and may otherwise over-reject under the null hypothesis.
1
16

| 5.08 5.29 5.23 4.96 5.01 5.02    |
| 5.02 5.10 5.06 4.95 4.95 5.00    |
|:---------------------------------|
| 6.72 6.94 4.83 6.26 5.01 5.03    |
| 7.05 7.11 5.08 4.99 3.93 5.05    |
| 7.23 7.58 5.03 6.44 5.03 5.05    |
| 7.56 7.70 5.14 5.07 3.92 5.16    |
| 18.46 19.91 5.43 10.02 5.20 5.21 |
| 18.25 19.63 5.93 5.21 2.09 5.83  |

| 2.72 5.55 5.45 2.79 5.35 5.38    |
| 2.66 5.23 5.17 2.64 5.13 5.14    |
|:---------------------------------|
| 7.18 11.48 5.28 6.22 5.44 5.47   |
| 7.18 11.19 4.99 3.19 2.80 5.02   |
| 8.00 12.36 5.13 6.43 5.24 5.29   |
| 7.63 11.88 4.99 3.35 2.83 5.00   |
| 24.98 30.67 5.12 10.82 5.61 5.62 |
| 24.81 30.72 6.01 4.49 1.50 5.81  |

Rejection rate under H : θ = 0 Rejection rate under H : θ = 0.2
0 1
SAT SFE SAT SFE
M CAR HO HC NEW HO HC NEW HO HC NEW HO HC NEW
1 SRS 5.20 5.47 5.47 5.08 5.12 5.15 81.63 82.48 82.48 82.80 82.71 82.75
SBR 5.27 5.39 5.39 5.32 5.42 5.44 83.15 83.48 83.48 83.49 83.43 83.58
2 SRS 6.74 7.18 5.70 9.05 7.13 9.51 79.53 80.14 76.98 87.24 84.66 87.61
SBR 7.18 7.33 5.63 8.92 7.05 9.08 80.57 80.91 77.23 90.72 88.61 90.91
3 SRS 8.89 8.14 6.34 9.49 8.18 8.99 85.19 84.10 81.04 92.03 90.57 91.54
SBR 8.24 7.56 5.53 9.03 7.53 8.37 86.51 85.38 81.77 94.92 93.76 94.42
4 SRS 19.74 18.16 6.41 60.82 45.51 59.43 91.77 90.90 80.14 12.92 5.62 12.42
SBR 19.71 18.14 6.69 67.13 48.22 66.08 91.61 90.77 80.78 4.42 1.12 4.00
Table 5: Treatment assignment implemented via simple random sampling (SRS) and stratified block randomization
(SBR). SAT and SFE tests implemented with homoskedastic-only (HO), heteroskedasticity-consistent (HC), and
newly developed (NEW) standard errors. Parameter values: (|S|,π,γ,σ ) = (10,π (s),1,1) with π (s) as in (32).
1 1 1
7 Implications for Empirical Practice
When the target proportion of units being assigned to each treatment varies across strata, we recommend
using the test φsat based on ordinary least squares estimation of the “fully saturated” linear regression and
n
the consistent estimator of the asymptotic variance that we derive in Theorem 3.3. Importantly, tests based
on these estimators with the usual heteroskedasticity-consistent estimator of the asymptotic variance may
be invalid in the sense that they may have limiting rejection probability under the null hypothesis strictly
greater than the nominal level. When the target proportion of units being assigned to each treatment does
not vary across strata, one may additionally consider use of the test φsfe based on ordinary least squares
n
estimation of the linear regression with “strata fixed effects” and the consistent estimator of the asymptotic
variance that we derive in Theorem 4.2. Our theoretical results results reveal that for a given function
mapping Z into strata fixed, the power of φsfe is highest when using a randomization schemes that satisfies
i n
Assumption 4.1.(c) with τ(s) = 0 for all s ∈ S, such as stratified block randomization. On the other hand,
φsat is in general weakly preferred to φsfe and may be strictly preferred for randomization schemes that
n n
satisfy Assumption 4.1.(c) with τ(s) > 0 for some s ∈ S. For simplicity, it may therefore be preferable to
use φsat.
n
In this paper, we do not consider further questions about “optimal” treatment assignment, but, in
conclusion, we mention two recent papers on this topic. Building upon our results, Tabord-Meehan (2018)
considers optimization of the power of φsat over different functions mapping Z into strata using stratification
n i
trees. Bai (2018), on the other hand, considers minimization of the mean squared error of the difference-
in-means estimator of the average treatment effect over a general class of randomization mechanisms that,
importantly, includes mechanisms with a “large” number of strata.
8 Empirical Illustration
We conclude our paper with an empirical illustration using data from Chong et al. (2016), who study the
effect of iron deficiency anemia (i.e., anemia caused by a lack of iron) on school-age children’s educational
17

| 5.20 5.47 5.47 5.08 5.12 5.15      |
| 5.27 5.39 5.39 5.32 5.42 5.44      |
|:-----------------------------------|
| 6.74 7.18 5.70 9.05 7.13 9.51      |
| 7.18 7.33 5.63 8.92 7.05 9.08      |
| 8.89 8.14 6.34 9.49 8.18 8.99      |
| 8.24 7.56 5.53 9.03 7.53 8.37      |
| 19.74 18.16 6.41 60.82 45.51 59.43 |
| 19.71 18.14 6.69 67.13 48.22 66.08 |

attainment and cognitive ability in Peru. The data used in this experiment are publicly available in the
AEA website at https://www.aeaweb.org/articles?id=10.1257/app.20140494.
8.1 Empirical Setting
We now briefly summarize the empirical setting; see Chong et al. (2016) for a more detailed description.
According to the medical literature, iron deficiency anemia may impair cognitive function, memory, and
attention span. In this way, iron deficiency anemia may significantly increase the cost of human capital ac-
cumulation for school-age children and lead to nutrition-based poverty traps. Chong et al. (2016) investigate
whether showing students promotional videos can incentivize them to increase their iron intake and thus
improve their academic performance.
The units in this experiment are 219 students in a rural secondary school in the impoverished Cajamarca
district of Peru between October and December in 2009. During this period, these students were exposed to
short instructional videos when logging into their personal computers at school. Each student was randomly
assigned to one of three types of videos: two treatments and a control. The first treatment video featured
a popular soccer player encouraging the students to consume iron supplements to maximize their energy.
The second treatment video featured a doctor encouraging them to consume iron supplements for their
overall health. Finally, the control video featured a dentist who encouraged oral hygiene without mentioning
iron in any way. Throughout this experiment, researchers additionally stocked the local clinic with iron
supplements, which were provided for free to any student who requested them.
Students were assigned to one of the three types of videos using stratified block randomization, where
stratification occurred by grade, taking values s ∈ S = {1,2,3,4,5}. As explained in footnote 17 of Chong
et al. (2016), within each grade, the researchers assigned one third of the students to each video type, i.e.,
π (s) = 1/3 for all a ∈ A = {0,1,2} and s ∈ S. Table 6 describes the sample sizes for each combination
a 0
of stratum and treatment. Note that the sample consists of 215 students rather than 219 students because
four students were excluded from the study for various reasons; see, for example, footnote 24 in Chong et al.
(2016), which explains that two students failed to turn in a required consent form. We conjecture that
these exclusions explain the discrepancies between the observed treatment proportions and π (s) observed
a
in Table 6. Note further that since in this case π (s) does not depend on s, our results imply that we could
a
analyze the experiment using either the “fully saturated” linear regression described in Section 3 or the
linear regression with “strata fixed effects” described in Section 4. Below we focus on the former, but note
that the latter provides similar results.
s = 1 s = 2 s = 3 s = 4 s = 5 total
a = 0 (placebo video) 15 19 16 12 10 72
a = 1 (soccer video) 16 19 15 10 10 70
a = 2 (doctor video) 17 20 15 11 10 73
total 48 58 46 33 30 215
Table 6: Sample sizes for each combination of stratum and treatment.
18

8.2 Results
Chong et al. (2016) examine the effect of the treatment videos relative to the control video on a variety of
cognitive ability and educational attainment outcomes. We focus on academic achievement, as measured
by a student’s average grade during the last two quarters of the 2009 academic year in five subjects: math,
foreign language, social science, science, and communications. As explained by the authors, this constitutes
one of the primary outcomes of interest in Chong et al. (2016).
We present our results in Table 7, which was computed using our car_sat Stata package available at
https://bitbucket.org/iacanay/car-stata. In both the top and bottom half of Table 7, the first column
reports point estimates of θ (Q) for the two treatment videos a ∈ A = {1,2} that we obtained from the
a
“fully saturated” linear regression, i.e.,
5
(cid:88) n(s)
ˆ ˆ
θ = β (s) ,
n,a n,a
n
s=1
ˆ
where β (s) is the ordinary least squares estimator of β (s) in the following regression,
n,a a
5 2 5
(cid:88) (cid:88)(cid:88)
Y = δ(s)I{S = s} + β (s)I{A = a,S = s} + u .
i i a i i i
s=1 a=1s=1
The remaining columns report standard errors, the resulting t-statistic, a p-value for a two-sided test of the
null hypothesis that θ (Q) = 0; and a 95% confidence interval for θ (Q). The difference between the top
a a
and bottom half of Table 7 resides in the estimators of the standard errors. The top half reports results
for the “new” standard errors computed using our estimator of the asymptotic variance defined in (16). To
facilitate reading, we restate the expressions here in the context of our application; that is,
Vˆ Vˆ Vˆ
= + ,
sat H hc
Vˆ
where is the variance component due to treatment effect heterogeneity,
H
(cid:32) (cid:33)(cid:32) (cid:33)(cid:48)
5 ˆ ˆ ˆ ˆ
Vˆ (cid:88) n(s) β n,1(s) − θ n,1 β n,1(s) − θ n,1
=
H
n βˆ (s) − θˆ βˆ (s) − θˆ
s=1 n,2 n,2 n,2 n,2
Vˆ
and is the usual heteroskedasticity-consistent estimator of the asymptotic variance defined in (B-35). The
hc
bottom half of Table 7 reports results when the standard errors are computed using the usual heteroskedasticity-
Vˆ
consistent estimator of the asymptotic variance .
hc
Vˆ Vˆ +Vˆ Vˆ
Since the diagonal elements of = are larger than the diagonal elements of , the “new”
sat H hc hc
standard errors are larger than the usual heteroskedasticity-consistent standard errors. The differences,
however, in this instance are small and do not lead to any meaningful differences in terms of the conclusions
we draw from the experiment when testing either the null hypothesis that θ (Q) = 0 or the null hypothesis
1
that θ (Q) = 0 at the conventional 5% significance level. To gain further insight into the magnitude of these
2
19

SAT regression: “new” standard errors
Coef. s.e. t-stat p-value [95% Conf. Int.]
ˆ
θ (soccer video) -0.051 0.206 -0.248 0.805 -0.458 0.356
n,1
ˆ
θ (doctor video) 0.409 0.206 1.981 0.049 -0.002 0.816
n,2
SAT regression: hc standard errors
Coef. s.e. t-stat p-value [95% Conf. Int.]
ˆ
θ (soccer video) -0.051 0.206 -0.248 0.804 -0.457 0.354
n,1
ˆ
θ (doctor video) 0.409 0.203 2.013 0.046 -0.008 0.810
n,2
Table 7: Inference about the average effect of treatments a ∈ A = {1,2} (relative to the control) on academic
achievement. “New” standard errors correspond to the ones we derive in this paper, while hc standard errors are the
default “robust” standard errors in Stata.
Vˆ Vˆ
differences, it is instructive to examine and in more detail, which are displayed below:
H hc
(cid:32) (cid:33) (cid:32) (cid:33)
0.0630 0.0385 9.101 4.503
Vˆ Vˆ
= , = .
H hc
0.0385 0.291 4.503 8.879
Vˆ Vˆ
We see that is close to zero and at least an order of magnitude smaller than . By inspecting
H hc
the expression of V above, we see that βˆ (s) and βˆ (s) are nearly constant across the five strata,
H n,1 n,2
which in turn suggests that stratification is nearly irrelevant in this particular application in the sense that
E[Y (a) − Y (0)|S ] nearly equals E[Y (a) − Y (0)] for each a ∈ {1,2}.
i i i i i
Appendix A Additional Notation
Throughout the Appendix we employ the following notation, not necessarily introduced in the text.
σ2 (s) For a random variable X, σ2 (s) = Var[X|S = s]
X X
σ2 For a random variable X, σ2 = Var[X]
X X
µ For a ∈ A , E[Y (a)]
a 0 i
˜
Y (a) For a ∈ A , Y (a) − E[Y (a)|S ]
i 0 i i i
m (Z ) For a ∈ A , E[Y (a)|Z ] − µ
a i 0 i i a
n(s) Number of individuals in strata s ∈ S
n (s) Number of individuals in treatment a ∈ A in strata s ∈ S
a 0
ι |A|-dimensional column vector of ones
|A|
O (|A| × |S|)-dimensional matrix of zeros
I |A|-dimensional identity matrix
|A|
J (|S| × |S|)-dimensional matrix with a 1 on the (s,s)th coordinate and zeros otherwise
s
Table 8: Useful notation
In addition, we often transform objects that are indexed by (a,s) ∈ A × S into vectors or matrices, using the
20

following conventions. For X(a) being a scalar object indexed over a ∈ A, we use (X(a) : a ∈ A) to denote the
|A|-dimensional vector (X(1),...,X(|A|))(cid:48). For X (s) being a scalar object indexed by (a,s) ∈ A × S we use
a
(X (s) : (a,s) ∈ A × S) to denote the (|A| × |S|)-dimensional column vector where the order of the indices is as
a
follows,
(X (s) : (a,s) ∈ A × S) = (X (1),...,X (1),X (2),...,X (2),...)(cid:48) .
a 1 |A| 1 |A|
L(j) L(j)
Finally throughout the appendix we use (s) and for j = 1,2,..., to denote scalar objects and matrices/vectors
n,a n
that may be redefined from theorem to theorem.
Appendix B Proof of Main Theorems
B.1 Proof of Theorem 3.1
Let C be the matrix of covariate associated with the regression in (7), i.e., the matrix with ith row given by
n
C = [(I{S = s} : s ∈ S)(cid:48),(I{A = a,S = s} : (a,s) ∈ A × S)(cid:48)] .
i i i i
Let R be a matrix with |A| rows and (|S| + |A| × |S|) columns defined as
n
(cid:20) (cid:21)
n(1) n(|S|)
R = O, I ,..., I , (B-33)
n |A| |A|
n n
where O and I are defined in Table 8. Using this notation, we can write
|A|
(cid:34) (cid:35)
ˆ
(δ (s) : s ∈ S)
θˆ = R n
n n
ˆ
(β (s) : (a,s) ∈ A × S)
n,a
ˆ ˆ
where δ (s) and β (s) are the resulting estimators of δ(s) and β (s) in (7), respectively. Now consider the following
n n,a a
derivation,
(cid:32) (cid:33)
(cid:18) (cid:19)−1
√ √ 1 1
n(θˆ − θ(Q)) = n R C(cid:48) C C(cid:48) Y − θ(Q)
n n n n n n
n n
(cid:32) (cid:34) (cid:35) (cid:34) (cid:35)
n n
(cid:88) n(s) 1 (cid:88) (cid:88) n(s) 1 (cid:88)
˜ ˜
= √ I{A = a,S = s}Y (a) − √ I{A = 0,S = s}Y (0)
i i i i i i
n (s) n n (s) n
a 0
s∈S i=1 s∈S i=1
(cid:33)
(cid:18) (cid:19)
(cid:88)√ n(s)
+ n − p(s) E [m (Z) − m (Z)|S = s] : a ∈ A
a 0
n
s∈S
(cid:32) (cid:33) (cid:32) (cid:33)
(cid:88)(cid:16) (cid:17) (cid:88)
= L(1)(s) − L(1) (s) : a ∈ A + L(2)(s) : a ∈ A + o (1)
n,a n,0 n,a P
s∈S s∈S
where for (a,s) ∈ A × S,
(cid:34) (cid:35)
n
1 1 (cid:88)
L(1)(s) ≡ √ I{A = a,S = s}Y˜ (a)
n,a i i i
π (s) n
a
i=1
(cid:18) (cid:19)
√ n(s)
L(2)(s) ≡ n − p(s) E [m (Z) − m (Z)|S = s] .
n,a a 0
n
21

By Lemma C.1 and some additional calculations, it follows that
 (cid:16) (cid:16) (cid:17) (cid:17) 
(cid:80) L(1) (s) − L(1) (s) : a ∈ A (cid:32)(cid:32) 0 (cid:33) (cid:32) V 0 (cid:33)(cid:33)
s∈S n,a n,0 →d Y˜
 (cid:16) (cid:17)  N , ,
(cid:80) L(2) (s) : a ∈ A 0 0 V
s∈S n,a H
where V is as in (12) and V is as in (11). Importantly, to get V for the second term we used that
Y˜ H H
(cid:80)
p(s)E [m (Z) − m (Z)|S = s] = 0 for all a ∈ A.
s∈S a 0
B.2 Proof of Theorem 3.2
The homoskedasticity-only estimator of the asymptotic variance for the regression in (7) is
(cid:32) (cid:33)
n (cid:18) (cid:19)−1
1 (cid:88) 1
Vˆ = uˆ2 R C(cid:48) C R(cid:48) , (B-34)
ho i n n n n
n n
i=1
where {uˆ : 1 ≤ i ≤ n} are the least squares residuals. The result then follows immediately from
i
n
1 (cid:88) (cid:88)
uˆ2 →P p(s)π (s)σ2 (s) ,
i a Y˜(a)
n
i=1 (a,s)∈A0×S
which follows from Lemma C.5, and
(cid:34) (cid:32) (cid:33)(cid:35)
(cid:18) (cid:19)−1
1 (cid:88) p(s) (cid:88) p(s)
R C(cid:48) C R(cid:48) →P ι ι(cid:48) + diag : a ∈ A
n n n n n π (s) |A| |A| π (s)
0 a
s∈S s∈S
which follows from Lemma C.3, (B-33), and some additional calculations.
The heteroskedasticity-consistent estimator of the asymptotic variance for the regression in (7) is
(cid:34) (cid:35)
(cid:18) (cid:19)−1 (cid:18) (cid:19)(cid:18) (cid:19)−1
1 1 1
Vˆ = R C(cid:48) C C(cid:48) diag(cid:0) uˆ2 : 1 ≤ i ≤ n(cid:1)C C(cid:48) C R(cid:48) . (B-35)
hc n n n n i n n n n
n n n
First note that 1C(cid:48) diag(cid:0) uˆ2 : 1 ≤ i ≤ n(cid:1)C equals
n n i n
(cid:34) diag(1 (cid:80)n uˆ2I{S = s} : s ∈ S) (cid:80) J ⊗ (1 (cid:80)n uˆ2I{A = a,S = s} : a ∈ A)(cid:48) (cid:35)
n i=1 i i s∈S s n i=1 i i i ,
(cid:80) J ⊗ (1 (cid:80)n uˆ2I{A = a,S = s} : a ∈ A) diag(1 (cid:80)n uˆ2I{A = a,S = s} : (a,s) ∈ A × S)
s∈S s n i=1 i i i n i=1 i i i
which follows from Lemma C.3. By Lemma C.4, this matrix converges in probability to
 
diag((cid:80) p(s)π (s)σ2 (s) : s ∈ S) (cid:80) J ⊗ (p(s)π (s)σ2 (s) : a ∈ A)(cid:48)
 a∈A0 a Y˜(a) s∈S s a Y˜(a)  .
(cid:80) J ⊗ (p(s)π (s)σ2 (s) : a ∈ A) diag(p(s)π (s)σ2 (s) : (a,s) ∈ A × S)
s∈S s a Y˜(a) a Y˜(a)
The result follows by combining this with Lemma C.3 and doing some additional calculations.
B.3 Proof of Theorem 3.3
By Theorem 3.2, it follows that
p(s)σ2 (s) (cid:32) p(s)σ2 (s) (cid:33)
Vˆ →P (cid:88) Y˜(0) ι ι(cid:48) + diag (cid:88) Y˜(a) : a ∈ A .
hc π (s) |A| |A| π (s)
0 a
s∈S s∈S
22

By Lemma C.3 and for any a ∈ A,
(cid:16) (cid:17)
ˆ ˆ P
β (s) − θ → E [m (Z) − m (Z)|S = s],
n,a n,a a 0
which in turn implies that
(cid:88) n(s) (cid:16) (cid:17)(cid:16) (cid:17)(cid:48)
Vˆ βˆ θˆ βˆ θˆ
= (s) − : a ∈ A (s) − : a ∈ A
H n,a n,a n,a n,a
n
s∈S
(cid:88)
→P p(s)(E[m (Z) − m (Z)|S = s] : a ∈ A)(E[m (Z) − m (Z)|S = s] : a ∈ A)(cid:48) ,
a 0 a 0
s∈S
where we used n(s) →P p(s). By the continuous mapping theorem, we conclude that Vˆ →P V . By Theorem 3.1,
sat sat
n
lim E[φsat(X(n))] = α follows immediately whenever Q is such that Ψθ(Q) = c.
n→∞ n
B.4 Proof of Theorem 4.1
Let M ≡ I −S (S(cid:48) S )−1S(cid:48) denote the projection on the orthogonal complement of the column space of S , where
n n n n n n n
S is the matrix with ith row given by (I{S = s} : s ∈ S)(cid:48). By the Frisch-Waugh-Lovell Theorem,
n i
θˆ∗ = (A(cid:48) M(cid:48) M A )−1(A(cid:48) M(cid:48) Y ) ,
n n n n n n n n
where Y = (Y : 1 ≤ i ≤ n) and A is the matrix with ith row given by (I{A = a} : a ∈ A)(cid:48). Next, notice that
n i n i
(cid:32)(cid:32) (cid:33)(cid:48) (cid:33)
(cid:88) n (s)
M A = I{A = a} − I{S = s} a : a ∈ A : 1 ≤ i ≤ n
n n i i
n(s)
s∈S
is an (n×|A|)-dimensional matrix, where we have used that S(cid:48) S = diag(n(s) : s ∈ S) and that S(cid:48) A is an (|S|×|A|)-
n n n n
dimensional matrix with (s,a)th element given by n (s). It follows from the above derivation and Assumption 4.1
a
that the (a,a˜) element of 1A(cid:48) M(cid:48) M A satisfies
n n n n n
(cid:88) n (s) (cid:88) n (s˜)n (s˜)
a a a˜ P
I{a = a˜} − → I{a = a˜}π − π π ,
a a a˜
n n(s˜)n
s∈S s˜∈S
and so by the continuous mapping theorem we get
(cid:18) (cid:19)−1 (cid:18) (cid:19)
1 1 1
A(cid:48) M(cid:48) M A →P diag : a ∈ A + ι ι(cid:48) .
n n n n n π π |A| |A|
a 0
Now consider the matrix 1A(cid:48) M(cid:48) Y . Simple manipulations shows that
n n n n
(cid:32)
n n
1 (cid:88) 1 (cid:88) (cid:88) (cid:88) n (s) 1 (cid:88)
A(cid:48) M(cid:48) Y = I{A = a,S = s}Y˜ (a) − a I{A = a˜,S = s}Y˜ (a˜)
n n n i i i i i i
n n n(s) n
s∈S i=1 s∈Sa˜∈A0 i=1
(cid:33)
(cid:88) n (s) n(s) (cid:88) (cid:88) n (s) n (s) n(s)
a a a˜
+ E[m (Z)|S = s] − E[m (Z)|S = s] : a ∈ A
a a˜
n(s) n n(s) n(s) n
s∈S a˜∈A0 s∈S
We conclude that
(cid:18) (cid:18) (cid:19) (cid:19)
√ 1 1 1
n(θˆ∗ − θ(Q)) = diag : a ∈ A + ι ι(cid:48) + o (1) √ A(cid:48) M(cid:48) Y .
n π π |A| |A| P n n n n
a 0
23

Next, we derive the limiting distribution of √1 A(cid:48) M(cid:48) Y . In order to do this, write
n n n n
1
√ A(cid:48) M(cid:48) Y = L + o (1) ,
n n n n P
n
where
(cid:32)
n n
(cid:88) 1 (cid:88) (cid:88) (cid:88) 1 (cid:88)
L = √ I{A = a,S = s}Y˜ (a) − π √ I{A = a˜,S = s}Y˜ (a˜)
n i i i a i i i
n n
s∈S i=1 s∈Sa˜∈A0 i=1
(cid:34) (cid:35)
(cid:18) (cid:19)
(cid:88)√ n(s) (cid:88)
+π n − p(s) E[m (Z)|S = s] − π E[m (Z)|S = s]
a a a˜ a˜
n
s∈S a˜∈A0
(cid:34) (cid:35)
(cid:18) (cid:19)
(cid:88)√ n (s) (cid:88)
a
+ n − π p(s) E[m (Z)|S = s] − π E[m (Z)|S = s]
a a a˜ a˜
n(s)
s∈S a˜∈A0
(cid:33)
(cid:18) (cid:19)
(cid:88) (cid:88)√ n (s)
a˜
−π n − π p(s)E[m (Z)|S = s] : a ∈ A .
a a˜ a˜
n(s)
a˜∈A0 s∈S
Since the right-hand side is O (1), then Slutzky’s theorem and some simple manipulations shows that
P
(cid:18) (cid:18) (cid:19) (cid:19)
√ 1 1
n(θˆ∗ − θ(Q)) = diag : a ∈ A + ι ι(cid:48) L + o (1)
n π π |A| |A| n P
a 0
(cid:32) (cid:33) (cid:32) (cid:33)
(cid:88)(cid:16) (cid:17) (cid:88)
L¯(1)(s) L¯(1) L¯(2)(s)
= − (s) : a ∈ A + : a ∈ A
n,a n,0 n,a
s∈S s∈S
(cid:32) (cid:33)
(cid:88)
(L¯(3)(s) L¯(3)
+ − (s)) : a ∈ A + o (1) ,
n,a n,0 P
s∈S
where for (a,s) ∈ A × S,
(cid:34) (cid:35)
n
1 1 (cid:88)
L¯(1)(s) s}Y˜
≡ √ I{A = a,S = (a)
n,a i i i
π n
a
i=1
(cid:18) (cid:19)
√ n(s)
L¯(2)(s)
≡ n − p(s) E [m (Z) − m (Z)|S = s]
n,a a 0
n
(cid:34) (cid:35)
(cid:18) (cid:19)
√ n (s) p(s) (cid:88)
L¯(3)(s) a
≡ n − π E[m (Z)|S = s] − π E[m (Z)|S = s] .
n,a a a a˜ a˜
n(s) π
a
a˜∈A
By Lemma C.2 and some additional calculations, it follows that
 (cid:16) (cid:16) (cid:17) (cid:17) 
(cid:80) ¯(1) ¯(1)    
L n,a(s) − L n,0(s) : a ∈ A 0 V 0 0
s∈S Y˜
 (cid:16) (cid:17) 
 (cid:80) L¯(2) (s) : a ∈ A  →d N    0  ,  0 V 0    ,
 s∈S n,a     H 
 (cid:16) (cid:17) 
(cid:80) (L¯(3) (s) − L¯(3) (s)) : a ∈ A 0 0 0 V
s∈S n,a n,0 A
where V is as in (12) with π (s) = π for all (a,s) ∈ A × S, V is as in (11), and
Y˜ a a 0 H
(cid:32)
(cid:18)
V = (cid:88) p(s) ξ (s)ξ (s)Σ D(s) [a,a(cid:48)] − ξ (s)ξ (s)Σ D(s) [a,0]
A a a(cid:48) a 0
π π π π
a a(cid:48) a 0
s∈S
(cid:19) (cid:19)
Σ (s) Σ (s)
−ξ (s)ξ (s) D [a(cid:48),0] + ξ (s)ξ (s) D [0,0] : (a,a(cid:48)) ∈ A × A
a(cid:48) 0 0 0
π π π π
a(cid:48) 0 0 0
24

with
(cid:88)
ξ (s) ≡ E[m (Z )|S = s] − π E[m (Z |S = s)] .
a a i i a(cid:48) a(cid:48) i i
a(cid:48)∈A0
Importantly, to get V for the second term we used that (cid:80) p(s)E [m (Z) − m (Z)|S = s] = 0 for all a ∈ A.
H s∈S a 0
Appendix C Auxiliary Results
Lemma C.1. Suppose Q satisfies Assumption 2.1 and the treatment assignment mechanism satisfies Assumption
2.2. Define
(cid:32) (cid:33)
n
1 (cid:88)
L(1) ≡ √ I{A = a,S = s}Y˜ (a) : (a,s) ∈ A × S (C-36)
n i i i 0
n
i=1
(cid:18) (cid:18) (cid:19) (cid:19)
√ n(s)
L(2) ≡ n − p(s) : s ∈ S , (C-37)
n
n
and L = (L(1)(cid:48) ,L(2)(cid:48) )(cid:48). It follows that
n n n
(cid:32)(cid:32) (cid:33) (cid:32) (cid:33)(cid:33)
0 Σ 0
L →d N , 1 ,
n
0 0 Σ
2
where
(cid:16) (cid:17)
Σ = diag π (s)p(s)σ2 (s) : (a,s) ∈ A × S
1 a Y˜(a) 0
Σ = diag(p(s) : s ∈ S) − (p(s) : s ∈ S)(p(s) : s ∈ S)(cid:48) .
2
Proof. To prove our result, we first show that
(cid:110) (cid:111) (cid:110) (cid:111)
L(1),L(2) =d L∗(1),L(2) + o (1) ,
n n n n P
L∗(1) L∗(1) L(2) L∗(1) →d
for a random vector satisfying ⊥⊥ and N (0,Σ ). We then combine this result with the fact
n n n n 1
that L(2) →d N (0,Σ ), which follows from W(n) consisting of n i.i.d. observations and the CLT.
n 2
Under the assumption that W(n) is i.i.d. and Assumption 2.2.(a), the distribution of L(1) is the same as the
n
distribution of the same quantity where units are ordered first by strata s ∈ S and then ordered by treatment
assignment a ∈ A within strata. In order to exploit this observation, it is useful to introduce some further notation.
(cid:80)n (cid:80)n
Define N(s) ≡ I{S < s}, N (s) ≡ I{A < a,S = s}, F(s) ≡ P{S < s}, and F (s) ≡ P{A < a,S = s}
i=1 i a i=1 i i i a i i
for all (a,s) ∈ A × S. Furthermore, independently for each (a,s) ∈ A × S and independently of (A(n),S(n)), let
{Y˜s(a) Y˜
: 1 ≤ i ≤ n} be i.i.d. with marginal distribution equal to the distribution of (a)|S = s. With this notation,
i i i
define
 
nN(s) (cid:88)+N na+1(s)
(cid:32) (cid:33)
(cid:88)n
1 1
L˜(1) ≡ √ I{A = a,S = s}Y˜s(a) : (a,s) ∈ A × S = √ Y˜s(a) : (a,s) ∈ A × S .
n n i i i 0  n i 0 
i=1 i=nN(s)+Na(s)
+1
n
By construction, {L˜(1) |S(n),A(n)} =d {L(1) |S(n),A(n)} and so L˜(1) =d L(1) . Since L(2) is only a function of S(n), we
n n n n n
25

(cid:110) (cid:111) (cid:110) (cid:111)
L(1) ,L(2) =d L˜(1) ,L(2)
further have that . Next, define
n n n n
 
(cid:98)n(F(s)+F (s))(cid:99)
a+1
1 (cid:88)
L∗(1) ≡ √ Y˜s(a) : (a,s) ∈ A × S .
n  n i 0 
i=(cid:98)n(F(s)+Fa(s))(cid:99)+1
L∗(1) L(2)
Note that ⊥⊥ . Using similar partial sum arguments as those in Bugni et al. (2018, Lemma B.1), it follows
n n
that
(cid:98)n(F(s)+F (s))(cid:99)
a+1
1 (cid:88) (cid:16) (cid:17)
L∗(1)(s) = √ Y˜s(a) →d N 0,π (s)p(s)σ2 (s) ,
n,a i a Y˜(a)
n
i=(cid:98)n(F(s)+Fa(s))(cid:99)+1
for all (a,s) ∈ A × S, where we used that F (s) − F (s) = π (s)p(s). By the independence of the components, it
0 a+1 a a
L∗(1) →d
follows that N (0,Σ ). We conclude the proof by arguing that
n 1
L˜(1)(s) − L∗(1)(s) →P 0 ,
n,a n,a
for all (a,s) ∈ A × S, where
0
nN(s)+Na+1(s)
1 (cid:88)n
L˜(1)(s) Y˜s(a)
= √ .
n,a i
n
i=nN(s)+Na(s)
+1
n
This in turn follows from
(cid:18) (cid:19)
N(s) N (s)
a P
, → (F(s),F (s))
a
n n
for all (a,s) ∈ A × S and again invoking similar arguments to those in Bugni et al. (2018, Lemma B.1).
0
Lemma C.2. Suppose Q satisfies Assumption 2.1 and the treatment assignment mechanism satisfies Assumption
4.1. Define
(cid:32) (cid:33)
n
1 (cid:88)
L(1) ≡ √ I{A = a,S = s}Y˜ (a) : (a,s) ∈ A × S (C-38)
n i i i 0
n
i=1
(cid:18) (cid:18) (cid:19) (cid:19)
√ n(s)
L(2) ≡ n − p(s) : s ∈ S , (C-39)
n
n
(cid:18) (cid:18) (cid:19) (cid:19)
√ n (s)
L(3) ≡ n a − π : (a,s) ∈ A × S , (C-40)
n a 0
n(s)
and L = (L(1)(cid:48) ,L(2)(cid:48) ,L(3)(cid:48) )(cid:48). It follows that
n n n n
   
0 Σ 0 0
1
L →d N    0  ,  0 Σ 0    ,
n 2
   
0 0 0 Σ
3
where
(cid:16) (cid:17)
Σ = diag π (s)p(s)σ2 (s) : (a,s) ∈ A × S
1 a Y˜(a) 0
Σ = diag(p(s) : s ∈ S) − (p(s) : s ∈ S)(p(s) : s ∈ S)(cid:48)
2
Σ = diag(Σ (s)/p(s) : s ∈ S) .
3 D
26

Proof. To prove our result, we first show that
(cid:110) (cid:111) (cid:110) (cid:111)
L(1),L(2),L(3) =d L∗(1),L(2),L(3) + o (1) ,
n n n n n n P
L∗(1) L∗(1) (L(2) ,L(3) L∗(1) →d
for a random vector satisfying ⊥⊥ ) and N (0,Σ ). We then combine this result with
n n n n n 1
the fact that L(2) →d N (0,Σ ), which follows from W(n) consisting of n i.i.d. observations and the CLT, and the fact
n 2
that conditional on S(n), L(3) →d N(0,Σ ), which follows from Assumption 4.1. The proof of (C) follows from similar
n 3
arguments to those used in the proof of Lemma C.1 and so we omit them here.
Lemma C.3. Suppose Q satisfies Assumption 2.1 and the treatment assignment mechanism satisfies Assumption
2.2. Let
(cid:34) diag(n(s) : s ∈ S) (cid:80) J ⊗ (n (s) : a ∈ A)(cid:48) (cid:35)
C(cid:48) C = s∈S s a , (C-41)
n n (cid:80) J ⊗ (n (s) : a ∈ A) diag(n (s) : (a,s) ∈ A × S)
s∈S s a a
and
 (cid:16) (cid:17) 
(cid:80) (cid:80)n s}Y˜ (cid:80)
I{A = a,S = (a) + n (s)(E[m (Z)|S = s] + µ ) : s ∈ S
C(cid:48) nY n =  (cid:16)a∈ (cid:80)A n0 Ii {= A1 ai si (a)i (s)(Ea∈ [mA0 (Za +a Aa S(cid:17)  , (C-42)
}Y˜
= ,S = + n )|S = s] µ ) : (a,s) ∈ ×
i=1 i i i a a a
where Y ≡ (Y : 1 ≤ i ≤ n). It follows that
n i
1 (cid:34) diag(p(s) : s ∈ S) (cid:80) J ⊗ (π (s)p(s) : a ∈ A)(cid:48) (cid:35)
C(cid:48) C →P Σ ≡ s∈S s a ,
n n n C (cid:80) J ⊗ (π (s)p(s) : a ∈ A) diag(π (s)p(s) : (a,s) ∈ A × S)
s∈S s a a
and
 (cid:16) (cid:17) 
(cid:80)
p(s) π (s)(E[m (Z)|S = s] + µ ) : s ∈ S
1 a∈A0 a a a
C(cid:48) Y →P   .
n n n  (cid:16) (cid:17) 
p(s)π (s)(E[m (Z)|S = s] + µ ) : (a,s) ∈ A × S
a a a
In addition,
 (cid:16) (cid:17) (cid:16) (cid:17)(cid:48) 
diag 1 : s ∈ S (cid:80) J ⊗ −1 : a ∈ A
Σ−1 =  π0 (cid:16)(s)p(s) (cid:17) (cid:16) s∈S (cid:16) s π0(s)p(s) (cid:17) (cid:17)  .
C (cid:80) J ⊗ −1 : a ∈ A (cid:80) J ⊗ diag 1 : a ∈ A + 1 ι ι(cid:48)
s∈S s π0(s)p(s) s∈S s πa(s)p(s) π0(s)p(s) |A| |A|
Proof. The first result follows immediately from Assumption 2.2.(b) and the fact that n(s) →P p(s) and na(s) =
n n
na(s) n(s) →P π (s)p(s) for all (a,s) ∈ A × S. For the second result, consider the following argument,
a
n(s) n
(cid:34) (cid:35)
n
1 C(cid:48) Y = 1 (cid:88) (I{S i = s}Y i : s ∈ S)
n n
n n
(I{A = a,S = s}Y : (a,s) ∈ A × S)
i=1 i i i
 (cid:16) (cid:104) (cid:105) (cid:17) 
n (cid:80) I{A = a,S = s} Y˜ (a) + E [m (Z)|S = s] + µ : s ∈ S
1 (cid:88) a∈A0 i i i a i a
=  (cid:16) (cid:104) (cid:105) (cid:17) 
n ˜
I{A = a,S = s} Y (a) + E [m (Z)|S = s] + µ : (a,s) ∈ A × S
i=1 i i i a i a
 (cid:16) (cid:17) 
(cid:80)
p(s) π (s)(E [m (Z)|S = s] + µ ) : s ∈ S
a∈A0 a a a
=   + o P(1)
(p(s)π (s)(E [m (Z)|S = s] + µ ) : (a,s) ∈ A × S)
a a a
where we used 1 (cid:80)n I{A = a,S = s} = na(s) →P π (s)p(s), and 1 (cid:80)n I{A = a,S = s}Y˜ (a) →P 0 for all
n i=1 i i n a n i=1 i i i
(a,s) ∈ A × S. Finally, the last result follows from simple manipulations that we omit.
0
Lemma C.4. Suppose Q satisfies Assumption 2.1 and the treatment assignment mechanism satisfies Assumption
27

2.2. Let W = f((Y (a) : a ∈ A),S ) for some function f(·) satisfy E[|W |] < ∞. Then, for all a ∈ A ,
i i i i 0
n
1 (cid:88) (cid:88)
P
W I{A = a} → p(s)π (s)E[W ] . (C-43)
i i a i
n
i=1 s∈S
Proof. Fix a ∈ A . By arguing as in the proof of Lemma C.1, note that
0
(cid:88)n n (cid:88)a(s)
1 (cid:88) 1
W I{A = a} =d Ws ,
i i i
n n
i=1 s∈S i=1
where, independently for each s ∈ S and independently of (A(n),S(n)), {Ws : 1 ≤ i ≤ n} are i.i.d. with marginal
i
distribution equal to the distribution of W |S = s. In order to establish the desired result, it suffices to show that
i i
n (cid:88)a(s)
1
Ws →P p(s)π (s)E[Ws] . (C-44)
i a i
n
i=1
From Assumption 2.2.(b), na(s) →P p(s)π (s), so (C-44) follows from
a
n
n (cid:88)a(s)
1
Ws →P E[Ws] . (C-45)
i i
n (s)
a
i=1
To establish (C-45), use the almost sure representation theorem to construct n˜a(s) such that n˜a(s) =d na(s) and
n n n
n˜a(s) → p(s)π (s) a.s. Using the independence of (A(n),S(n)) and {Ws : 1 ≤ i ≤ n}, we see that for any (cid:15) > 0,
n a i
(cid:12) (cid:12) 
 (cid:12) (cid:12) n (cid:88)a(s) (cid:12) (cid:12)   (cid:12) n (cid:88)na n(s) (cid:12) 
(cid:12) 1 (cid:12)  (cid:12) 1 (cid:12) 
P (cid:12) Ws − E[Ws](cid:12) > (cid:15) = P (cid:12) Ws − E[Ws](cid:12) > (cid:15)
(cid:12)n a(s) i i (cid:12) (cid:12) (cid:12)nna(s) i i (cid:12)
 (cid:12) 
(cid:12) i=1 (cid:12)  (cid:12) n i=1 (cid:12) 
(cid:12) (cid:12) 
(cid:12) nn˜a(s) (cid:12)

(cid:12) 1 (cid:88)n (cid:12) 
= P (cid:12) Ws − E[Ws](cid:12) > (cid:15)
(cid:12) (cid:12)nn˜a(s) i i (cid:12)
(cid:12) 
 (cid:12) n i=1 (cid:12) 
 (cid:12) (cid:12) 
(cid:12) nn˜a(s) (cid:12)

(cid:12) 1 (cid:88)n (cid:12) (cid:12)n˜ (s)
= E P (cid:12) Ws − E[Ws](cid:12) > (cid:15)(cid:12) a 
 (cid:12) (cid:12)nn˜a(s) i i (cid:12) (cid:12) n 
(cid:12)
 (cid:12) n i=1 (cid:12) 
→ 0 ,
where the convergence follows from the dominated convergence theorem and
(cid:12) (cid:12) 
(cid:12) nn˜a(s) (cid:12)

(cid:12) 1 (cid:88)n (cid:12) (cid:12)n˜ (s)
P (cid:12) Ws − E[Ws](cid:12) > (cid:15)(cid:12) a → 0 a.s. . (C-46)
(cid:12) (cid:12)nn˜a(s) i i (cid:12) (cid:12) n
(cid:12) 
 (cid:12) n i=1 (cid:12) 
To see that the convergence (C-46) holds, note that the weak law of large numbers implies that
n
1 (cid:88)k
Ws →P E[Ws] (C-47)
i i
n
k
i=1
for any subsequence n → ∞ as k → ∞. Since nn˜a(s) → ∞ a.s., (C-46) follows from the independence of n˜a(s) and
k n n
{Ws : 1 ≤ i ≤ n} and (C-47).
i
Lemma C.5. Suppose Q satisfies Assumption 2.1 and the treatment assignment mechanism satisfies Assumption
28

(cid:16) (cid:17)(cid:48)
2.2. Let uˆ = Y −C γˆ and γˆ = (δˆ (s) : s ∈ S)(cid:48),(βˆ (s) : (a,s) ∈ A × S)(cid:48) , where C is as in (B.1), be the least
i i i n n n n,a i
squares residuals associated with the regression in (7). Then,
n
1 (cid:88) (cid:88)
uˆ2 →P p(s)π (s)σ2 (s)
i a Y˜(a)
n
i=1 (a,s)∈A0×S
n
1 (cid:88)
uˆ2I {A = a,S = s} →P p(s)π (s)σ2 (s)
i i i a Y˜(a)
n
i=1
n
1 (cid:88) (cid:88)
uˆ2I {S = s} →P p(s)π (s)σ2 (s)
i i a Y˜(a)
n
i=1 a∈A0
n
1 (cid:88) (cid:88)
uˆ2I {A = a} →P p(s)π (s)σ2 (s) .
i i a Y˜(a)
n
i=1 s∈S
˜
Proof. First note that, by definition of Y (a), we can write.
i
(cid:88)
˜
Y = I{A = a,S = s}[Y (a) + E[m (Z)|S = s] + µ ] .
i i i i a a
(a,s)∈A0×S
In addition, for γ = ((δ(s) : s ∈ S)(cid:48),(β (s) : (a,s) ∈ A × S)(cid:48))(cid:48)
a
(cid:88)
C γ = I{S = s}(E [m (Z)|S = s] + µ )
i i 0 0
s∈S
(cid:88)
+ I{A = a,S = s}[E[m (Z) − m (Z)|S = s] + θ ] .
i i a 0 a
(a,s)∈A×S
We can therefore write the error term u as
i
(cid:88)
˜
u = Y − C γ = I{A = a,S = s}Y (a) ,
i i i i i i
(a,s)∈A0×S
and its square as
(cid:88)
u2 = I{A = a,S = s}Y˜2(a) .
i i i i
(a,s)∈A0×S
By arguments similar to those in Bugni et al. (2018, Lemma B.8), it is enough to show the results with u2 in place of
i
uˆ2. Since E[u2] = p(s)π (s)σ2 (s), the results follow immediately by invoking Lemma C.4 repeatedly. We therefore
i i a Y˜(a)
omit the arguments here.
Lemma C.6. Suppose Q satisfies Assumption 2.1 and the treatment assignment mechanism satisfies Assumption
Vˆ∗
4.1. Let be the homoskedasticity-only estimator of the asymptotic variance for the regression in (18), defined as
ho
(cid:32) (cid:33)
n (cid:18) (cid:19)−1
1 (cid:88) 1
Vˆ∗ = uˆ2 R∗ C∗(cid:48)C∗ R∗(cid:48) , (C-48)
ho i n n
n n
i=1
where {uˆ : 1 ≤ i ≤ n} are the least squares residuals, C∗ is the matrix with ith row given by
i n
C∗ = [(I{S = s} : s ∈ S)(cid:48),(I{A = a} : a ∈ A)(cid:48)] ,
i i i
and R∗ is a matrix with |A| rows and |S| + |A| columns defined as R∗ = (cid:2)O,I (cid:3) , where O and I are defined in
|A| |A|
29

Table 8. Then.
 
(cid:20) (cid:18) (cid:19)(cid:21)
(cid:88) (cid:88) 1 1
Vˆ∗ →P  p(s)π aσ Y2 ˜(a)(s) + p(s)ς H2 (s) ι |A|ι(cid:48) + diag : a ∈ A
ho π |A| π
0 a
(a,s)∈A0×S s∈S
where
(cid:32) (cid:33)2
(cid:88) (cid:88)
ς2 (s) = π (E[m (Z )|S = s])2 − π E[m (Z )|S = s] .
H a a i a a i
a∈A0 a∈A0
Proof. The proof is similar to that of Theorem 3.2 and therefore omitted.
Lemma C.7. Suppose Q satisfies Assumption 2.1 and the treatment assignment mechanism satisfies Assumption 4.1.
Vˆ∗
Let be the heteroskedasticity-consistent estimator of the asymptotic variance for the regression in (18), defined as
he
(cid:34) (cid:35)
(cid:18)C∗(cid:48)C∗ (cid:19)−1 (cid:18)C∗(cid:48) diag({uˆ2}n )C∗ (cid:19)(cid:18)C∗(cid:48)C∗ (cid:19)−1
Vˆ∗ = R∗ n n n i i=1 n n n R∗(cid:48) , (C-49)
he
n n n
where {uˆ : 1 ≤ i ≤ n} are the ordinary least squares residuals, and C∗ and R∗ are defined as in Lemma C.6. Then.
i n
Vˆ∗ →P V∗ + V∗ ,
he 1 2
where
(cid:32) (cid:34) (cid:32) (cid:33)2(cid:35) (cid:33)
(cid:88) p(s) (cid:88)
V∗ = diag σ2 (s) + E[m (Z)|S = s] − π E[m (Z)|S = s] : a ∈ A
1 Y˜(a) a a˜ a˜
π
a
s∈S a˜∈A0
(cid:34) (cid:32) (cid:33)2(cid:35)
(cid:88) p(s) (cid:88)
V∗ = ι ι(cid:48) σ2 (s) + E[m (Z)|S = s] − π E[m (Z)|S = s] .
2 |A| |A| π Y˜(0) 0 a˜ a˜
0
s∈S a˜∈A0
Proof. The proof is similar to that of Theorem 3.2 and therefore omitted.
Appendix D Results on Local Power
Let {Q∗ : n ≥ 1} be a sequence of local alternatives to the null hypothesis in (4) that satisfies
n
√
n(Ψθ(Q∗) − c) → λ (D-50)
n
as n → ∞, for λ and c being r-dimensional column vectors and Ψ being a (r × |A|)-dimensional matrix such that
rank(Ψ) = r. Consider a test of the form
φ (X(n)) = I{T (X(n)) > χ2 } ,
n n r,1−α
where
T (X(n)) = n(Ψθˆ − c)(cid:48)(ΨVˆ Ψ(cid:48))−1(Ψθˆ − c) ,
n n n n
ˆ
θ is an estimator of θ(Q) satisfying
n
√
n(θˆ − θ(Q∗)) →d N(0,V) under Q∗ (D-51)
n n n
30

for some asymptotic variance V, Vˆ is a matrix intended to Studentize the test statistic that satisfies
n
Vˆ →P V under Q∗ (D-52)
n stud n
for some V , and χ2 is the 1−α quantile of a χ2 random variable with r degrees of freedom. The next theorem
stud r,1−α
summarizes our main result.
Theorem D.1. Let {Q∗ : n ≥ 1} be the sequence of local alternatives satisfying (D-50), θˆ be an estimator satisfying
n n
(D-51), and Vˆ be a random matrix satisfying (D-52). Assume that V and V are positive definite, that V −V
n stud stud
is positive semi-definite, and that rank(Ψ) = r. Then,
(cid:110) (cid:111)
lim E[φ (X(n))] = P (ξ + λ˜ )(cid:48)(ΨVΨ(cid:48))1/2(ΨV Ψ(cid:48))−1(ΨVΨ(cid:48))1/2(ξ + λ˜ ) > χ2 , (D-53)
n stud r,1−α
n→∞
under Q∗, where ξ ∼ N(0,I ) and λ˜ = (ΨVΨ(cid:48))−1/2λ. In addition, the following three statements follow under Q∗.
n r n
(a) Under the assumptions above,
(cid:110) (cid:111)
limsupE[φ (X(n))] ≤ P (ξ + λ˜ )(cid:48)(ξ + λ˜ ) > χ2 .
n r,1−α
n→∞
(b) If V = V , then
stud
(cid:110) (cid:111)
lim E[φ (X(n))] = P (ξ + λ˜ )(cid:48)(ξ + λ˜ ) > χ2 ≥ α ,
n r,1−α
n→∞
where the inequality is strict if and only if λ (cid:54)= 0.
(c) If φ1(X(n)) and φ2(X(n)) are two tests such that φ1(X(n)) is based on an estimator with V1 = V1 and φ2(X(n))
n n n stud n
is based on an estimator with V2 = V2 , then
stud
lim E[φ1(X(n))] ≥ lim E[φ2(X(n))] ,
n n
n→∞ n→∞
provided V2 − V1 is positive semi-definite. In addition, the inequality becomes strict if and only if λ (cid:54)= 0 and
V2 − V1 is positive definite.
Proof. Notice that
√ √ √
n(Ψθˆ − c) = n(Ψθˆ − Ψθ(Q∗)) + n(Ψθ(Q∗) − c) →d N(λ,ΨVΨ(cid:48)) under Q∗ .
n n n n n
By Slutsky’s theorem,
√ (cid:16) (cid:17)
(ΨVˆ Ψ(cid:48))−1/2 n(Ψθˆ − c) →d N (ΨV Ψ(cid:48))−1/2λ,(ΨV Ψ(cid:48))−1/2(ΨVΨ(cid:48))(ΨV Ψ(cid:48))−1/2
n n stud stud stud
∼ (ΨV Ψ(cid:48))−1/2(ΨVΨ(cid:48))1/2(ξ + λ˜ ) ,
stud
under Q∗, with ξ ∼ N(0,I ) and λ˜ = (ΨVΨ(cid:48))−1/2λ. From here we conclude that
n r
T (X(n)) →d (ξ + λ˜ )(cid:48)(ΨVΨ(cid:48))1/2(ΨV Ψ(cid:48))−1(ΨVΨ(cid:48))1/2(ξ + λ˜ ) ,
n stud
and (D-53) follows.
Part (a). This follows immediately from Lemma D.1.
31

Part (b). Note that
(cid:16)√ (cid:113) (cid:17)
P{(ξ + λ˜ )(cid:48)(ξ + λ˜ ) > χ2 } = Λ µ, χ2 , (D-54)
r,1−α r r,1−α
2
where Λ (a,b) is the Marcum-Q-function and µ ≡ λ˜(cid:48)λ˜ = λ(cid:48)(ΨVΨ(cid:48))−1λ ≥ 0. By the fact that Λ (a,b) is increasing
m m
√ (cid:113) (cid:113)
in a (see Temme (2014, p. 575) and (Sun and Baricz, 2008, Theorem 3.1)), Λ ( µ, χ2 ) ≥ Λ (0, χ2 ) = α,
r r
r,1−α r,1−α
2 2
with strict inequality if and only if µ > 0. Since V is positive definite and Ψ is full rank, ΨVΨ(cid:48) is positive definite
and, thus, non-singular. Then, µ > 0 if and only if λ (cid:54)= 0.
Part (c). We only show the strict inequality, as the weak inequality follows from weakening all the inequalities.
For d = 1,2, since Vd is positive definite and Ψ is full rank, ΨVdΨ(cid:48) is positive definite and, thus, non-singular. Since
V2 − V1 is positive definite and Ψ is full rank, ΨV2Ψ(cid:48) − ΨV1Ψ(cid:48) is positive definite and so (ΨV2Ψ(cid:48))−1 − (ΨV1Ψ(cid:48))−1
is negative definite. By this and the fact that λ (cid:54)= 0, we conclude that
µ2 − µ1 = λ(cid:48)(ΨV2Ψ(cid:48))−1λ − λ(cid:48)(ΨV1Ψ(cid:48))−1λ = λ(cid:48)((ΨV2Ψ(cid:48))−1 − (ΨV1Ψ(cid:48))−1)λ < 0 .
By (D-54) and the fact that Λ (a,b) is increasing in a, the result follows.
m
Lemma D.1. Suppose that V − V ∈ R|A|×|A| is negative semi-definite, V is non-singular, and rank(Ψ) = r.
stud stud
Then, (ΨV Ψ(cid:48))−1/2(ΨVΨ(cid:48))(ΨV Ψ(cid:48))−1/2 − I is negative semi-definite.
stud stud r
Proof. Since Ψ is full rank and V is non-singular, (ΨV Ψ(cid:48))1/2 is well defined and non-singular. Let a be an
stud stud
arbitrary r-dimensional column vector. We wish to show that
a(cid:48)((ΨV Ψ(cid:48))−1/2(ΨVΨ(cid:48))(ΨV Ψ(cid:48))−1/2 − I )a ≤ 0 . (D-55)
stud stud r
Let b = (ΨV Ψ(cid:48))−1/2a and note that (D-55) is equivalent to
stud
b(cid:48)(ΨV Ψ(cid:48))1/2((ΨV Ψ(cid:48))−1/2(ΨVΨ(cid:48))(ΨV Ψ(cid:48))−1/2 − I )(ΨV Ψ(cid:48))1/2b ≤ 0
stud stud stud r stud
which, in turn, is equivalent to (Ψ(cid:48)b)(cid:48)(V − V )(Ψ(cid:48)b) ≤ 0. This last inequality holds because V − V is negative
stud stud
semi-definite.
References
Bai, Y. (2018). On optimal stratification in randomized controlled trials. Manuscript. The University of
Chicago.
Berry, J., Karlan, D. S. and Pradhan, M. (2018). The impact of financial education for youth in
Ghana. World Development, 102 71 – 89.
Bruhn, M. and McKenzie, D. (2009). In pursuit of balance: Randomization in practice in development
field experiments. American Economic Journal: Applied Economics, 1 200–232.
Bugni, F. A., Canay, I. A. and Shaikh, A. M. (2018). Inference under covariate-adaptive randomization.
Journal of the American Statistical Association, forthcoming.
Callen, M., Gulzar, S., Hasanain, A., Khan, Y. and Rezaee, A. (2019). Personalities and public
sector performance: Evidence from a health experiment in Pakistan. NBER Working Paper No. 21180.
32

Chong, A., Cohen, I., Field, E., Nakasone, E. and Torero, M. (2016). Iron deficiency and schooling
attainment in peru. American Economic Journal: Applied Economics, 8 222–255.
Dizon-Ross, R. (2018). Parents’ beliefs about their children’s academic ability: implications for educational
investments. Manuscript, University of Chicago Booth School of Business.
Duflo, E., Dupas, P. and Kremer, M. (2015). Education, HIV, and early fertility: Experimental evidence
from Kenya. American Economics Review, 105 2757–2797.
Duflo, E., Glennerster, R. and Kremer, M. (2007). Using randomization in development economics
research: A toolkit. Handbook of development economics, 4 3895–3962.
Efron, B. (1971). Forcing a sequential experiment to be balanced. Biometrika, 58 403–417.
Hu, Y. and Hu, F. (2012). Asymptotic properties of covariate-adaptive randomization. Annals of Statistics,
forthcoming.
Imbens, G. W. and Rubin, D. B. (2015). Causal Inference for Statistics, Social, and Biomedical Sciences:
An Introduction. Cambridge University Press.
Kernan, W. N., Viscoli, C. M., Makuch, R. W., Brass, L. M. and Horwitz, R. I. (1999). Stratified
randomization for clinical trials. Journal of clinical epidemiology, 52 19–26.
Rosenberger, W. F. and Lachin, J. M. (2016). Randomization in clinical trials: theory and practice.
2nd ed. John Wiley & Sons.
´
Sun, Y. and Baricz, A. (2008). Inequalities for the generalized marcum q-function. Applied Mathematics
and Computation, 203 134–141.
Tabord-Meehan, M. (2018). Stratification trees for adaptive randomization in randomized controlled
trials. Manuscript. Northwestern University.
Temme, N. M. (2014). Asymptotic methods for integrals, vol. 11. World Scientific.
Wei, L., Smythe, R. and Smith, R. (1986). K-treatment comparisons with restricted randomization rules
in clinical trials. The Annals of Statistics 265–274.
Zelen, M. (1974). The randomization and stratification of patients to clinical trials. Journal of chronic
diseases, 27 365–375.
33