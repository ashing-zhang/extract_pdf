Expectation Propagation performs a smoothed
gradient descent
6102 ceD 51  ]LM.tats[  1v35050.2161:viXra
Guillaume Dehaene
Ecole Polytechnique Federale de Lausanne
guillaume.dehaene@gmail.com
Abstract
Bayesian inference is a popular method to build learning algorithms but it is ham-
pered by the fact that its key object, the posterior probability distribution, is often
uncomputable. Expectation Propagation (EP) (Minka [2001]) is a popular algo-
rithm that solves this issue by computing a parametric approximation (e.g: Gaus-
sian) to the density of the posterior. However, while it is known empirically to
quickly compute fine approximations, EP is extremely poorly understood which
prevents it from being adopted by a larger fraction of the community.
The object of the present article is to shed intuitive light on EP, by relating it
to other better understood methods. More precisely, we link it to using gradi-
ent descent to compute the Laplace approximation of a target probability distri-
bution. We show that EP is exactly equivalent to performing gradient descent
on a smoothed energy landscape: i.e: the original energy landscape convoluted
with some smoothing kernel. This also relates EP to algorithms that compute the
Gaussian approximationwhich minimizes the reverse KL divergence to the target
distribution, a link that has been conjectured before but has not been proved rig-
orously yet. These results can help practitioners to get a better feel for how EP
works, as well as lead to other new results on this important method.
Thisarticlewas submittedandacceptedtotheAdvancesinApproximateBayesian
Inference NIPS 2016 workshop (www.approximateinference.org).
Throughout this article, we consider the task of approximating a probability density over a one-
dimensional space:
p(θ) = exp( ψ(θ)) (1)
−
′′
where we will assume for simplicity that ψ (θ) is convex so that ψ (θ) > 0.
We will present various algorithms to compute Gaussian approximations of p. We will first seek to
compute the “Laplace approximation”. We then turn to computing the Gaussian which minimizes
the reverse KL divergence to p(θ). Finally, we consider using Expectation Propagation (EP). These
three approximations can be computed by similar algorithms: either by exact gradient descent or
by variants to it which we refer to as “smoothed gradient descent”. This new perspective on EP is
useful in giving practitioners a more intuitive framework than current justifications of EP, but it can
also be used to derive new theoretical results on the method. For example, we show that, in various
asymptotes, the limit behavior of EP is simple.
To keep the presentation of these ideas sharp and light, we do not provethe results we present in this
document. All proofs, which are stated in the high-dimensional case, can be found in the appendix.
1

1 The Laplace approximation
If we want to compute a Gaussian approximation of p(θ), a natural idea consists in performing a
Taylor expansion to second order of ψ (θ). It seems natural to perform the expansion around the
global maximum θ⋆ of the target p(θ) (which is unique because of the convexity of ψ (θ)). This
yields the “Laplace” approximation of the target (Murphy [2012] 8.4.1):
(θ⋆ θ)2
′′
p(θ) p(θ⋆)exp ψ (θ⋆) − (2)
≈ − 2
  !
This requires us to compute the global maximum θ⋆ (which is unique under our convexity assump-
tion). A nice solution for this is Newton’s method (NT), which corresponds to gradient descent of
ψ (θ) with a Hessian correction. This method is actually extremely closely linked to the “Laplace”
approximation, since we can derive it as iterating over Gaussian approximations. Indeed, consider
the following method:
Start from some initial Gaussian approximation q(0) (θ) to p(θ), with mean µ .
0
•
Then loop until convergence:
•
1. Compute the mean µ(t) of the current approximation q(t) (θ).
2. Constructthe newapproximationusing the seconddegreeexpansionof ψ aroundµ(t):
2
θ µ(t)
′ ′′
q(t+1) (θ) exp ψ µ(t) θ µ(t) ψ µ(t) − (3)
∝ − − − 2
  (cid:0) (cid:1) !
(cid:16) (cid:17)(cid:16) (cid:17) (cid:16) (cid:17)
It is straightforward to check that the dynamics of µ(t) in this algorithm match those in the classical
NT algorithm. The fixed-point of the Gaussian-iterating algorithm is the Laplace approximations of
the target p(θ).
Gradient descent is fairly easy to understand from an intuitive point of view. It corresponds roughly
to the dynamicsofa ball which we droponsome complicatedenergylandscapeψ(θ) andfalls down
along the valleys of the landscape until it reaches some local minimum.
In practice, the Laplace approximation does not provide a very good approximation of the target
p(θ). Intuitively, this is because it depends on the value of ψ at a single point θ⋆ so it naturally fails
at providing a global account of the target distribution.
2 Smoothing the gradient minimizes the reverse KL divergence
In order to provide a Gaussian approximation that gives a more global fit to the target distribution,
′ ′′
why not replace the point estimates ψ µ(t) and ψ µ(t) by averages over a large region of
θ-space? We could use many densities for this, but it seems natural to use the current Gaussian
(cid:0) (cid:1) (cid:0) (cid:1)
approximation q(t) (θ) which is indeed centered at µ(t).
We can thus construct a “smoothed Newton method” by replacing eq. (3) with:
2
θ˜ µ(t)
q(t+1) θ˜ exp E ψ′ (θ) θ˜ µ(t) E ψ′′ (θ) − (4)
∝  − q(t) − − q(t) (cid:16) 2 (cid:17) 
(cid:16) (cid:17) h i(cid:16) (cid:17) h i
 
 
This iteration has further interesting properties. First of all, the fixed-point of this iteration is unique
under our assumption that ψ (θ) is convex (Challis and Barber [2011]). Furthermore, even when
ψ (θ) is not convex, the ensemble of all fixed-points of the iteration is also the ensemble of extrema
of the reverse Kullback-Leibler divergence on the space of Gaussians:
q (θ)
KL(q,p) = E log (5)
q
p(θ)
(cid:18) (cid:19)
2

In other words, the iterative algorithmwe have definedcomputesa Gaussian Variational Bayes (VB)
approximation of p(θ) (Hoffman et al. [2013]). This link between gradient descent and Variational
Bayes was originally derived by Opper and Archambeau [2009].
Critically for the rest of this article, the computation of the expected value of the second derivative
can be rewritten:
ψ′′ −1 ψ′
E (θ) = var E (θ) θ µ(t) (6)
q(t) q(t) q(t)
−
This equality is found by inhtegratioin by(cid:2) parts a(cid:3)nd is onlhy true f(cid:16)or a Gaus(cid:17)siian distribution. When
we consider non-Gaussian kernels in the following sections, we will adapt the updating equation (4)
using this second form for the quadratic term.
3 Hybrid smoothing minimizes the alpha-divergence
It might seem weird to use a Gaussian smoothing: couldn’t we use something that is closer to the
target distribution? We will do so by geometrically mixing the target and the current Gaussian
approximation, thus building a “hybrid” distribution. For some 0 < α < 1, construct the α-hybrid
(t)
(with Z the normalizing constant):
α
−1 α
h(t) (θ) = Z(t) q(t) (θ) (p(θ))1−α (7)
α α
(cid:16) (cid:17) (cid:16) (cid:17)
whichwe thenuse as thesmoothingkernelinsteadofq(t) (θ). We also changethecenteringpointfor
the approximation: the VB update, eq. (4), uses the mean of the current Gaussian approximation;in
our new update, we will use the mean of the hybrid distribution instead. The update corresponding
to the α-hybrid is then, noting µ = E [θ] and v = var :
h (t) h (t)
hα hα
2
˜
θ µ
h
q(t+1) θ˜ exp E ψ′ (θ) θ˜ µ v−1E ψ′ (θ)(θ µ ) − (8)
∝  − h( αt) − h − h h( αt) − h (cid:16) 2 (cid:17) 
(cid:16) (cid:17) h i(cid:16) (cid:17) h i
 
 
Once again, this corresponds to both a smoothed Newton’s method (by construction)but also, much
more surprisingly, to an algorithm that minimizes a specific divergence. Indeed, all fixed-points of
the α-hybrid-smoothing iteration eq. (8) are also extrema of the α-divergence (which represents a
smooth interpolation between the reverse KL-divergence at α = 1 and the forward KL-divergence
KL(p,q) at α = 0; Minka [2005]).
4 Classical Expectation Propagation is a smoothed gradient method
In this article, we have shown that we can find extrema of all α-divergences and, critically, of
the reverse KL-divergence by performing a form of smoothed gradient descent (with a Hessian
correction). This might shed some light on these methods and help further theoretical investigation
ofthese methods. However,themaininterest ofthis approachconsists inusingthis ideaofsmoothed
gradient to give a justification of Expectation Propagation (EP, Minka [2001]) which is much more
intuitively satisfying than current derivations of this method (which we will assume that the reader
is familiar with due to space constraints; see Minka [2001], Seeger [2005], Bishop [2007]).
In order to apply EP, we have to assume that the target distribution factorizes into “simple” factor
functions f (θ):
i
n
p(θ) = f (θ) (9)
i
i=1
Y
We will note φ (θ) = log(f (θ)), thus the energy landscape for the gradient descent ψ (θ) has
i i
−
been split into n additive components:
ψ (θ) = φ (θ) (10)
i
i
X
3

All algorithms we have presented so far compute a single Gaussian approximation for the whole
target distribution. This next algorithm will compute for each time-step a “local” Gaussian approx-
(t)
imation for each single factor q f . We can then compute a global approximation of the target
i i
≈
by combining them multiplicatively:
n
(t) (t)
q = q p (11)
global i ≈
i=1
Y
(t)
Each local Gaussian approximations g is updated by a smoothed gradient descent on the corre-
i
sponding local energy landscape φ . For the smoothing, we construct once more a hybrid distribu-
i
tion. The hybrid for the update of the ith approximation is formed by multiplying the true factor f
i
(t)
and the current local Gaussian approximation of all other factors g . I.e:
i
j6=i
(cid:16) (cid:17)
−1
(t) (t) (t)
h (θ) = Z f (θ) g (θ) (12)
i i i j
(cid:16) (cid:17) Yj6=i
The new Gaussian approximation of the factor f is then given by, noting µ = E [θ ] and
i hi h(t) h
v = var : i
hi h(t)
i
2
(θ µ )
g(t+1) φ′ v−1 φ′ hi
(θ) exp E (θ ) (θ µ ) E (θ )(θ µ ) −
i ∝  − h( it) i h − hi − hi h( it) i h h − hi 2
!
h i h i
(13)
This iterating scheme isexactly the same asthe classical EP update presented by Minka [2001].
We have thus rephrased the EP iteration from its original computationally-convenient but cryptic
form into a smoothed gradient descent which is much more instructive for our intuitive understand-
ing of EP.
5 Why this matters
5.1 Asymptotic behavior
This new perspective on VB, α-divergenceminimization and EP can be used to derive several inter-
esting results on the asymptotic behavior of these methods in a painless manner. Indeed, as we have
shown, these algorithms all correspond to a smoothed gradient descent. Thus, in all limits in which
the smoothing kernel is sufficiently concentrated,the dynamics of these algorithms asymptote to the
dynamics of Newton’s method.
Furthermore,in all limits in which the smoothingkernel of one methodasymptotes to the smoothing
kernel of a second, their dynamics asymptote to one another. A trivial example of this is the fact
that the dynamics of α-hybrid smoothing (eq. (7)) asymptote to the dynamics of the Gaussian
smoothing (eq. (4)) in the limit α 1 (thus giving a much more intuitive understanding of the
→
result of Dehaene and Barthelmé [2016]). A much more interesting example consists in proving a
“folk theorem” on EP asserting that, in the limit of a large number of sites with each one having a
negligible contribution to the ensemble, EP corresponds to minimizing the reverse KL divergence
(eq. (5)). The present work shows painlessly that this is true in any limit in which all EP hybrids h
i
(eq. (12)) asymptote to the current global approximation q = qih (eq. (11)).
global i
fi
5.2 Intuitive understanding
In this article, we have unified several algorithms as performing smoothed gradient descent. While
this might provide the path towards more useful algorithms for minimizing several divergence mea-
sures, we believe that the most useful contribution of this work is that it gives practitioners a more
intuitive understanding of these algorithms. Indeed, gradient descent is both a fairly intuitive algo-
rithm, matching our physical intuitions of an object sliding around on some energy landscape, and
4

one which has been extremely extensively researched. The addition of smoothing complicates this
picture, but only slightly. We thus hope that our results can help promote these methods by shining
a new light on them. This contribution is probably the most helpful for EP, given that our itera-
tion (eq. (13)) and classical EP (Minka [2001]) have the exact same dynamics, and that current
presentations of EP give no intuitions about how the algorithm operates.
References
Christopher M. Bishop. Pattern Recognition and Machine Learning (In-
formation Science and Statistics). Springer, 1st ed. 2006. corr. 2nd
printing 2011 edition, October 2007. ISBN 0387310738. URL
http://www.amazon.com/exec/obidos/redirect?tag=citeulike07-20&path=ASIN/0387310738.
Edward Challis and David Barber. Concave gaussian variational approximations for inference in
large-scale bayesian linear models. In AISTATS, pages 199–207, 2011.
Guillaume Dehaene and Simon Barthelmé. Expectation propagation in the large-data limit. arXiv
preprint arXiv:1503.08060,2016.
Guillaume P Dehaene and Simon Barthelmé. Bounding errors of Expectation-Propagation. In
C. Cortes, N. D. Lawrence, D. D. Lee, M. Sugiyama, and R. Garnett, editors, Advances in
Neural Information Processing Systems 28, pages 244–252. Curran Associates, Inc., 2015. URL
http://papers.nips.cc/paper/5912-bounding-errors-of-expectation-propagation.pdf.
Matthew D Hoffman, David M Blei, Chong Wang, and John William Paisley. Stochastic variational
inference. Journal of Machine Learning Research, 14(1):1303–1347,2013.
T. Minka. Divergence Measures and Message Passing. Technical report, 2005. URL
http://research.microsoft.com/en-us/um/people/minka/papers/message-passing/minka-diver
Thomas P. Minka. Expectation Propagation for approximate Bayesian inference. In UAI ’01: Pro-
ceedings of the 17th Conference in Uncertainty in Artificial Intelligence, pages 362–369, San
Francisco, CA, USA, 2001. Morgan Kaufmann Publishers Inc. ISBN 1-55860-800-1. URL
http://portal.acm.org/citation.cfm?id=720257.
Kevin P. Murphy. Machine Learning: A Probabilistic Perspective. The MIT Press, 2012. ISBN
0262018020,9780262018029.
Manfred Opper and Cédric Archambeau. The variational gaussian approximation revisited. Neural
computation, 21(3):786–792,2009.
K. B. Petersen and M. S. Pedersen. The matrix cookbook, nov 2012. URL
http://www2.imm.dtu.dk/pubdb/p.php?3274. Version 20121115.
M. Seeger. Expectation Propagation for Exponential Families. Technical report, 2005. URL
http://people.mmci.uni-saarland.de/~{}mseeger/papers/epexpfam.pdf.
5

Appendix
In this appendix, we will present all of the technical results underlying our main text, which was
light on details so as to remain compact.
Throughout this document, we will present various methods to compute a Gaussian approximation
of a multivariate target distribution:
p(θ) = exp( ψ(θ)) (14)
−
We will note d the dimensionality of the space. All vectors will be represented by bold letters (e.g:
θ,µ) while matrices are bold capitalized letters (e.g: S,B).
In contexts where it matters to distinguish the inner and outer-product between vectors, we use the
physicists Bra-Ket notation which makes it obvious whether a given vector should be considered as
a (1 d) matrix (in which it is called a “Bra” θ ) or a (d 1) matrix (in which case it is called a
∗ h | ∗
d
“Ket” µ ). In this notation, scalar products are represented as, for example: θ µ = θ µ .
| i h || i i=1 i i
A scalar product weighted by some matrix B is represented using: θ B µ = θ µ B .
h | | i i, Pj i j i,j
Outer-products are noted as θ µ (which corresponds to the conventional notation θµT) which
| ih | P
gives a matrix: ( θ µ ) = θ µ .
| ih | i,j i j
Finally, for a multivariate function such as p(θ), we note p(θ) the gradient, i.e: the vector of
θ
∇
the derivatives against each componentof the variable. We note Hp(θ) the “Hessian” matrix of the
second derivatives of the function.
A The relationship between Variational Bayes and smoothed gradient
descent
In this first section, we show that we can minimize the reverse KL divergence between a Gaussian
approximation and the target distribution by performing smoothed gradient descent.
A.1 The Gaussian Variational Bayes approximation
First, let us consider computinga Gaussian approximationwhich minimizes the “reverse”KL diver-
gence to the target. Noting the space of all Gaussians, this Gaussian Variational Bayes approxi-
G
mation is defined as:
q (θ) = argmin (q,p) (15)
VB q∈G
q (θ)
= argmin q(θ)log (16)
q∈G p(θ)
Z (cid:20) (cid:21)
Let us now rewrite the objective function. The most common parameterization of a Gaussian distri-
bution is via its mean and its covariance matrix. However, an alternative parameterization which is
more relevant in this case is using the “matrix square root” of the covariance (which, in 1D, would
Σ
correspond to the standard-deviation). Noting the covariance matrix, this “matrix square root” is
a solution of:
SST = Σ (17)
This parameterizationis useful as it enables us to write any Gaussian g with parameters (µ,S) as
µ,S
a translated and shifted versionof a Gaussian with mean 0 and covariancethe identity matrix (which
we note g ):
0
g = Sg + µ (18)
µ,S 0
However,note that this parameterizationof the space of Gaussians is degenerate: the same Gaussian
density corresponds to multiple values of S.
6

Using this parameterization,it is easy to write down the reverse KL divergenceas an expected value
under the random variable g :
0
q (θ)
KL(q ,p) = q(θ)log (19)
µ,S
p(θ)
Z (cid:20) (cid:21)
= q(θ)ψ (θ) + q (θ)log(q (θ)) (20)
Z Z
d/2
= E [ψ (Sg + µ)] log (2π) S (21)
0
− | |
(cid:16) (cid:17)
where S is the determinant of the S matrix.
| |
Computing the gradient of the KL divergence against this parameterization of the Gaussians
is then a straightforward exercise in vectorial and matrix derivatives (cf: the matrix cookbook
Petersen and Pedersen [2012]) which yields:
KL(q ,p) = E [ ψ (Sg + µ)] (22)
µ µ,S 0
∇ ∇
= E ψ g (23)
µ,S
∇
KL(q ,p) = E [ ψ (Sg + µ) g ] S−1 (24)
S µ,S (cid:2) (cid:0) 0 (cid:1)(cid:3) 0
∇ |∇ ih | −
We then integrate by parts eq. (24) (or, alternatively, we use Stein’s lemma) to obtain an equation
with the second derivative of ψ:
KL(q ,p) = E Hψ (Sg + µ)ST S−1 (25)
S µ,S 0
∇ −
= E h Hψ g ST i S−1 (26)
µ,S
−
(cid:2) (cid:0) (cid:1)(cid:3)
This gives us a simple characterization of all critical points of the function µ,S KL: they obey
→
the following equations:
E ψ g = −→0 (27)
µ,S
∇
−1
E (cid:2) Hψ (cid:0) g (cid:1)(cid:3) = S−1 ST (28)
µ,S
Σ−1(cid:16) (cid:17)
(cid:2) (cid:0) (cid:1)(cid:3) = (29)
These conditions for the Gaussian Variational Bayes approximation of a target distribution were
originally derived by Opper and Archambeau [2009]. They express that a Gaussian VB approxi-
mation must be such that the expected value of the log-gradient of the target distribution is 0 in all
dimensions and that the inverse-variance of the approximation matches the expected value of the
log-Hessian of the target distribution.
These conditions are quite naturally linked to the smoothed gradient descent algorithm which we
now introduce.
A.2 Smoothed gradient descent
First, let us present the smoothed gradient descent (with a Hessian correction) in detail. It corre-
sponds to the following algorithm.
Initialize the algorithm with any Gaussian approximation q(0) of the target distribution
•
Then loop until convergence:
•
1. Compute the mean as well as the expected log-gradient and expected log-Hessian of
the target distribution under the current Gaussian approximation q(t) (θ):
µ = E [θ] (30)
q(t)
E = E [ ψ (θ)] (31)
q(t)
∇ ∇
EH = E [Hψ (θ)] (32)
q(t)
7

2. Compute the new Gaussian approximation using the following formula:
1 EH
q(t+1) = exp E (θ µ) (θ µ) (θ µ) (33)
Z −h ∇|| − i − h − | 2 | − i
(cid:18) (cid:19)
where Z is a normalizing constant.
We refer to this algorithm as “smoothed gradient descent” since this update exactly matches the
update of gradient descent with a Hessian correction starting from µ = E [θ] on the energy
q(t)
landscape given by a smoothing of ψ with a Gaussian kernel q(t) (in equations: θ ψ q(t) (θ)
→ ⊗
is the new energy landscape).
(cid:0) (cid:1)
This algorithm does not correspond to performing gradient descent on the space Gaussians parame-
terized by (µ,S) of the reverseKL divergence,but it is closely related as these two algorithms share
their fixed-points. Indeed, considering eq. (33) shows that this algorithm is stable if and only if:
E = 0 so that the mean of the Gaussian approximation does not change.
• ∇
−1
EH = (Cov ) so that the variance of the distribution does not change either.
q
•
These stability conditions exactly match the characterization of critical points of µ,S KL (eqs.
→
(27) and (29)). Thus, this smoothed gradient descent algorithm represents an iterative scheme to
minimize the reverse KL divergence over the space of Gaussian distributions.
α
B Minimizing the -divergence
In this second section, we introduce the α-divergence, which interpolates between the forward KL
divergenceandthereverseKLdivergence. We showthatwe canminimizetheα-divergencebetween
a Gaussian approximation and the target distribution by performing a smoothed gradient descent
which uses an hybrid distribution as the smoothing kernel.
B.1 Defining the α-divergence
Consider two probabilitydensities (p(θ),q (θ)). The α-divergencebetween these two distributions
is given, for α / 0,1 :
∈ { }
1
1−α α
D (p,q) = 1 (p(θ)) (q (θ)) dθ (34)
α
α(1 α) −
− (cid:20) Z (cid:21)
A few values of α correspond to interesting measures of the differences between p and q (Minka
[2005]; note that we are not using the exact same definition of the α-divergence).
For α = 1/2, we recover the squared Hellinger distance:
•
D = 4 1 √pq (35)
1/2
−
(cid:20) Z (cid:21)
2
= 2 (√p √q) (36)
−
Z
For α = 1 and α = 2, we recover interesting values:
• −
1 p2
D = 1 (37)
−1
−2 − q
(cid:20) Z (cid:21)
1 p2
= + q 2 p (38)
2 q −
(cid:20)Z Z Z (cid:21)
2
1 (p q)
= − (39)
2 q
Z
2
1 (p q)
D = − (40)
2
2 p
Z
This corresponds to the two χ2 distances between the two probability distributions
8

Finally, and most interesting, in the limits α 0 and α 1, we recover the direct and
• → →
reverse KL divergences:
−α
1 p
D (p,q) = 1 p (41)
α
α(1 α) − q
" #
− Z (cid:18) (cid:19)
1 p
= 1 pexp αlog (42)
α(1 α) − − q
− (cid:20) Z (cid:18) (cid:19)(cid:21)
1 p
1 p 1 + αlog + α2 ... (43)
≈ α(1 α) − − q
− (cid:20) Z (cid:18) (cid:19)(cid:21)
1 p
plog + α... (44)
≈ 1 α q
− Z
p
lim D (p,q) = plog (45)
α
α→0 q
Z
= KL(p,q) (46)
lim D (p,q) = KL(q,p) (47)
α
α→1
This is the result we are most interested in, since it justifies our earlier remark that the
α-divergences interpolate between the forward and reverse KL divergences.
B.2 Minimizing the α-divergence over the space of Gaussians
Once more, we will parametrize Gaussians using the mean and the square-root matrix of the co-
variance S. We can then smartly rewrite our objective function, the α-divergence, by performing a
changeof variable θ˜ = S−1 (θ µ). In this referenceframe, the Gaussian density is constant. This
−
gives:
˜
1 1−α α dθ
˜ ˜
D (p,q ) = 1 p Sθ + µ q θ (48)
α µ,S α(1 α) " − 0 S 1−α #
− Z (cid:16) (cid:17) (cid:16) (cid:17) | |
We can then compute the gradients:
˜
1 1−α α dθ
˜ ˜ ˜
D = (1 α) ψ Sθ + µ p Sθ + µ q θ (49)
∇µ α α(1 α) − ∇ 0 S 1−α
− Z (cid:16) (cid:17) (cid:16) (cid:17) (cid:16) (cid:17) | |
By now performing the reverse change of variable and returning to θ, we get that the gradient cor-
responds to an expected value under the hybrid distribution: h (θ) = Z−1 (p(θ))1−α (q (θ))α :
α α µ,S
1
1−α α
D = ψ (θ)p(θ) q (θ) dθ (50)
µ α µ,S
∇ α ∇
Z
1−α α
(p(θ)) (q (θ)) dθ
µ,S
= E ( ψ (θ)) (51)
(cid:16) R α (cid:17) hα ∇
Similarly, the gradient to S gives another expected value under h :
α
˜
1 1−α α dθ
˜ ˜ ˜ ˜
D = θ ψ Sθ + µ p Sθ + µ q θ
∇S α α ∇ 0 S 1−α
Z
(cid:12) ED (cid:16) (cid:17)(cid:12) (cid:16) (cid:17) (cid:16) (cid:17) | |
1 (cid:12) 1 (cid:12) 1−α α
S(cid:12) −1 p Sθ˜(cid:12) + µ q θ˜ dθ˜ (52)
− α S 1−α 0
Z
| | (cid:16) (cid:17) (cid:16) (cid:17)
1
S−1 p(θ)1−α (θ)α
= θ µ ψ (θ) q dθ
µ,S
α | − ih∇ |
Z
1
S−1 (p(θ))1−α (θ))α
(q dθ (53)
µ,S
− α
(cid:18)Z (cid:19)
1−α α
(p(θ)) (q (θ)) dθ
µ,S
= S−1 [E ( θ µ ψ (θ) ) I ] (54)
(cid:16) R α (cid:17) hα | − ih∇ | − d∗d
9

Thus the critical points of the function µ,S D (p,q ) obey the following two equations:
α µ,S
→
E ( ψ (θ)) = 0 (55)
hα
∇
E ( θ µ ψ (θ) ) = I (56)
hα d∗d
| − ih∇ |
Furthermore, for any probability distribution (with fast decrease in the tails) by integration by parts
we have that (illustrating the result with p(θ) exp( ψ(θ))) v:
∝ − ∀
E ( ψ (θ)) = 0 (57)
p
∇
E ( θ v ψ (θ) ) = I (58)
p d∗d
| − ih∇ |
By applying these two equations to the hybrid distribution at a critical point h = p1−α (q )α
⋆ µ⋆,S⋆
with the two eqs. (55) and (56), we get that at a critical point, the mean and variance of the hybrid
Σ T
and of the Gaussian approximation are identical. Noting = S (S ) the covariance of the
⋆ ⋆ ⋆
Gaussian distribution at the critical point:
αΣ−1
0 = E (1 α) ψ (θ) + (θ µ ) (59)
h⋆ ⋆ ⋆
− ∇ −
αΣ−1
= 0 + E (θ µ ) (60)
(cid:0)h⋆ ⋆ ⋆ (cid:1)
−
αΣ−1
= (E (θ) µ ) (61)
⋆ (cid:0)h⋆ ⋆ (cid:1)
−
E (θ) = µ (62)
h⋆ ⋆
And (using v = µ in eq. 58):
⋆
αΣ−1
I = E θ µ (1 α) ψ (θ) + (θ µ ) (63)
d∗d h⋆ ⋆ ⋆ ⋆
| − i − ∇ −
Σ−1
= (1 α)E ( θ µ ψ (θ) ) + αE θ µ θ µ (64)
(cid:0) h⋆ (cid:10)(cid:0) ⋆ h⋆ ⋆ (cid:1)(cid:12)(cid:1) ⋆ ⋆
− | − ih∇ | | − ih(cid:12) − |
Σ−1
= (1 α)I + αE θ µ θ µ (65)
d∗d h⋆ ⋆ ⋆ (cid:0)⋆ (cid:1)
− | − ih − |
Σ−1
αI = αE θ µ θ µ (66)
d∗d h⋆ ⋆ (cid:0) ⋆ ⋆ (cid:1)
| − ih − |
(θ)Σ−1
I = Cov (67)
d∗d h⋆(cid:0) ⋆ (cid:1)
Σ
= Cov (θ) (68)
⋆ h⋆
These last two points were already highlighted by Minka [2005].
Finally, we get a slight variant of the equations characterizing the critical points by combining eqs.
(56) and (68):
)−1 Σ−1
(Cov (θ)E ( θ µ ψ (θ) ) = (69)
h⋆ h⋆ ⋆ ⋆
| − ih∇ |
B.3 A smoothed gradient descent
We will now propose a smoothed gradient descent algorithm such that all fixed-points of the algo-
rithm will also be critical points of µ,S D (p,q ).
α µ,S
→
Consider the following algorithm:
Initialize the algorithm with any Gaussian approximation q(0) of the target distribution
•
Then loop until convergence:
•
1. Compute the current hybrid approximation of the target distribution:
α
h (θ) = Z−1p(θ)1−α q(t) (θ) (70)
α α
(cid:16) (cid:17)
2. Compute the following expected values under the current hybrid approximation
h (θ):
α
µ = E [θ] (71)
hα
E = E [ ψ (θ)] (72)
hα
∇ ∇
−1
EH = (Cov ) E [ θ µ ψ (θ) ] (73)
hα hα
| − ih∇ |
10

3. Compute the new Gaussian approximation using the following formula:
1 EH
q(t+1) = exp E θ µ θ µ θ µ (74)
Z −h ∇|| − i − h − | 2 | − i
q
(cid:18) (cid:19)
where Z is a normalizing constant.
q
Any fixed-point of this iteration must obey the following equalities:
E [ ψ (θ)] = 0 (75)
h⋆
∇
−1 −1
(Cov ) E [ θ µ ψ (θ) ] = (Cov ) (76)
h⋆ hα q⋆
| − ih∇ |
which is identical to the equations obeyed by critical points of µ,S D (eqs. (55) and (69)).
α
→
C Expectation Propagation
Finally, we come to Expectation Propagation (EP).
In order to be able to apply EP, we have to further specify a factorization of the target distribution:
n
p(θ) = f (θ) (77)
i
i=1
Y
Given this factorization, we can then compute “the EP approximation of the target distribution of
p(θ) factorized as p = f ” or, for short, the EP approximation of p.
i
We will note φ (θ) = log(f (θ)).
i Q i
−
C.1 The EP iteration
All algorithms we have presented so far seek a global Gaussian approximation of the target dis-
tribution. EP differs from this by seeking to find instead n local Gaussian approximations q to
i
approximate each factor: q f .
i i
≈
These approximations are improved iteratively according to:
(0)
Initialize the algorithm with any n local Gaussian approximations q (θ)
i
•
Then loop until convergence:
•
1. Select a subset [1,n] of indices1.
I ⊂
2. For all i in parallel:
∈ I
(a) Compute the hybrid distribution:
h (θ) = Z−1 f (θ) q(t) (θ) (78)
i hi i j
j6=i
Y
(b) Compute the mean and covariance of the hybrid: (µ ,Cov )
hi hi
(c) Compute a Gaussian distribution with that mean and variance. This Gaussian is
the moment-matchedGaussian approximation of the hybrid:
1
q (θ) = Z−1 exp θ µ Cov θ µ (79)
hi qhi hi hi hi
−2 h − | | − i
(cid:18) (cid:19)
(d) Compute the new local Gaussian approximation of f (θ) given by:
i
q (θ)
q(t+1) hi
(θ) (80)
i ∝ q(t) (θ)
j6=i j
For a more extensive presentationof EP and the EP iteratioQn, we refer the interested reader to Minka
[2001], Seeger [2005], Bishop [2007].
1Several choices are possible for the selection of the subset. The two most frequent are selecting a single
indexI = {i 0} (corresponding toa sequential variant ofEP,asoriginallyproposed inMinka [2001])or thefull
rangeI = [1,n](correspondingtothemoremodernparallelvariantofEP).Minibatchorasynchronous variants
of EP are also possible. Of course, the sequence of subsets should be such that each factor-approximation q is
i
updated regularly.
11

C.2 A smoothed gradient descent
Interestingly, the key step of the EP algorithm: the computation of the new local approximation
(t+1)
q (θ) from its local target f (θ) and the current values of the other local approximations
i i
(t)
q , corresponds exactly to a smoothed gradient descent.
j
j6=i
(cid:16) (cid:17)
Theorem 1. Smoothed gradient representation of the EP iteration.
(t+1)
In the EP iteration, the new local approximation q (θ) can also be written as:
i
µ = E [θ] (81)
hi
E = E [ φ (θ)] (82)
hi i
∇ ∇
−1
EH = (Cov ) E [ θ µ φ (θ) ] (83)
hi hi i
| − ih∇ |
EH
(t+1)
q exp E θ µ θ µ θ µ (84)
i ∝ −h ∇|| − i − h − | 2 | − i
(cid:18) (cid:19)
For thoroughness, it is also important to mention that:
EH E (Hφ (θ)) (85)
hi i
≈
in the limit in which the hybrid distribution is a strongly log-concave distribution with minimum
curvature tending to + (Dehaene and Barthelmé [2016]).
∞
This theorem represents the key innovation of the present work. This alternative formulation of the
EP update might prove useful in deriving better computational variants of the EP iteration. How-
ever, we believe that this result is most important for theoretical investigations of the EP algorithm.
Indeed, it provides a link between EP and the well-understoodgradient descent algorithms. Further-
more, this result also enables users of EP to have a more intuitively satisfying presentation of how
EP operates.
Proof. This result is actually fairly simple to prove. Indeed, by the definition of q , h and q have
hi i hi
the same mean and variance: (µ ,Cov ).
hi hi
Now, note:
(t)
q (θ) = q (θ) (86)
−i j
j6=i
Y
1
exp r θ µ θ µ B θ µ (87)
−i −i
∝ −h || − i − 2 h − | | − i
(cid:18) (cid:19)
and:
1
(t+1)
q exp r θ µ θ µ B θ µ (88)
i ∝ −h i || − i − 2 h − | i | − i
(cid:18) (cid:19)
Our objective is to find a simple expression for r and B . This can be done by making use of what
i i
we call “Stein relationships” (in honor of Charles Stein and his Stein’s lemma, which corresponds
to the Gaussian case). Indeed, by integration by parts, we find that for any probability distribution
(with fast decrease in the tails):
E ( ψ (θ)) = 0 (89)
p
∇
E ( θ µ ψ (θ) ) = I (90)
p d∗d
| − ih∇ |
Applying the first Stein relationship (eq. (89)) to the hybrid h f q , we get that:
i i −i
∝
0 = E ( (logh (θ))) (91)
hi i
∇
= E ( φ (θ) + (r + B (θ µ))) (92)
hi i −i −i
∇ −
= E ( φ (θ)) + r + B (E (θ) µ) (93)
hi i −i −i hi
∇ −
= E ( φ (θ)) + r + 0 (94)
hi i −i
∇
12

Now, we apply the first Stein relationship (eq. (89)) to the moment-matched approximation of h :
i
q q q . We get:
hi i −i
∝
0 = E ( (logq (θ))) (95)
qhi hi
∇
= E ((r + B (θ µ)) + (r + B (θ µ))) (96)
qhi i i −i −i
− −
= r + r (97)
i −i
By combining eqs. (94) and (97), we get:
r = E ( φ (θ)) (98)
i hi i
∇
QED.
−1
The proof for B = (Cov ) E ( θ µ φ (θ) ) proceeds the exact same way, but by using
i hi hi i
| − ih∇ |
the second Stein relationship (eq. (90)) to h and q yielding:
i hi
I = E ( θ µ φ (θ) ) + Cov B (99)
d∗d hi i hi −i
| − ih∇ |
= Cov B + Cov B (100)
hi i hi −i
Combining these equations yields the claimed result, concluding the proof.
D Why smoothed gradient descent leads to good approximations
The Stein relationships we have just used in the preceeding proof (eqs. 89 and 90) also provide an
intuition as to why the EP and VB Gaussian approximations (as well as the D minima) provide
α
good approximations of the target distribution. Indeed, these Stein relationships read:
E ( ψ (θ)) = 0 (101)
p
∇
E ( θ E (θ) ψ (θ) ) = I (102)
p p d∗d
| − ih∇ |
A VB Gaussian approximation q (i.e: a minimum of KL(p,q)) obeys very similar relationships:
VB
E ( ψ (θ)) = 0 (103)
qVB
∇
E ( θ E (θ) ψ (θ) ) = I (104)
qVB p d∗d
| − ih∇ |
Thus, q and p have the same expected value for the functions: ψ (θ) and θ E (θ) ψ (θ)
VB p
∇ | − ih∇ |
(which corresponds to n(n + 1) scalar equalities).
Meanwhile, a EP fixed-point with hybrids h⋆ obeys:
i
E h⋆ ( φ i (θ)) = 0 (105)
i ∇
i
X
E h⋆ ( θ E p (θ) φ i (θ) ) = I d∗d (106)
i | − ih∇ |
i
X
which means that the density defined by n−1 h⋆ (where n is the number of factors/factor-
i
approximations/hybrids)has the same expected value for the two functions we are considering.
P
Using this equality (or almost equality) of these expected values, we were able last year to show
that, in the classical Bayesian large-data limit, EP and VB Gaussian approximations of a posterior
distribution are:
asymptotically valid: EP and VB both correctly estimate the mean and variance of the
•
target distribution
better than the alternative Laplace approximation: the error of the estimate of the mean is
•
an order of magnitude better for EP and VB than for Laplace
This result was, however, derived under restrictive assumption and needs to be improved
(Dehaene and Barthelmé [2015]).
13