DraftversionJune14,2018
PreprinttypesetusingLATEXstyleAASTeX6v.1.0
TANGOS: THE AGILE NUMERICAL GALAXY ORGANIZATION SYSTEM
Andrew Pontzen1 and Michael Tremmel2
1DepartmentofPhysicsandAstronomy,UniversityCollegeLondon,GowerStreet,LondonWC1E6BT,UK
2YaleCenterforAstronomy&Astrophysics,PhysicsDepartment,P.O.Box208120,NewHaven,CT06520,USA
(Dated: 21 May 2018)
8102 nuJ 31  ]MI.hp-ortsa[  2v01000.3081:viXra ABSTRACT
tangos
We present , a Python framework and web interface for database-driven analysis of numerical structure
formation simulations. To understand the role that such a tool can play, consider constructing a history for the
absolute magnitude of each galaxy within a simulation. The magnitudes must first be calculated for all halos at
all timesteps and then linked using a merger tree; folding the required information into a final analysis can entail
ff angos
significant e ort. T is a generic solution to this information organization problem, aiming to free users
from the details of data management. At the querying stage, our example of gathering properties over history
is reduced to a few clicks or a simple, single-line Python command. The framework is highly extensible; in
tangos
particular, users are expected to define their own properties which will write into the database. A variety
of parallelization options are available and the raw simulation data can be read using existing libraries such as
pynbody yt tangos
or . Finally, -based databases and analysis pipelines can easily be shared with collaborators
or the broader community to ensure reproducibility. User documentation is provided separately.
1. INTRODUCTION the raw output to scientifically-relevant quantities and organ-
ising the results. Reduction and organization can be seen as
Analyzing simulations of cosmological structure forma-
two layers within a simulation workflow (Figure 1). By sepa-
tion poses a significant computational challenge. Large num-
rating the boilerplate organization layer, we started building a
bers of raw data points must typically be reduced into scien-
tangos
generic code which would ultimately evolve into . The
tifically relevant properties or observables for each galaxy or
code takes responsibility for storing and retrieving results as
halo. Theresultingquantitiesmustthenbeinterpreted, which
well as iterating over simulations and halos to perform the
often involves further processing — for example to see how
reduction step on all relevant data. Once this separation was
a galaxy’s properties vary over time. In this paper, we intro-
tangos made, we found we were able to express science goals more
duce , a software package which aims to make such
clearly, leading to faster, higher quality analyses.
processing painless.
tangos
We have been continually using and refining since
The code has been developed over a decade, with roots in
that time. In the last three years it has been heavily stream-
work described by Pontzen et al. (2008). That research had
lined and refactored to maximize the range of requirements
to collate information about a large number of halos across a
ff it can accommodate — from traditional uniform volumes
range of di erent simulations (to piece together the way that
ffi
(leading us to include e cient parallelization, e.g. Tremmel
galaxies are seen in absorption against quasars). Two prob-
et al. 2017; Di Cintio et al. 2017) to “genetically modified”
lems became apparent. First, our cross-sections, column den-
zooms (driving development of the linking and tracking fa-
sities and other quantities were structured as a series of files
cilities; Pontzen et al. 2017). To enable open working with
with increasingly obscure names and relationships. Read-
ff collaborators, we also added a web interface which can for-
ing the results and, especially, combining di erent outputs
mulate and process even complex queries.
into a coherent analysis was slow and cumbersome. Second,
yt
In the meantime, codes such as (Turk et al. 2011) and
our large collection of scripts for performing calculations all
pynbody
(Pontzen et al. 2013) have been maturing; these li-
included similar “boilerplate” code. This boilerplate would
braries present an abstracted view of raw simulation data,
open a series of simulations, run through the halos within
aiding the reduction layer but largely leaving organization to
them, and write out results. Even the simplest alteration
yt pynbody
users. Both and contain some support for stor-
(for example, adding a new simulation) required copy-and-
ing quantities such as profiles alongside halo catalogues, but
pasting changes to multiple source files. The combination of
not for managing the results of arbitrary user analysis. An
these obstacles became a major impediment to progress.
yt ytree
ff add-on package for known as can generate and tra-
Analyses of this sort su er from simultaneously attempt-
verse merger trees but the user must manually populate the
ing to tackle two conceptually separate problems: reducing

2
(cid:31)(cid:30)(cid:29)(cid:28)(cid:29)(cid:27)(cid:26)(cid:29)(cid:25)(cid:27)(cid:28)(cid:29)(cid:24)(cid:30)(cid:23)(cid:29)(cid:22)(cid:21)(cid:26)(cid:27)(cid:28)(cid:29)(cid:24)(cid:30)(cid:20)(cid:19)(cid:18)(cid:21)(cid:17)(cid:28)(cid:29)(cid:24)(cid:30)(cid:16)(cid:15)(cid:14)(cid:27)(cid:30)(cid:29)(cid:25)(cid:27)(cid:28)(cid:29)(cid:24)(cid:30)(cid:13)(cid:21)(cid:12)(cid:26)(cid:29)(cid:17)(cid:27)(cid:28)(cid:29)(cid:24)(cid:30)
(cid:21)(cid:18)(cid:29)(cid:8)(cid:7)(cid:25)(cid:24)(cid:6)(cid:5)(cid:11)(cid:8)(cid:7)(cid:25)(cid:24)(cid:22)(cid:22)(cid:22) data for each halo (unless using quantities already calculated
(cid:4)(cid:3)(cid:9)(cid:15)(cid:23)(cid:9)(cid:29)(cid:19)(cid:24)(cid:31)(cid:20)(cid:2)(cid:1)(cid:20)(cid:19)(cid:18)(cid:15)
and stored by the halo finder, which are unlikely to be suf-
(cid:31)(cid:30)(cid:29)(cid:28)(cid:29)(cid:27)(cid:26)(cid:11)(cid:10)(cid:24)(cid:30)(cid:18)(cid:29)(cid:28)(cid:29)(cid:24)(cid:30)(cid:9)
alotools
ficient for most use cases). H (Hearin et al. 2017)
(cid:8)(cid:19)(cid:30)(cid:19)(cid:15)(cid:27)(cid:28)(cid:29)(cid:24)(cid:30)
tangos
is another existing code that addresses aspects of an orga-
nization layer: it includes sub-packages to turn halo cata-
(cid:21)(cid:20)(cid:26)(cid:19)(cid:18)(cid:23)(cid:25)(cid:24)(cid:17)(cid:20)(cid:16)(cid:15)(cid:18)(cid:15)(cid:25)(cid:24)(cid:22)(cid:22)(cid:22) (cid:14)(cid:13)(cid:12)(cid:25)(cid:24)(cid:11)(cid:10)(cid:28)(cid:12)(cid:9)(cid:29)(cid:26)(cid:25)(cid:24)(cid:22)(cid:22)(cid:22)
logues into queryable merger trees. But its user tools are fo-
cussed on constructing semi-analytic models from these trees
(cid:7)(cid:6)(cid:24)(cid:26)(cid:21)(cid:28)(cid:29)(cid:24)(cid:30) (cid:143)(cid:27)(cid:26)(cid:24)(cid:11)(cid:1)(cid:29)(cid:30)(cid:18)(cid:29)(cid:30)(cid:14)
rather than populating them with properties calculated from
the original simulation data.
tangos
Conversely, the kind of questions that currently
lends itself to answering center on hydrodynamic galaxy for-
(cid:20)(cid:27)(cid:144)(cid:11)(cid:24)(cid:21)(cid:28)(cid:141)(cid:21)(cid:28)(cid:11) mation. How do star formation rates vary over time? What
(cid:127)(cid:141)(cid:28)(cid:30)(cid:23)(cid:18)(cid:15)(cid:129) impact do mergers have on galaxy morphology? Where does
a typical quasar line metal absorber lie relative to its nearest
ff
galaxy? Why does the distribution of dark matter get a ected
(cid:3)(cid:9)(cid:19)(cid:15)(cid:2)(cid:18)(cid:19)(cid:1)(cid:29)(cid:30)(cid:19)(cid:18) by some types of feedback but not others? By enabling many
(cid:5)(cid:30)(cid:27)(cid:26)(cid:4)(cid:9)(cid:29)(cid:9)(cid:11)(cid:26)(cid:29)(cid:12)(cid:15)(cid:27)(cid:15)(cid:4)
(cid:27)(cid:30)(cid:27)(cid:26)(cid:4)(cid:9)(cid:29)(cid:9) snapshots of multiple simulations to be linked together over
ffi
time and e ciently queried, our ability to make progress in
(cid:31)(cid:30)(cid:29)(cid:28)(cid:27)(cid:26)(cid:30)(cid:25)(cid:24)(cid:30)(cid:23)(cid:25)(cid:24)(cid:22)(cid:22)(cid:22)
these areas has been enhanced.
One way to conceive of a fully-fledged organization layer
tangos
such as is from the perspective of data compression.
(cid:5)(cid:30)(cid:27)(cid:26)(cid:4)(cid:9)(cid:29)(cid:9)(cid:11) (cid:20)(cid:19)(cid:9)(cid:21)(cid:26)(cid:28)(cid:9)(cid:11)(cid:9)(cid:28)(cid:24)(cid:15)(cid:27)(cid:14)(cid:19)(cid:11)
Raw output from the simulation layer can be extremely large
(cid:27)(cid:21)(cid:28)(cid:24)(cid:22)(cid:27)(cid:28)(cid:29)(cid:24)(cid:30) (cid:27)(cid:30)(cid:18)(cid:11)(cid:24)(cid:15)(cid:14)(cid:27)(cid:30)(cid:29)(cid:25)(cid:27)(cid:28)(cid:29)(cid:24)(cid:30)
(up to hundreds of terabytes) because it contains snapshots of
the full dynamical state of the virtual universe at tens or hun-
dreds of points in cosmological time. The goal of analysis is
to move from the multi-terabyte raw output to a final, human-
(cid:20)(cid:19)(cid:18)(cid:21)(cid:17)(cid:19)(cid:18)
(cid:11)(cid:24)(cid:21)(cid:28)(cid:141)(cid:21)(cid:28)(cid:11)(cid:127)(cid:21)(cid:28)(cid:30)(cid:23)(cid:18)(cid:15)(cid:129) digestable set of information, nearly always in the form of
one or more scientific publications. To put an upper limit on
the information content of a paper, we can consider the literal
file size of the associated PDF (perhaps a few megabytes).
(cid:20)(cid:19)(cid:9)(cid:21)(cid:26)(cid:28)(cid:9)(cid:11)(cid:15)(cid:19)(cid:28)(cid:15)(cid:29)(cid:19)(cid:6)(cid:27)(cid:26)
The compression ratio in moving from the raw output to the
(cid:127)(cid:11)(cid:1)(cid:21)(cid:15)(cid:28)(cid:129)(cid:19)(cid:15)(cid:11)(cid:141)(cid:15)(cid:24)(cid:17)(cid:19)(cid:9)(cid:9)(cid:29)(cid:30)(cid:14)
tangos scientific results is therefore 106 or more. Inserting the or-
ganization layer (giving two compression steps with ratios
of order 103) off ers far greater clarity and flexibility than at-
(cid:23)(cid:17)(cid:29)(cid:19)(cid:30)(cid:28)(cid:29)(cid:1)(cid:29)(cid:17)
tempting to jump six orders of magnitude at once.
(cid:141)(cid:27)(cid:141)(cid:19)(cid:15)(cid:11)(cid:127)(cid:6)(cid:28)(cid:30)(cid:23)(cid:18)(cid:15)(cid:129)
Some major simulation collaborations have made such in-
termediate data public. Structured Query Language (SQL)
databases provided by the Millennium (Lemson & Virgo
Figure1. An overview of how cosmological galaxy formation sim-
Consortium 2006), MultiDark (Riebe et al. 2013), Eagle
ulations are constructed and analysed. First, initial conditions must
be generated with which to start the simulation. Then, the simula- (McAlpine et al. 2016) and Theoretical Astronomical Obser-
tionisexecuted. Afterthis, someformofdatareductionisnormally
vatory (Bernyk et al. 2016) groups provide good examples,
applied where the raw multi-terabyte outputs are distilled into sci-
as well as unstructured data releases with querying tools like
entifically meaningful quantities (for example, observable proper-
ties such as magnitudes and images or physical quantities such as those provided by the Illustris collaboration (Nelson et al.
masses and profiles). The fourth stage involves organising the data; 2015). However these tools are specific to particular runs and
tangos is designed to take charge of this process, building an inter-
ff
pre-determined properties; they do not o er a mechanism for
mediate dataset that is typically gigabytes or even smaller. Finally,
adding new information or generating databases from fresh
the results are retrieved in a form suitable for discussion in a scien-
tific paper, further compressing the information to a point where it simulations.
can be fully understood by a human reader; tangos presents Python angos ff
T instead aims to minimize the human e ort required
and web interfaces for this retrieval stage.
to generate and collate complex results from new simulations
of any type and scale. By providing a framework that is mod-
tangos
ularized, is extensible in multiple directions. Adding
new galaxy properties, querying techniques, parallelization
methods, data storage approaches, file formats and analysis
librariesareallpossible(andinsomecases, trivial). Thecode

| 0   | 1   |
|:----|:----|
|     |     |

|    |
|:---|
|    |

3
(cid:31)(cid:30)(cid:29)(cid:28)(cid:27)(cid:26)(cid:29)(cid:25)(cid:24)(cid:23)(cid:29)(cid:26)(cid:22) (cid:31)(cid:30)(cid:29)(cid:28)(cid:27)(cid:26)(cid:29)(cid:25)(cid:24)(cid:23)(cid:29)(cid:26)
(cid:3)(cid:11)(cid:19)(cid:11)(cid:14)(cid:11)(cid:30)(cid:29)
(cid:21)(cid:28)(cid:20)(cid:21)(cid:29)(cid:28)(cid:19)(cid:24)(cid:29)(cid:30) (cid:22)(cid:29)(cid:18)(cid:19)(cid:29)(cid:23)(cid:30)(cid:24)(cid:20)(cid:23)(cid:30)
(cid:18)(cid:17)(cid:16)(cid:24)(cid:15)(cid:14) (cid:13)(cid:30)(cid:18)(cid:17)(cid:16) (cid:13)(cid:18)(cid:12)(cid:18)(cid:17)(cid:16) (cid:11)(cid:27)(cid:20)(cid:15)(cid:19)(cid:21)(cid:14)(cid:18)(cid:17)(cid:16)
(cid:31)(cid:30)(cid:31)(cid:22)(cid:21)(cid:20)(cid:24)(cid:29)(cid:19) (cid:31)(cid:30)(cid:29)(cid:28)(cid:27)(cid:26)(cid:30) (cid:30)(cid:15) (cid:25)(cid:31)(cid:24)(cid:23)(cid:31)(cid:30) (cid:25)(cid:10)(cid:9)(cid:15)(cid:24)(cid:31)(cid:21)(cid:27)(cid:8)(cid:14)(cid:20)(cid:20)(cid:24)(cid:29)(cid:19)
(cid:18)(cid:17)(cid:16)„(cid:9)(cid:8) (cid:14)(cid:25)(cid:30)
(cid:21)(cid:14)(cid:9)(cid:22)(cid:15)(cid:24)(cid:27)(cid:29)(cid:127)‚(cid:24)(cid:29)(cid:26)(cid:24)(cid:29)(cid:19)(cid:12)(cid:7)(cid:6)ƒ(cid:4) (cid:9)(cid:24)€(cid:14)(cid:127)(cid:8)(cid:22)(cid:9)(cid:8)(cid:10)(cid:9)(cid:22)(cid:15)(cid:24)(cid:27)(cid:29)(cid:12)(cid:7)(cid:6)(cid:23)(cid:4) (cid:31)(cid:21)(cid:27)(cid:31)(cid:14)(cid:21)(cid:15)(cid:24)(cid:14)(cid:20)(cid:12)(cid:7)(cid:6)(cid:3)(cid:2)(cid:12)(cid:1)(cid:4) (cid:24)(cid:29)(cid:31)(cid:10)(cid:15)(cid:127) (cid:22)(cid:29)(cid:26)(cid:9)(cid:14)(cid:21)(cid:20)(cid:12)(cid:7)(cid:6) (cid:4) (cid:31)(cid:22)(cid:21)(cid:22)(cid:9)(cid:9)(cid:14)(cid:9)(cid:127)(cid:15)(cid:22)(cid:20)(cid:129)(cid:20)(cid:12)(cid:7)(cid:6)(cid:141)(cid:4)
(cid:2)(cid:20)(cid:27)(cid:26)(cid:22)(cid:19)(cid:14)(cid:21)(cid:22)(cid:26)(cid:25)(cid:6)(cid:5)(cid:4)(cid:25)(cid:21)(cid:20)(cid:24)(cid:30) (cid:7)(cid:19)(cid:23)(cid:27)(cid:26)(cid:18)(cid:23)(cid:22)(cid:30)(cid:26)(cid:25)(cid:15)(cid:14)(cid:30)(cid:19)(cid:28)(cid:30)(cid:26)(cid:25)(cid:22)(cid:20)(cid:25)(cid:6)(cid:5)(cid:4) (cid:31)(cid:30)(cid:29)(cid:28)(cid:27)(cid:30)(cid:26)(cid:25)(cid:15)(cid:14)(cid:23)(cid:27)(cid:22)(cid:28)(cid:22)(cid:30)(cid:26) (cid:9)(cid:28)(cid:27)(cid:24)(cid:26)(cid:25)(cid:23)(cid:27)(cid:24)(cid:25)(cid:18)(cid:20)(cid:23)(cid:24)(cid:26) (cid:12)(cid:23)(cid:19)(cid:23)(cid:18)(cid:18)(cid:30)(cid:18)(cid:28)(cid:11)(cid:30)(cid:26)
(cid:29)(cid:20)(cid:19)(cid:25)(cid:29)(cid:28)(cid:27)(cid:24)(cid:28)(cid:27)(cid:1)(cid:25)(cid:30)(cid:127)(cid:1)(cid:127)(cid:25)(cid:16)(cid:19)(cid:20)(cid:1)(cid:30)(cid:27)(cid:28)(cid:22)(cid:20)(cid:19)(cid:26) (cid:23)(cid:27)(cid:24)(cid:25)(cid:16)(cid:20)(cid:26)(cid:22)(cid:3)(cid:16)(cid:19)(cid:20)(cid:21)(cid:30)(cid:26)(cid:26)(cid:30)(cid:26)(cid:25)(cid:19)(cid:30)(cid:26)(cid:14)(cid:18)(cid:22)(cid:26) (cid:22)(cid:17)(cid:23)(cid:22)(cid:25)(cid:21)(cid:23)(cid:27)(cid:25)(cid:13)(cid:30)(cid:25)(cid:21)(cid:23)(cid:18)(cid:21)(cid:14)(cid:18)(cid:23)(cid:22)(cid:30)(cid:24) (cid:19)(cid:23)(cid:8)(cid:25)(cid:20)(cid:14)(cid:22)(cid:16)(cid:14)(cid:22)(cid:26) (cid:13)(cid:14)(cid:28)(cid:18)(cid:24)(cid:10)(cid:14)(cid:16)(cid:24)(cid:23)(cid:22)(cid:30)(cid:26)
(cid:25)(cid:22)(cid:15)(cid:31)(cid:9)(cid:27)(cid:15)(cid:9)(cid:24)(cid:28) (cid:143)(cid:14)(cid:28)(cid:12)(cid:7)(cid:6)(cid:144)(cid:157)(cid:4) (cid:8)(cid:27)(cid:21)(cid:14)(cid:12)(cid:7)(cid:6)(cid:5)(cid:4) (cid:20)(cid:8)(cid:21)(cid:24)(cid:31)(cid:15)(cid:20)
(cid:4)(cid:20)(cid:23)(cid:19)(cid:28)(cid:20)(cid:6)(cid:22)(cid:25)(cid:6)(cid:20)(cid:15)
(cid:31)(cid:30)(cid:29)(cid:28)(cid:27)(cid:30)(cid:26)(cid:25)(cid:24)(cid:23)(cid:22)(cid:23)(cid:25)(cid:21)(cid:20)(cid:27)(cid:22)(cid:23)(cid:28)(cid:27)(cid:30)(cid:19)(cid:26)
tangos (cid:30)(cid:7)(cid:14)(cid:27)(cid:21)(cid:11)(cid:10)(cid:9)(cid:11)(cid:12)(cid:29)(cid:30) (cid:31)(cid:30)(cid:21)(cid:22)(cid:25)(cid:24)(cid:26) (cid:23)(cid:27)(cid:24)(cid:25)(cid:19)(cid:30)(cid:18)(cid:23)(cid:22)(cid:28)(cid:20)(cid:27)(cid:26)(cid:17)(cid:28)(cid:16)(cid:26)
(cid:31)(cid:30)(cid:29)(cid:28)(cid:22)(cid:24)(cid:23)(cid:19)(cid:29)(cid:28)(cid:11)(cid:10)(cid:19)(cid:24)(cid:20)(cid:23)(cid:22)(cid:20)(cid:28)(cid:22)(cid:10)(cid:20)(cid:5)(cid:21)(cid:20)(cid:23)(cid:29)(cid:23)(cid:19)
(cid:21)(cid:17)(cid:19)(cid:16)(cid:20)(cid:23) (cid:31)(cid:2)(cid:1)(cid:127)(cid:22)(cid:30)(cid:16)(cid:29)(cid:6)(cid:6)
(cid:15)(cid:29)(cid:14)(cid:22)(cid:14)(cid:28)(cid:20)(cid:15)(cid:30)(cid:29)(cid:28)
(cid:13)(cid:18)(cid:24)(cid:30)(cid:19)(cid:24)(cid:23)(cid:12)(cid:22)(cid:21)(cid:11)(cid:10)(cid:9)(cid:11)(cid:12)(cid:29)(cid:30) (cid:26)(cid:21)(cid:19)(cid:28)(cid:16)(cid:22)(cid:25)(cid:20)(cid:19)(cid:25)(cid:26)(cid:17)(cid:30)(cid:18)(cid:18) (cid:20)(cid:19)(cid:25)(cid:13)(cid:23)(cid:22)(cid:21)(cid:17)(cid:25)(cid:26)(cid:129)(cid:26)(cid:22)(cid:30)(cid:141)
(cid:8)(cid:11)(cid:10)(cid:9)(cid:11)(cid:12)(cid:29)(cid:30)(cid:22)(cid:23)(cid:20)(cid:19)(cid:22)(cid:7)(cid:30)(cid:29)(cid:26)(cid:22)(cid:14)(cid:17)(cid:22)(cid:26)(cid:29)(cid:25)(cid:11)(cid:7)(cid:6)(cid:19) (cid:31)(cid:30)(cid:29)(cid:30)(cid:28)(cid:30)(cid:27)(cid:26)(cid:25)(cid:26)(cid:19)(cid:18)(cid:17)(cid:21)(cid:23)(cid:30)(cid:29)(cid:22)(cid:21)(cid:20) (cid:31)(cid:30)(cid:29)(cid:30)(cid:28)(cid:30)(cid:27)(cid:26)(cid:25)(cid:24)(cid:23)(cid:26)(cid:30)(cid:29)(cid:22)(cid:21)(cid:20)
Figure2. An overview of the internal organization of tangos and its interaction with external libraries and users. By partitioning responsibilities
between various sub-packages, tangos is made robust and flexible. Most modules are designed to be easily extensible. An overview is given in
Section 2.
is freely available from github.com/pynbody/tangos un- with raw SQL, but it is easier to use our exposed
lchemy
der an open source (BSD 3-clause) license and compatible SQLA objects or higher-level functions. To aid
with Python 2.7 and 3.5 or later. The version of the code constructing queries, especially those that traverse merger
usedtopreparethispaperis1.0.6whichispermanentlyavail- trees, we have implemented a domain-specific mini-language
pyparsing2
able from Zenodo as Pontzen & Tremmel (2018), although which is parsed using and mapped into a com-
we would always advise using the latest available version for bination of SQL and Python operations. This is imple-
new projects. mented in the live calculation module (Section 4). The
tangos
In this work we will discuss the overall structure of construction of SQL queries for merger trees and other in-
and its modular components. Section 2 off ers an overview of terrelationships between objects is delegated to the rela-
the full system, while sub-components are explored in Sec- tion finding module which is described in Section 5.
tions 3 to 10. We conclude in Section 11. One of the strengths of the system is that users can easily
define new galaxy properties to be calculated at each stored
timestep. The framework allowing this extensibility is con-
2. OVERVIEW
tained within the properties sub-package and described
angos
T is implemented as a pure Python package and orga-
in Section 6. When calculating properties, tangos ’ paral-
nized into multiple sub-packages. The relationship between
lel tasks sub-package enables parallelization via several
the various sub-packages, user code and external dependen-
strategies which are described in Section 7. We also allow
cies is presented in Figure 2. Practical documentation for
rapidly time-varying quantities such as star formation rates
using tangos can be found at http://tiny.cc/tangos.
to be stored and processed at a resolution finer than the snap-
At its core our solution consists of a storage engine im-
shot steps, via a mechanism described in Section 8.
SQLAlchemy1
plemented atop which is a SQL toolkit and
We factor out all tasks related to file loading and memory
lchemy
object relational mapper. SQLA does not constitute a
management to the input handlers module which is cov-
database in its own right, but rather presents a unified high-
ered by Section 9. By extending this module it is possible
level interface to multiple possible implementations such
to work with any analysis toolkit for the reduction layer, al-
ite y
as SQL , M SQL, MS-SQL and more. Our approach is
pynbody
though the default is .
described in Section 3 and implemented in the submodule
tangos
The final component of is its web server which en-
core.
ables databases to be explored from within a browser. The
Querying the database can in principle be accomplished
2 http://pyparsing.wikispaces.com
1 http://sqlalchemy.org

4
server, described in Section 10, does not implement any ad- nary table. Because querying is carried out through tangos
ditional functionality; it simply provides an alternative inter- itself (Section 4), the user need not be aware of any of these
face that is convenient for rapid data exploration. implementation details. Properties do not carry explicit units
although this functionality is likely to be added in future.
3. THE CORE In addition to storing properties, objects can also be linked
to one another. Entries in a halolinks table describe this re-
The core sub-package defines the layout of tangos
lationship between two objects; for example, one halo might
databases; as we describe below this structure is not directly
be a progenitor, descendant, or subhalo of the other. We will
exposed to a typical user. Our databases are relational, con-
discuss links and how they are used to generate informative
sisting of a number of tables with pointers from one to an-
science queries in Section 5, but first we consider the more
lchemy
other (Figure 3); our use of SQLA allows the user to
elementary retrieval of properties from one or more objects.
choose from a wide variety of industry-standard underlying
SQLite3
engines. By default we use which is a serverless
4. QUERIES AND CALCULATIONS
system: the database consists of a single file, so that it can
tangos
The recommended approach to querying a database
ffl
be downloaded from a cluster for o ine analysis on a laptop
is through the provided Python or web interfaces. Basic
or other device4. A number of indexes are created along-
queries can be executed through a dictionary-like syntax. For
side the tables, greatly enhancing the speed at which relevant
example:
queries may be executed at the cost of slightly increased stor-
sim = tangos.get_simulation(’my_simulation’)
age space for the resulting database.
timestep = sim[42]
Each known simulation corresponds to a single entry
halo = timestep[5]
in a simulations table, linking to multiple entries in a print(halo[’V_mag’])
timesteps table, each of which in turn link to multiple
will access the stored V magnitude of halo 5 in the 42nd out-
entries in a halos table. It is worth noting that the ha-
put of my simulation. Each line of Python code is trans-
los table can, in fact, store multiple classes of object: ha-
tangos lchemy
lated by into a SQLA query, which in turn
los, groups, tracked Lagrangian regions, or individual black
emits the correct dialect of SQL and returns the result.
holes. Each of these objects behaves similarly until the raw
This approach is acceptable for interactive exploration of
tangos
data is needed, at which point automatically loads
small amounts of data. However when larger quantities of
the appropriate portion. Because of the need to maintain
data are to be retrieved, issuing a series of multiple small
backward compatibility during development, the table is still
ffi
queries is an ine cient approach since there is substantial
known as halos but we refer to a generic entry in the table
latency associated with each round trip to the database. It is
as an object.
ff
more time-e ective to retrieve all required data in a single
We associate any number of properties with each object.
tangos ff
query. o ers multiple routes to optimizations of this
These might be quantities such as magnitudes and masses or
sort.
arrays such as histograms and images. The properties are
For example, it is possible to retrieve properties from a se-
stored using a “schemaless” system, meaning that we do not
ries of objects, such as all those in a timestep. It is equally
create additional columns for each property but rather link
possible to retrieve multiple properties from each object.
to entries in a haloproperties table (with the name again
Combining both, the query
reflecting a historical choice). Schemaless storage systems
B, V = timestep.calculate_all("B_mag","V_mag")
are popular in industrial applications (see e.g. MongoDB5 and
schemaless6). For tangos , the primary advantage is one of returns two numpy arrays with respectively the B- and V-band
simplicity in managing the database: there is never any need magnitudes of every halo in the timestep. To achieve this,
tangos
to create or drop columns. generates and executes optimized SQL consisting of
Our approach eff ectively attaches key-value pairs to each a double join from timesteps to halos and on to halo-
object; the keys are stored as a link to a separate dictio- properties.
We additionally implemented a mini-language to enable
calculation within queries. The code
3 https://www.sqlite.org
color = timestep.calculate_all("B_mag - V_mag")
4 TheUNIXtoolrsyncisparticularlysuitablebecauseSQLitewritesnew
entries to the end of existing files – rsync is efficient at then updating any resultsintheSQLjoindescribedabove, butapost-processing
local copies at minimal bandwidth cost. This enables a workflow where up- step in Python takes the column diff erence before returning
dated or new galaxy properties are remotely computed and a local database
the resulting array to the user. While this simple example
copy is kept up-to-date. For larger simulations and collaborations, however,
it may be more practical to use tangos with a client-server database system could be fully executed in SQL, the hybrid SQL–Python ap-
suchasMySQL.
proach allows for more complex expressions. Users can even
5 http://www.mongodb.com
define functions which may be used within queries (see Sec-
6 https://eng.uber.com/schemaless-part-one/ tion 6); a built-in example is the at function. The request

5
simulations halos haloproperties
id INT id INT id INT
basename VARCHAR timestep_id INT halo_id INT
redshift FLOAT data_float FLOAT
time_gyr FLOAT data_int INT
timesteps halo_type SMALLINT data_array BLOB
id INT name_id INT
simulation_id INT
extension VARCHAR
halolinks
redshift FLOAT
id INT
time_gyr FLOAT
halo_from_id INT
dictionary
halo_to_id INT
id INT weight FLOAT
text VARCHAR name_id INT
tangos
Figure3. The layout of the relational databases that tangos builds. Simulations can be associated with any number of timesteps which in turn
can be associated with any number of objects (halos, black holes, or tracker regions). The objects have properties and links associated with
them,formingthebasicelementsofascientificanalysis. Whileusersdonothavetobeawareofthisstructure,weshowitherebecauseitslayout
is substantially different from that of existing databases (e.g. Lemson & Virgo Consortium 2006; Riebe et al. 2013), reflecting the schemaless
approach described in the text.
rho = timestep.\ additionally be interested in non-temporal relationships such
calculate_all("at(Rvir/2, dm_density_profile)")
as whether a particular halo is a subhalo of another, or to
which halo a black hole is associated. As a final example,
returns the value of the dark matter density profile evalu-
it can be useful to provide a map from halos in one simu-
ated at half the virial radius for each halo. Within cal-
lation to those in another (given closely related simulations
culate all, the evaluation takes place in stages. First the
angos
based on the same initial conditions). T addresses all
user’s mini-language string is parsed and turned into an ab-
these needs by storing links between objects. Links are uni-
stract syntax tree; by inspecting this tree, we can identify
directional and come with an associated weight which deter-
Rvir and dm density profile as the underlying proper-
mines the strength of the relationship in a way to be defined
ties to be retrieved7. Next, the SQL is generated and emitted.
numpy shortly. The links are stored in an underlying table named
Finally, theappropriatePythonfunctionsarecalled: a -
halolinks. (As a reminder, the historically-chosen name
implemented divide operation followed by the interpolation
belies that links do not have to connect halos: they can point
function at which generates the final result.
from any object to any other.)
The query system allows access to linked objects’ proper-
Each connection in a merger tree corresponds to two links
ties such as those from a halo’s major progenitor n timesteps
pointing respectively forwards and backwards in time. This
earlier. One might be interested in how much each galaxy’s
= allows us to define independent weights for each direction
magnitude has changed over the last n 5 steps, which cor-
by the number of particles in common as a fraction of the
responds to the query
number in the link source. For a halo merging into a larger
dV = timestep.\
structure the forward weight will be close to 100% whereas
calculate_all("V_mag - earlier(5).V_mag")
the reverse weight will give the merger ratio. The rela-
Such calculations involve joins onto the requested properties tion finding sub-package is able to use this information
from a heterogeneous set of halos which must first be iden- to respond to queries as follows.
tified using a merger tree. This is implemented within the The sub-package assigns every halo a previous and next
relation finding sub-package, as we now describe. property such that the Python code
halo_prog = halo.previous
5. MERGER TREES AND OTHER RELATIONSHIPS
computes the major progenitor of halo in the previous
Understanding how galaxies change over time is at the
timestep. When accessed by a user, previous generates and
tangos
heart of many science analyses. This requires to store
processes a suitable joined SQL query between the halos
and query merger trees, which express the hierarchical merg-
and halolink tables. If more than one linked halo is avail-
ff
ing of structures (e.g. Kau mann & White 1993). We may
able, the link with the highest weight is selected (since other
linkspointtosmallermergingstructures). Thenextproperty
operates in a similar way.
7 User-definedfunctionscanalsodemandaccesstopropertiesthatarenot
While this is the simplest example of using links, there are
explicitly referenced in the query tree; these properties are included in the
join. SeeSection6. considerably more powerful options available when multiple

| simulations      |
|:-----------------|
| id INT           |
| basename VARCHAR |

| halos              |
|:-------------------|
| id INT             |
| timestep_id INT    |
| redshift FLOAT     |
| time_gyr FLOAT     |
| halo_type SMALLINT |

| timesteps         |
|:------------------|
| id INT            |
| simulation_id INT |
| extension VARCHAR |
| redshift FLOAT    |
| time_gyr FLOAT    |

| halolinks        |
|:-----------------|
| id INT           |
| halo_from_id INT |
| halo_to_id INT   |
| weight FLOAT     |
| name_id INT      |

| dictionary   |
|:-------------|
| id INT       |
| text VARCHAR |

6
halos or timesteps are involved. We have implemented a se-
(cid:31)(cid:30)(cid:29)(cid:28)(cid:27)(cid:26)(cid:25)(cid:28)(cid:27)(cid:24)(cid:26)(cid:23)(cid:24)(cid:22)(cid:21)(cid:30)(cid:20)(cid:28)(cid:29)(cid:23)
(cid:15)(cid:14)(cid:13)(cid:12)(cid:11)(cid:13)(cid:23)(cid:28)(cid:30)(cid:19)(cid:10)(cid:23)(cid:28)(cid:25)(cid:22)(cid:9)(cid:30)
ffi
ries of strategies that e ciently find halos in several such (cid:22)(cid:30)(cid:20)(cid:24)(cid:19)(cid:30)(cid:23)(cid:26)(cid:30)(cid:18)
scenarios. One typical use case is to collect properties along (cid:29)(cid:28)(cid:25)(cid:17)(cid:28)(cid:27)(cid:26)(cid:16)(cid:23)(cid:24)(cid:22)(cid:21)(cid:30)(cid:20)(cid:28)(cid:29)
an entire major progenitor branch. To collate the color dis-
(cid:31)(cid:30)(cid:29)(cid:28)(cid:27)(cid:29)(cid:26)(cid:25)
cussed in Section 4, we use the request
cols = halo.calculate_for_progenitors(’B_mag-V_mag’) (cid:8)(cid:7)(cid:6)(cid:13)(cid:14)(cid:11)(cid:23)(cid:9)(cid:27)(cid:26)(cid:5)(cid:29)(cid:23)(cid:4)(cid:17)(cid:24)(cid:19)(cid:23)
(cid:25)(cid:9)(cid:9)(cid:23)(cid:29)(cid:28)(cid:25)(cid:17)(cid:28)(cid:27)(cid:26)(cid:16)(cid:23)(cid:24)(cid:22)(cid:21)(cid:30)(cid:20)(cid:28)(cid:29) (cid:13)(cid:127)(cid:25)(cid:9)(cid:141)(cid:25)(cid:28)(cid:30)
which will be executed in multiple stages within the database
(cid:27)(cid:26)(cid:28)(cid:24)(cid:23)(cid:28)(cid:30)(cid:19)(cid:10)(cid:23)(cid:28)(cid:25)(cid:22)(cid:9)(cid:30)(cid:3) (cid:29)(cid:28)(cid:24)(cid:10)(cid:10)(cid:27)(cid:26)(cid:16)(cid:23)(cid:20)(cid:17)(cid:27)(cid:28)(cid:30)(cid:17)(cid:27)(cid:25)
(Figure 4), followed by final processing in Python. The
(cid:4)(cid:27)(cid:9)(cid:28)(cid:30)(cid:17)(cid:30)(cid:2)(cid:23)(cid:22)(cid:1)(cid:23)(cid:17)(cid:30)(cid:9)(cid:30)(cid:127)(cid:25)(cid:26)(cid:20)(cid:30)
approach is to create a temporary table (which in most
SQL implementations is possible without write access to the
(cid:24)(cid:28)(cid:30)(cid:23)
database) mirroring the structure of the halolinks table. It
(cid:6)(cid:13)(cid:129)(cid:13)(cid:15)(cid:11)(cid:23)(cid:2)(cid:25)(cid:28)(cid:25)(cid:23)(cid:141)(cid:29)(cid:27)(cid:26)(cid:16)
is first populated by inserting the links leading directly away (cid:14)(cid:30)(cid:28)(cid:141)(cid:17)(cid:26)(cid:23)(cid:2)(cid:25)(cid:28)(cid:25)(cid:23)(cid:28)(cid:24)(cid:23)(cid:10)(cid:1)(cid:28) (cid:24)(cid:26)€
(cid:143)(cid:144)(cid:8)(cid:7)(cid:23)(cid:4)(cid:17)(cid:24)(cid:19)(cid:23)(cid:157)(cid:29)(cid:141)(cid:22)(cid:29)(cid:30)(cid:28)(cid:23)(cid:24)(cid:4) 
from the initial objects. However only links satisfying a rel- (cid:31)(cid:14)(cid:144)‚(cid:23)(cid:28)(cid:30)(cid:19)(cid:10)(cid:23)(cid:28)(cid:25)(cid:22)(cid:9)(cid:30)
(cid:9)(cid:27)(cid:26)(cid:5)(cid:29)(cid:23)(cid:27)(cid:26)(cid:23)(cid:28)(cid:30)(cid:19)(cid:10)(cid:23)(cid:28)(cid:25)(cid:22)(cid:9)(cid:30)
evance criterion are included; for example, in the major pro-
genitorsearch, theymustpointtoanearliertimestepandhave
a weight higher than any other link to that timestep. Our im- Figure4. The algorithm used to find relations such as major progen-
ff itors in a specified timestep. The database holds links only between
plementation allows the filter to be redefined for di erent use
adjacent timesteps, but by recursively populating a SQL temporary
cases (see below). The system next evaluates a stopping cri-
table, tangos can follow these links across multiple timesteps in an
terion against the links in the table; in the case of our progen- efficient way. User-requested data from the progenitors is acquired
itor search, it simply checks whether any new objects were byajoinontothetemporarytableanddeliveredtoPythonattheend
of the recursive process.
uncovered in the most recent cycle. If so, the procedure starts
again (now searching for links from the most recently discov-
Users typically access these strategies through the live cal-
ered objects). If not, the recursion is complete.
culation mini-language. Consider the query given at the end
By design, no data is transferred from SQL to Python dur-
of Section 4:
ing the recursion since this would be needlessly slow. In-
stead, at the end of the loop, the temporary table is handed dV = timestep.\
to the live calculation module. That system prepares calculate_all("V_mag - earlier(5).V_mag")
a query against the temporary table joined to haloproper- which requests, for each halo in timestep, the diff erence
ties as described in Section 4. The resulting columns are
between the present V magnitude and the major progenitor’s
then retrieved and processed; the temporary table is dropped;
V magnitude 5 timesteps earlier. For these purposes, strategy
and the results are returned.
(iii) in the list above is applied. Use of other strategies is
The basic algorithm has been customized for a wide range
described in the documentation.
of scenarios by subclassing the base MultiHopStrategy. In
Taken together, the relation finding and
addition to the major progenitor search described so far, we live calculation modules allow tangos to execute
have implemented subclasses that search for:
queries that would be exceptionally hard to express within
native SQL and prohibitively slow to implement in pure
(i) all progenitors (rather than major progenitors) – this re-
Python. Performance of the resulting system is explored
quired us to remove the highest-weight restriction in the
ite
in Figure 5 for a SQL -backed database of a uniform
definition of relevant links;
volume simulation. Querying was undertaken on a 2013
(ii) major descendants – accomplished by reversing the Macbook Pro (Intel Core i7-4850HQ 2.3 GHz with 16GB
ite
timestep comparison; RAM) running Python 3.6.1 and SQL 3.13.0. We used a
simulation with 100 steps spaced equally in time between
(iii) the major progenitor or descendant in a particular = =
z 1 and z 0. This is unusually fine time spacing,
timestep (rather than all timesteps) – achieved by stop-
but allows us to explore the performance implications of
pingonceobjectsfromthattimesteparediscovered, and
tracking large numbers of objects over many steps.
selecting only those objects;
The panels of Figure 5 plot the same information projected
ff
along di erent axes. The two variables N and N repre-
(iv) corresponding halos – defining relevant objects as those halo step
sent the number of halos to trace and of timesteps to jump.
in another simulation at the same physical time, and
(We found that the number of properties ultimately retrieved
stopping once such an object is discovered;
from each halo is irrelevant since the time for computing pro-
(v) the most recent merger – similar to the all-progenitor genitors is always the limiting factor.) As either N or N
step halo
ffi
search, but with a stopping criteria that halts when more becomes su ciently large (exceeding 20 or 100 respectively)
than one progenitor is found in a single timestep. the scaling is approximately linear. The shallow scaling at

7
(cid:29)
(cid:28)(cid:27)(cid:26)(cid:25)
(cid:21)
(cid:31)(cid:30)(cid:30)(cid:30)
(cid:11)(cid:8)(cid:9)(cid:25)(cid:10)(cid:18)(cid:11)(cid:12)(cid:18)(cid:13)(cid:14)(cid:15)(cid:23)(cid:16)(cid:17)(cid:18)(cid:19)(cid:20)
(cid:29) (cid:2)(cid:30)(cid:30)
(cid:11)(cid:15)(cid:18)(cid:7)
(cid:31)
(cid:31)(cid:30)(cid:30)
(cid:3)(cid:30)(cid:30)
(cid:2)(cid:30)
(cid:30)(cid:22)(cid:21)
(cid:3)(cid:30)
(cid:31)
(cid:30)(cid:22)(cid:31)
(cid:31)
(cid:31) (cid:31)(cid:30) (cid:31)(cid:30)(cid:30) (cid:31)(cid:30)(cid:30)(cid:30) (cid:31) (cid:31)(cid:30) (cid:31)(cid:30)(cid:30)
tangos (cid:29) (cid:24)(cid:23)(cid:9)(cid:19)(cid:13)(cid:6)(cid:18)(cid:17)(cid:23)(cid:25)(cid:5)(cid:23)(cid:28)(cid:27)(cid:26)(cid:25)(cid:11)(cid:23)(cid:15)(cid:25)(cid:23)(cid:15)(cid:17)(cid:27)(cid:10)(cid:18) (cid:29) (cid:24)(cid:23)(cid:9)(cid:19)(cid:13)(cid:6)(cid:18)(cid:17)(cid:23)(cid:25)(cid:5)(cid:23)(cid:15)(cid:14)(cid:13)(cid:18)(cid:11)(cid:15)(cid:18)(cid:7)(cid:11)(cid:23)(cid:15)(cid:25)(cid:23)(cid:15)(cid:17)(cid:27)(cid:10)(cid:18)(cid:23)(cid:25)(cid:4)(cid:18)(cid:17)
(cid:28)(cid:27)(cid:26)(cid:25) (cid:11)(cid:15)(cid:18)(cid:7)
Figure5. Performance for querying properties of the major progenitor of N halos, N steps prior to a selected snapshot. Both panels show
halo step
the same results, cutting across the 2D (N ,N ) plane in complementary ways. The time shown is the end-to-end tangos query runtime on a
halo step
SQLite database for a uniform resolution simulation on a 2013 Macbook Pro (Intel Core i7-4850HQ 2.3 GHz with 16GB RAM). The runtimes
are insensitive to the number of properties queried since the majority of time is spent in the relation finding sub-package.
smaller N reflects the effi ciency savings to be found in min- and calculate (which computes the values of those prop-
imizing the number of SQL queries generated. Since the erties). The framework is responsible for passing raw data
N = 1, N = 1 case takes approximately 0.05 seconds to to calculate and for writing the returned value into the
step halo
= =
complete, our most ambitious N 100, N 1000 case database. Therefore property classes express only scientific
step halo
/
would take well over an hour without optimization (com- intent and do not take any responsibility for I O.
pared to 4.2 seconds with the optimizations, over a thousand- Properties may either be dependent on existing entries in
fold improvement). the database, or on the raw simulation snapshot data, or on
tangos
Bearing in mind that sees the user’s time and both. For example, a halo virial velocity can be derived from
patience as a limiting resource, this is a major enhance- an existing measurement of the virial mass but the calcula-
ment. It enables more typical queries – say with 1000 ha- tion of a dark matter density profile would likely need access
los and 20 timesteps – to complete in under two seconds. to the snapshot data. By default, any raw data provided to a
In this case, 320ms is spent on building the temporary ta- calculation includes only the particles or cells within the ob-
ble which follows 1000 halos back through the merger tree; ject under consideration. However it is possible to provide a
1200ms is spent filtering the completed temporary table and region specificationmethodtorequestaccesstoamore
gathering the requested data; and 110ms is spent on post- extended volume; one use we have made of this facility is to
processing. The first two steps (1520ms) are carried out measure inflows and outflows across the virial radius.
angos
within the database engine, while the last (110ms) is exe- T provides two routes to performing calcula-
cuted by Python. tions: through a command-line script (tangos write)
For some cosmological applications it may be useful to ad- which writes results into the database, and through the
dress a significantly larger number of halos; we can extrapo- live calculation system which calculates on-the-fly dur-
late the performance to query times of ten minutes for tracing ing a query and does not store any output (Section 4). Prop-
106 halos over 20 timesteps, although we did not explicitly erties requiring raw simulation data are only available when
test this. Improving run-times in this case would most likely using the command-line tool. As we will discuss in the next
be possible by replacing SQLite with a server-based database section, the tangos write script can be parallelized at the
engine. halo or timestep level. Because the property class contains no
/
explicit I O, the implementer does not normally have to plan
6. USER-DEFINED PROPERTIES ff
for di erent parallelization scenarios and can instead focus
Adapting tangos to a given science case requires the user on science goals.
to develop a set of properties which will be calculated for
7. PARALLELIZATION STRATEGIES
each object within the database. A new property is defined
by implementing a subclass of PropertyCalculation. At Tangos off ers a parallelization scheme, implemented
a minimum, the property author must override names (which by parallel tasks, for use when building or updating
specifies one or more names of the properties to be stored) databases. It is primarily targeted towards systems with a

|    |    |    |                                 | None   |    |    |    |    |    | (cid:29)                           | None   |    |
|    |    |    |                                 |        |    |    |    |    |    | (cid:28)(cid:27)(cid:26)(cid:25)   |        |    |
|:---|:---|:---|:--------------------------------|:-------|:---|:---|:---|:---|:---|:-----------------------------------|:-------|:---|
|    |    |    | (cid:29)                        |        |    |    |    |    |    | (cid:31)(cid:30)(cid:30)(cid:30)   |        |    |
|    |    |    | (cid:11)(cid:15)(cid:18)(cid:7) |        |    |    |    |    |    | (cid:2)(cid:30)(cid:30)            |        |    |
|    |    |    | (cid:31)(cid:30)(cid:30)        |        |    |    |    |    |    | (cid:3)(cid:30)(cid:30)            |        |    |
|    |    |    | (cid:2)(cid:30)                 |        |    |    |    |    |    |                                    |        |    |
|    |    |    | (cid:3)(cid:30)                 |        |    |    |    |    |    | (cid:31)                           |        |    |
|    |    |    | (cid:31)                        |        |    |    |    |    |    |                                    |        |    |

8
Message Passing Interface (MPI) library available, although quired8. The chief advantage of this approach compared with
it can also make use of Python’s multiprocessing module partial loading is that disk access is consolidated into a larger,
in place of MPI if necessary. sequential read. The peak memory usage of server mode is
Given that analysis typically consumes a small fraction of only slightly greater than M , and this peak only occurs on
snap
the total computing resources of a simulation, our focus in the first node. In systems with heterogeneous hardware, it is
implementing parallelization is on user convenience rather possible to assign the server process to a machine with ex-
than machine effi ciency. Nonetheless reduction of simulation panded RAM (e.g. the bigmem nodes on NASA’s Pleiades)
data to a set of properties is a near-perfectly parallel process while using regular nodes for the calculations. If the mem-
since each halo (or, potentially, timestep) can be considered ory cost of loading an entire snapshot is still prohibitive, a
independentlyofallothers. Thisindependenceallowstangos hybrid server-partial mode loads only minimal informa-
ff ff
to o er multiple parallelization options, each with di ering tion such as particle positions rather than the entire snapshot
benefits. Users select from these options at tangos write on the server. The individual worker nodes then load the rel-
runtime by specifying a load mode. evant portions of all other arrays through the partial-loading
In practice any given load mode is reliant on the input han- approach.
dler (Section 9) which is responsible for providing data as One drawback of server mode is that it can generate sig-
ffi
the parallel calculation proceeds. Here, we describe the par- nificant MPI tra c to remote nodes which continually re-
allel capabilities of the default pynbody input handler which quire new data. A final alternative, multi-server, is cur-
implements four modes. The user starts tangos write rently being planned where each node runs its own local
through mpirun which launches multiple processes; all load server process. Provided every node has M > M
machine snap
ff ff ffi
modes use the first of these as a server with di ering respon- this approach should o er greater e ciency by minimizing
ffi
sibilities as follows. network tra c.
In the default load mode (which is applied if the user In tandem with all the above, the user can implement
does not specify an alternate), the server assigns entire their own per-halo shared-memory parallelization (based on
Open cython9)
timesteps to all other processes. The cores then operate inde- threads or MP from and reduce the number of
pendently on each snapshot, running through the requested MPI processes spawned to free up physical processing cores.
ffi
calculations for relevant halos and other objects. The chief This approach to parallelization can be highly e cient but
ff
advantage of this approach is simplicity and lack of commu- will typically require e ort for the property implementer, un-
nication overheads. However, it can lead to problematically less the calculation is chiefly carried out by library routines.
pynbody
large demands on memory: the number of cores used per Luckily many built-in routines (such as smoothing
node will need to be manually reduced using an appropri- and image rendering) are already parallelized with threads.
ate invocation of mpirun if the size of a snapshot M is The optimal balance of threads and MPI processes for a par-
snap
too large (i.e. if NM > M where M is the total ticular calculation can be determined empirically if required.
snap node node
RAM available per node and N is the number of MPI pro-
cesses per node). Reducing N may anyway be desirable if 8. SUB-STEP TIME RESOLUTION
the property calculations are themselves parallelized using
In Section6, we discussed hownew properties can beasso-
threads (see below).
ciated with objects at each timestep; their variation over time
When the partial load mode is specified, the server op-
can then be inspected using the algorithms from Section 5.
pynbody
erates similarly but each individual core activates ’s
However, this ties the time resolution of stored properties
partial loading. This avoids the full simulation snapshot be-
to the simulation’s snapshot interval whereas many analyses
ing retrieved from disk, instead loading the data for a single
of galaxy formation benefit from studying more rapid vari-
halo at a time. Partial loading is a simple solution to reducing
ations. The star formation or black hole accretion rates can
memory usage, but can lead to excessive disk access (espe-
vary by orders of magnitude over even a small fraction of
cially for network file systems) as multiple processes may
a galaxy’s dynamical time. It is infeasible to store and pro-
simultaneously access data spread in near-random patterns
ffi
cess snapshots at su ciently regular intervals to capture such
across large files. It is also not advisable to load particle data
short timescales.
from custom regions (Section 6) in this way, since currently
Simulation codes can work around this problem by storing
pynbody
such requests to can only be satisfied by scanning
auxiliary data such as formation times for each star particle
the properties of all particles in the snapshot.
angos
or a black hole accretion log. T incorporates a general
The server load mode addresses these shortcomings by
ff
taking an entirely di erent approach. The server process
takes responsibility for loading an entire snapshot, and then
8 This occurs transparently from the point of view of user analysis code.
instructs the worker processes to perform calculations for in- The actual requests for data take place through pynbody’s lazy-loading
mechanism.
dividual halos or other objects. These cores respond with
a request (or possibly multiple requests) for the raw data re- 9 http://cython.org

9
(cid:21)(cid:22)(cid:31)(cid:24)(cid:14)(cid:13)(cid:12)(cid:27)
standard Python session. Both approaches are implemented
(cid:6)(cid:6)(cid:4)(cid:3) (cid:6)(cid:1)(cid:4)(cid:2) (cid:6)(cid:1)(cid:4)(cid:3) (cid:6)(cid:5)(cid:4)(cid:2) (cid:6)(cid:5)(cid:4)(cid:3) by the sub-package input handlers which by default uses
pynbody
the library to load the underlying snapshot. We have
(cid:6)(cid:7)(cid:27)(cid:12)(cid:20)(cid:31)
pynbody
(cid:15)(cid:127)(cid:31)(cid:31)(cid:24)(cid:129) been careful to isolate references to within a single
(cid:6)(cid:2)(cid:4)(cid:2)
class which is used only if required (specifically Pynbody-
(cid:19)(cid:20)(cid:14)(cid:20)(cid:24)(cid:21)(cid:30)(cid:27)(cid:20)(cid:23)(cid:28)(cid:22)(cid:21)(cid:30)(cid:31)(cid:27)(cid:28)(cid:8)(cid:20)(cid:27)(cid:30)(cid:21)(cid:9)
InputHandler10) so that the system can be fully decoupled;
for example, an alternative YtInputHandler is provided to
yt pynbody
use the library in ’s place. Users can straight-
ff
forwardly re-implement this functionality using di erent li-
(cid:6)(cid:4)(cid:2)
braries if required.
(cid:31)(cid:30)(cid:29)(cid:28)(cid:27)
In addition to loading the raw data on demand, input han-
(cid:26)(cid:27)(cid:28)(cid:25)(cid:24)(cid:23)(cid:22)(cid:21)(cid:28)(cid:27)(cid:20)
dlers take responsibility for a diverse range of operations
(cid:11)(cid:22)(cid:31)(cid:24)(cid:15)(cid:21)(cid:24)(cid:26)(cid:20) such as searching the file system for available snapshots and
(cid:10)(cid:21)
enumerating the halos and other objects within those snap-
(cid:31)(cid:30)(cid:29)(cid:28)(cid:27)
(cid:19)(cid:24)(cid:27)(cid:25)(cid:24)(cid:27)(cid:20)
(cid:21)(cid:27)(cid:24)(cid:24) shots. All these operations are therefore user-customizable.
(cid:28)(cid:21)(cid:18)(cid:24)(cid:27) Handlers are implemented by deriving a class from Han-
(cid:17)(cid:27)(cid:30)(cid:23)(cid:16)(cid:18)(cid:24)(cid:15)
dlerBase and overriding a few methods to provide the re-
quired functionality. In particular, the data returned from an
tangos
object’sloadmethodandpassedtoPropertyCalculation
Figure6. The mechanism for storing and reconstructing time series instances is simply that returned from the underlying han-
with finer-than-timestep resolution, illustrated for a star formation
dler’s load object method. A custom handler class can be
rate history. Each halo stores a small chunk of history that covers
tangos
specified when adding the simulation to a database
the time back to the previous stored step. When the star formation
rate is retrieved, tangos automatically reassembles the individual (through the tangos add script); it is then automatically
chunksintoacompletehigh-resolutionhistory. Theusercancontrol used for all future operations requiring data from that par-
whether to include only the major progenitor branch or, conversely,
ticular simulation.
sum over all branches.
Adapting an existing input handler is also straight forward;
mechanism to organize this information into time chunks, il- one can derive from an existing class (such as PynbodyIn-
lustrated in Figure 6. In our scheme, the recent history of star putHandler) and override only those functions which need
formation or accretion is stored with each halo, black hole, customization. The current version of tangos includes minor
or other object in each timestep. When the user attempts to adaptations for working with diff erent file formats; for ex-
access a time-chunked property, reassembly is automatically ample, when working with Sub Find catalogues, it is helpful
tangos
initiated: by default, finds all major progenitors of the to make distinctions between groups and halos that do not
object and retrieves a chunk from each. It then constructs a necessarily exist with other halo finders. Further information
history by gluing the chunks together (orange line, Figure 6). can be found in the user documentation.
This approach allows significant flexibility in the manner of
reassembly. For example, the user can request chunks to be 10. WEB SERVER
summed over all progenitors (black line in Figure 6) rather To enable rapid exploration of the database by users, col-
than following the major progenitor branch. laborators and the broader community, tangos includes a
From the property implementer’s perspective, using time web server built with the pyramid11 framework. Typically a
chunking is straight-forward; instead of deriving from Prop- user will launch the server application on their own machine
ertyCalculation we derive from TimeChunkedProp- and connect to localhost. As a safe default, our pyramid
ertyCalculation which implements the reassembly dis- setup will not accept connections from external machines (al-
cussed above. From a database user’s perspective, the mech- though it can be tunnelled through SSH to a remote analysis
anism is almost totally transparent because the reassembly node). If desired pyramid can be installed on a server and
process is triggered by any request for the property. Switch- made world-accessible through a single change to the con-
ing modes to obtain a summed history requires use of the figuration file.
mini-language function reassemble, which is further de- The pages served by tangos follow a natural hierarchy: the
scribed in the user documentation. front page contains a list of known simulations, with links to
subsequent pages listing timesteps and then objects. In Fig-
9. FILE HANDLING
We discussed in Section 6 how the tangos write tool
loads data from a raw simulation and provides it to users’ 10 Additionally, parallelization support is provided by the paral-
lel tasks.pynbody servermodulewhichisloadedondemand.
property calculations. In addition, a load method is associ-
ated with each object; this allows raw data to be loaded into a 11 http://trypyramid.com

10
(cid:31)(cid:30)(cid:29)(cid:28)(cid:27)(cid:26)(cid:28)(cid:25)(cid:24)(cid:23)(cid:30)(cid:28)(cid:22) (cid:21)(cid:20)(cid:19)(cid:28)(cid:18)(cid:26)(cid:24)(cid:23)(cid:30)(cid:28)(cid:22)
(cid:31)(cid:30)(cid:29)(cid:28)(cid:27)(cid:26)(cid:25)(cid:24)(cid:23)(cid:22)(cid:21)(cid:25)(cid:20)(cid:19)(cid:18)(cid:17)(cid:23) (cid:31)(cid:30)(cid:29)(cid:28)(cid:27)(cid:26)(cid:25)(cid:24)(cid:23)(cid:14)(cid:21)(cid:13)(cid:17) (cid:16)(cid:25)(cid:21)(cid:28)(cid:17)(cid:23)(cid:15)(cid:27)(cid:18)(cid:24)(cid:25)
Figure7. Two example pages from the web server. (Left) the timestep view, displaying one row per object and customizable columns which
can be added, edited or removed and accept input in the live calculation mini-language for interactive queries. (Right) the halo view, which also
contains a plots panel, here configured to show the halo merger tree. The rows are again editable, allowing for queries to be constructed and
plotted from within a browser.
ure 7 we show the latter two stages using screenshots from file, with the exception of merger trees which are returned as
a tutorial video12. The left panel shows the timestep view. JSON and rendered by the JavaScript library d314.
In addition to basic information about each halo the user
may add any number of columns using the mini-language de- 11. CONCLUSIONS
scribed in Section 4; as usual, this is parsed and executed by
tangos
We have outlined the design of , a system for gener-
the live calculation module. Here, for example, a query
ating and querying databases describing halos and other ob-
to determine whether the halo is in the high-resolution por-
jects within cosmological simulations. We argued that the
tion of a zoom simulation has been added, as well as a query
system forms a natural ‘organization layer’ within the sim-
which retrieves the dark matter density at 1.0kpc.
ulation workflow (Figure 1). Sharpening this division of re-
The right panel of Figure 7 shows the object view. It con-
sponsibilities has allowed us to carry out cleaner, more fo-
tains editable rows which correspond to the columns in the
cussed and more reproducible science analyses.
timestep view. Additionally it can be used to display a vari-
angos
T aims, above all else, to present the simplest pos-
ety of plots; in this instance an interactive graphical represen-
sible interface and so let users focus on physics. Comput-
tation of the merger tree has been generated. This is handled
ffi ff
ing e ciency is a secondary consideration. This di ers from
by the relation finding sub-package, which uses the all-
the simulation layer where the priority is typically to extract
progenitor strategy (Section 5) to trace the tree (pruned by
maximum performance from the hardware. There is a sim-
user-defined criteria such as minimum mass ratios).
ff
ple reason for this di erence: the fraction of CPU resources
Enablinginteractivityrequirespartofthewebmoduletobe
spent on the reduction and organization layers is, in our ex-
written in JavaScript and executed within the browser. When
perience, one to two orders of magnitude smaller than the
the user interacts with a page, the JavaScript code places
cost of the simulation layer. On the other hand, the fraction
asynchronous requests to Python over HTTP. The server calls
of human time devoted to the analysis is by far the largest.
tangos
the relevant functionality within and encodes the re-
tangos
Consequently regards human attention as the most
sults into JSON (JavaScript Object Notation); once the re-
constrained resource.
sults arrive back in the browser, JavaScript places them into
ff
An e ective organization layer has a much broader range
the appropriate elements within the page. Plots are gener-
of responsibilities (Figure 1) than a static database. The mod-
matplotlib13
ated using the library and returned as a PNG
tangos
ularity of allows these diverse needs — ranging from
analysis parallelization to data organization and query opti-
12 Seehttp://tiny.cc/tangos.
13 https://matplotlib.org
14 https://d3js.org

11
mization — to be satisfied by near-independent sub-packages • Queries can be executed from Python or from a web
(Figure 2). Despite this separation, the sub-packages work browser (Section 10). This opens up an agile mode
together coherently, enabling a range of benefits: of working where we perform rapid exploration of our
data within a browser, before generating final versions
• Queries are expressed in language that reflects scien-
of science plots using Python.
tific intent – but are also fast, as they are translated
into carefully optimized joins executed by industry-
standard database libraries (Sections 4 and 5). The Tangos is an ongoing project and we hope that it will ben-
ffi
resulting interface is su ciently simple that we have efit from broader involvement. While the major develop-
been able to use it with undergraduate classes, allow- ment focus has been on enabling us to effi ciently answer
ing them to undertake projects quantifying the relative questions related to galaxy formation, the modular architec-
role of mergers and smooth accretion in building the ture should enable improvement and growth in multiple di-
halo population. rections, coordinated by Github’s management tools15 and
quality-assured by Travis16 automated testing. We are keen
• We have been able to abstract away from halos to to discover whether the simulation community finds tangos
a broader class of objects in the database, including helpful and we value all forms of feedback.
black holes and tracked Lagrangian regions. Espe-
ciallyincombinationwiththelinkssystem(Section5),
ACKNOWLEDGMENTS
this allowed us to perform simultaneous analysis of the
evolution of galaxies and their black holes (e.g. Trem- We thank the anonymous referee for a very helpful report.
mel et al. 2017; Di Cintio et al. 2017) as well as dy- We are grateful for discussions with and beta testing by Lau-
namicalanalysesofstellarsubpopulationstrackedover ren Anderson, Tobias Buck, Iryna Butsky, Akaxia Cruz, Ar-
time (Pontzen et al. 2015). ianna Di Cintio, Ben Keller, Matthew Orkney, Martin Rey,
Angelo Ricarte and Ray Sharma. Arianna Di Cintio also sug-
• When building databases, users can implement analy- gested the name tangos , although AP and MT take the blame
/
sis that is small, readable and devoid of any I O. We for reverse-engineering it to an acronym. We are grateful
have found this aspect particularly useful when com- to Peter Pontzen for assistance with the tutorial video. AP
bining analyses of multiple collaborators into final sci- was funded by the Royal Society. MT was partially sup-
enceresults(e.g.Pontzenetal.2017), ataskthatwould ported by NSF award AST-1514868 and gratefully acknowl-
ff
previously involve wrangling multiple files in di erent edges support from the YCAA Prize Postdoctoral Fellow-
formats. ship. This work used the DiRAC Complexity system, oper-
ated by the University of Leicester IT Services, which forms
• Parallelization of the database-building process is sim- part of the STFC DiRAC HPC Facility (www.dirac.ac.uk).
ple to apply (no analysis code needs to be changed; This equipment is funded by BIS National E-Infrastructure
/ /
Section 7). This enabled us to scale from a package capital grant ST K000373 1 and STFC DiRAC Operations
/ /
initially focussed on zoom simulations to one capa- grant ST K0003259 1. DiRAC is part of the National E-
ble of ingesting state-of-the-art uniform volume runs Infrastructure. This work was partially enabled by funding
(Tremmel et al. 2017). from the UCL Cosmoparticle Initiative.
REFERENCES
Bernyk,M.,Croton,D.J.,Tonini,C.,etal.2016,ApJS,223,9 Pontzen,A.,Read,J.I.,Teyssier,R.,etal.2015,MNRAS,451,1366
DiCintio,A.,Tremmel,M.,Governato,F.,etal.2017,MNRAS,469,2845 Pontzen,A.,Rosˇkar,R.,Stinson,G.,&Woods,R.2013,pynbody:
N-Body/SPHanalysisforpython,AstrophysicsSourceCodeLibrary,,,
Hearin,A.P.,Campbell,D.,Tollerud,E.,etal.2017,AJ,154,190
Kauffmann,G.,&White,S.D.M.1993,MNRAS,261, ascl:1305.002
Pontzen,A.,&Tremmel,M.2018,Zenodo,doi:10.5281/zenodo.1248829
doi:10.1093/mnras/261.4.921
Pontzen,A.,Tremmel,M.,Roth,N.,etal.2017,MNRAS,465,547
Lemson,G.,&VirgoConsortium,t.2006,ArXivAstrophysicse-prints,
Pontzen,A.,Governato,F.,Pettini,M.,etal.2008,MNRAS,390,1349
astro-ph/0608019
Riebe,K.,Partl,A.M.,Enke,H.,etal.2013,AstronomischeNachrichten,
McAlpine,S.,Helly,J.C.,Schaller,M.,etal.2016,Astronomyand 334,691
Computing,15,72 Tremmel,M.,Karcher,M.,Governato,F.,etal.2017,MNRAS,470,1121
Nelson,D.,Pillepich,A.,Genel,S.,etal.2015,Astronomyand Turk,M.J.,Smith,B.D.,Oishi,J.S.,etal.2011,ApJS,192,9
Computing,13,12
15 http://github.com 16 http://travis-ci.org